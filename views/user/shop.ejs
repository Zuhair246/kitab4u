<link rel="stylesheet" href="../../styles/user/shopSidebar.css">
<%- include('../../views/partials/user/header') %>
<style>
  /* Pagination Styling */
.pagination {
  gap: 0.25rem;
}

.pagination .page-link {
  color: #6c757d;
  border: 1px solid #dee2e6;
  padding: 0.5rem 0.75rem;
  border-radius: 0.375rem;
  transition: all 0.2s ease;
}

.pagination .page-link:hover {
  background-color: #e9ecef;
  color: #495057;
  border-color: #dee2e6;
}

.pagination .page-item.active .page-link {
  background-color: #0d6efd;
  border-color: #0d6efd;
  color: white;
  font-weight: 600;
}

.pagination .page-item.disabled .page-link {
  color: #adb5bd;
  pointer-events: none;
  background-color: #fff;
  border-color: #dee2e6;
}

.pagination .page-link:focus {
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
  z-index: 3;
}

</style>

<div class="container-fluid">
  <div class="row">

<!-- Sidebar Filters -->
<aside class="col-md-3 col-lg-2 mb-4">
  <div class="card shadow-sm border-0 p-3">
    <h5 class="mb-3 border-bottom pb-2">Filters</h5>

    <form action="/shop" method="get" class="filter-form">
      <input type="hidden" name="page" value="1">
      <!-- Categories -->
      <h6 class="fw-semibold text-primary mb-2">Categories</h6>
      <div class="list-group mb-3">
        <% for (let i=0; i<category.length; i++) { %>
          <label class="list-group-item d-flex align-items-center small py-2">
            <input 
              class="form-check-input me-2" 
              type="checkbox" 
              name="category" 
              value="<%= category[i].name %>"
              <%= selectedCategory?.includes(category[i].name) ? "checked" : "" %>>
            <%= category[i].name %>
          </label>
        <% } %>
      </div>

      <!-- Price Range -->
      <h6 class="fw-semibold text-primary mb-2">Price Range</h6>
      <div class="list-group mb-3">
        <label class="list-group-item d-flex align-items-center small py-2">
          <input class="form-check-input me-2" type="radio" name="priceRange" value="100-200"
            <%= selectedPriceRange === "100-200" ? "checked" : "" %>>
          ₹100 - ₹200
        </label>
        <label class="list-group-item d-flex align-items-center small py-2">
          <input class="form-check-input me-2" type="radio" name="priceRange" value="200-400"
            <%= selectedPriceRange === "200-400" ? "checked" : "" %>>
          ₹200 - ₹400
        </label>
        <label class="list-group-item d-flex align-items-center small py-2">
          <input class="form-check-input me-2" type="radio" name="priceRange" value="400-700"
            <%= selectedPriceRange === "400-700" ? "checked" : "" %>>
          ₹400 - ₹700
        </label>
        <label class="list-group-item d-flex align-items-center small py-2">
          <input class="form-check-input me-2" type="radio" name="priceRange" value="700-1000"
            <%= selectedPriceRange === "700-1000" ? "checked" : "" %>>
          ₹700 - ₹1000
        </label>
        <label class="list-group-item d-flex align-items-center small py-2">
          <input class="form-check-input me-2" type="radio" name="priceRange" value="1000+"
            <%= selectedPriceRange === "1000+" ? "checked" : "" %>>
          Above ₹1000
        </label>
      </div>

      <!-- Buttons -->
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-sm btn-primary w-50">Apply</button>
        <a href="/shop" class="btn btn-sm btn-outline-secondary w-50">Clear</a>
      </div>
    </form>
  </div>
</aside>


    <!-- Products Listing -->
    <main class="col-md-9 col-lg-10">
      <!-- Search -->
             <div class="search-container me-3">
                <form class="d-flex" onsubmit="event.preventDefault(); performSearch();">
                    <input type="text"
                        id="productSearch"
                        name="q"
                        value="<%= typeof searchQuery !== 'undefined' ? searchQuery : '' %>" 
                        class="form-control rounded-pill me-2 px-3" 
                        placeholder="Search books..." style="max-width: 200px;">
                    
                    <!-- Search Button -->
                    <button type="button" class="btn btn-outline-primary ms-2" id="searchBtn">
                    Search
                    </button>

                    <!-- Clear Button -->
                    <button type="button" id="clearBtn"
                            class="btn btn-outline-secondary ms-2 d-none"
                            onclick="clearSearch()">
                    <i class="bi bi-x"></i> Clear
                    </button>
                </form>
                </div>

      <!-- Sort Options -->
        <div class="d-flex justify-content-end mb-3">
          <form id="sortForm" method="get" action="/shop" class="d-flex align-items-center">
            <% if (searchQuery) { %>
              <input type="hidden" name="q" value="<%= searchQuery %>">
            <% } %>
            <% if (selectedCategory && selectedCategory.length) { %>
              <% selectedCategory.forEach(cat => { %>
                <input type="hidden" name="category" value="<%= cat %>">
              <% }) %>
            <% } %>
            <% if (selectedPriceRange) { %>
              <input type="hidden" name="priceRange" value="<%= selectedPriceRange %>">
            <% } %>

            <select class="form-select w-auto" name="sort" onchange="document.getElementById('sortForm').submit()">
              <option value="" disabled <%= !sortOption ? "selected" : "" %>>Sort by</option>
              <option value="low-high" <%= sortOption === "low-high" ? "selected" : "" %>>Price: Low to High</option>
              <option value="high-low" <%= sortOption === "high-low" ? "selected" : "" %>>Price: High to Low</option>
              <option value="az" <%= sortOption === "az" ? "selected" : "" %>>Name: A - Z</option>
              <option value="za" <%= sortOption === "za" ? "selected" : "" %>>Name: Z - A</option>
            </select>
          </form>
        </div>


        <!-- Search info -->
    <% if (searchQuery) { %>
      <h5 class="mb-4">Search results for: "<%= searchQuery %>"</h5>
    <% } %>

      <!-- Product Grid -->
      <div class="row g-4">
        <% books.forEach(book => { %>
          <div class="col-lg-3 col-md-4 col-sm-6">
            <div class="card h-100 shadow-sm border-0">
              
                            <!-- Image (keep aspect 2:3 without relying on custom classes) -->
              <a class="d-block" href="/productDetails?id=<%= book._id %>" aria-label="<%= book.name %>" style="aspect-ratio: 2 / 3;">
                <img
                  src="<%= (book.images && book.images.length > 0) ? book.images[0] : '/placeholder.svg?height=600&width=400' %>"
                  alt="<%= book.name %>"
                  class="card-img-top object-fit-cover w-100 h-100"
                  style="object-fit: cover;"
                >
              </a>

              <div class="card-body d-flex flex-column">
                
                <!-- Author -->
                <h6 class="card-subtitle text-muted mb-1"><%= book.author %></h6>
                
                <!-- Title -->
                <h5 class="card-title mb-2">
                  <p class="text-dark text-decoration-none"><%= book.name %></p>
                </h5>

                <!-- Price -->
                <% const paperback = book.variants[0]; %>
                <div class="mb-2">
                  <% if (paperback && paperback.discountPercentage > 0) { %>
                    <span class="text-danger fw-bold me-2">₹<%= paperback.finalPrice %>/-</span>
                    <span class="text-muted text-decoration-line-through">₹<%= paperback.discountPrice %>/-</span>
                    <span class="badge bg-success ms-1"><%= paperback.discountPercentage %>%OFF</span>
                  <% } else if (paperback) { %>
                    <span class="fw-bold text-danger me-2">₹<%= paperback.discountPrice %>/-</span>
                    <span class=" text-decoration-line-through text-muted me-1">₹<%= paperback.originalPrice %>/-</span>
                  <% } %>
                </div>

                <!-- Rating -->
                <div class="mb-2">
                  <% const rating = Math.floor(Math.random() * 2) + 4; %>
                  <% for (let i = 1; i <= 5; i++) { %>
                    <% if (i <= rating) { %>
                      <i class="bi bi-star-fill text-warning"></i>
                    <% } else { %>
                      <i class="bi bi-star text-warning"></i>
                    <% } %>
                  <% } %>
                  <span class="small text-muted ms-1">(3.6k)</span>
                </div>

                <!-- Buttons -->
                 
                  <div class="mt-auto d-flex justify-content-between align-items-center">
                  <% if (book.inStock) { %>
                    <form action="/cart" method="post">
                      <button class="btn btn-sm btn-primary">
                        <i class="bi bi-cart-plus"></i>
                      </button>
                    </form>
                  <% } else { %>
                    <span class="badge bg-danger py-2 px-3">Out of stock</span>
                  <% } %>


                    <form action="/wishlist" method="post" class="d-inline-block">
                        <input type="hidden" name="productId" value="<%= book._id %>">
                        <input type="hidden" name="variantId" value="<%= book.variants[0]._id %>">                      
                        <button class="btn" type="submit"
                                title="<%= wishlistItems.includes(book._id.toString()) ? 'Remove from Wishlist' : 'Add to Wishlist' %>">
                          <i class="bi <%= wishlistItems.includes(book._id.toString()) ? 'bi-heart-fill' : 'bi-heart' %> fs-4 text-danger"
                            style="font-size: 1rem; width: 1rem; height: 1rem; display: inline-flex; align-items: center; justify-content: center;"></i>
                        </button>
                    </form>
                  </div>
              </div>
            </div>
          </div>
        <% }) %>
      </div>

       <!-- Pagination Section -->
        <%
          const baseQuery = new URLSearchParams();

          if (searchQuery) baseQuery.append("q", searchQuery);
          if (selectedPriceRange) baseQuery.append("priceRange", selectedPriceRange);
          if (sortOption) baseQuery.append("sort", sortOption);

          if (selectedCategory && selectedCategory.length) {
            selectedCategory.forEach(cat => baseQuery.append("category", cat));
          }
        %>

    <% if (totalPages > 1) { %>
      <nav aria-label="Page navigation" class="mt-5 fixed-pagination">
        <ul class="pagination justify-content-center">

          <!-- Previous Button -->
          <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
            <a class="page-link" 
              href="/shop?<%= baseQuery.toString() %>&page=<%= currentPage - 1 %>
                    <% if (selectedCategory && selectedCategory.length) { %>
                        <% selectedCategory.forEach(cat => { %>
                          &category=<%= encodeURIComponent(cat) %>
                        <% }) %>
                      <% } %>
                    <%= selectedPriceRange ? '&priceRange=' + encodeURIComponent(selectedPriceRange) : '' %>
                    <%= searchQuery ? '&q=' + encodeURIComponent(searchQuery) : '' %>
                    <%= sortOption ? '&sort=' + encodeURIComponent(sortOption) : '' %>">
              &laquo;
            </a>
          </li>

      <!-- Page Numbers -->
      <% for (let i = 1; i <= totalPages; i++) { %>
        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
          <a class="page-link" 
             href="/shop?<%= baseQuery.toString() %>&page=<%= i %>
                   <% if (selectedCategory && selectedCategory.length) { %>
                    <% selectedCategory.forEach(cat => { %>
                      &category=<%= encodeURIComponent(cat) %>
                    <% }) %>
                    <% } %>
                   <%= selectedPriceRange ? '&priceRange=' + encodeURIComponent(selectedPriceRange) : '' %>
                   <%= searchQuery ? '&q=' + encodeURIComponent(searchQuery) : '' %>
                   <%= sortOption ? '&sort=' + encodeURIComponent(sortOption) : '' %>">
            <%= i %>
          </a>
        </li>
      <% } %>

      <!-- Next Button -->
      <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
        <a class="page-link" 
           href="/shop?<%= baseQuery.toString() %>&page=<%= currentPage + 1 %>
                 <% if (selectedCategory && selectedCategory.length) { %>
                    <% selectedCategory.forEach(cat => { %>
                      &category=<%= encodeURIComponent(cat) %>
                    <% }) %>
                  <% } %>
                 <%= selectedPriceRange ? '&priceRange=' + encodeURIComponent(selectedPriceRange) : '' %>
                 <%= searchQuery ? '&q=' + encodeURIComponent(searchQuery) : '' %>
                 <%= sortOption ? '&sort=' + encodeURIComponent(sortOption) : '' %>">
          &raquo;
        </a>
      </li>

    </ul>
  </nav>

  <!-- Page Info -->
  <div class="text-center text-muted small mb-4 fixed-pagination-info">
    Showing <%= ((currentPage - 1) * 8) + 1 %> - <%= Math.min(currentPage * 8, totalProducts) %> of <%= totalProducts %> products
  </div>
<% } %>


    </main>
  </div>
</div>
<%- include('../../views/partials/user/footer') %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<% if (error) { %>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      Swal.fire({
        icon: "error",
        title: "Oops...",
        text: "<%= error %>",
        confirmButtonColor: "#3085d6"
      });
    });
  </script>
<% } %>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const searchInput = document.getElementById("productSearch");
  if (!searchInput) return;

  const clearBtn = document.getElementById("clearBtn");
  const searchBtn = document.getElementById("searchBtn");

  if (searchBtn) searchBtn.addEventListener("click", performSearch);

  function performSearch() {
    const q = searchInput.value.trim();
    const url = new URL(window.location.origin + "/shop");

    // preserve filters
    const params = new URLSearchParams(window.location.search);
    if (params.getAll("category").forEach(cat => {
      url.searchParams.append("category", cat);
    }));
    if (params.get("priceRange")) url.searchParams.set("priceRange", params.get("priceRange"));
    if (params.get("sort")) url.searchParams.set("sort", params.get("sort"));

    if (q) url.searchParams.set("q", q);
    url.searchParams.set("page", "1");

    window.location.href = url.toString();
  }

  function clearSearch() {
    const url = new URL(window.location.origin + "/shop");
    const params = new URLSearchParams(window.location.search);

    if (params.getAll("category").forEach(cat => {
      url.searchParams.append("category", cat);
    }));
    if (params.get("priceRange")) url.searchParams.set("priceRange", params.get("priceRange"));
    if (params.get("sort")) url.searchParams.set("sort", params.get("sort"));

    url.searchParams.set("page", "1");
    window.location.href = url.toString();
  }

  if (searchInput.value.trim()) {
    clearBtn.classList.remove("d-none");
  }

  searchInput.addEventListener("input", () => {
    clearBtn.classList.toggle("d-none", !searchInput.value.trim());
  });

  searchInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      performSearch();
    }
  });

  window.clearSearch = clearSearch;
});
</script>

