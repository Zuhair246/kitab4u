<%- include("../../views/partials/user/header") %>

<div class="container my-5">
  <div class="row">
    <!-- Sidebar (Desktop) -->
    <div class="col-md-4 d-none d-md-block">
      <%- include("../../views/partials/user/sidebar") %>
    </div>

    <!-- Sidebar Toggle Button (Mobile) -->
    <div class="d-block d-md-none mb-3">
      <button class="btn btn-outline-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas">
        <i class="bi bi-list"></i> Menu
      </button>
    </div>

    <!-- Offcanvas Sidebar (Mobile) -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas" aria-labelledby="sidebarOffcanvasLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="sidebarOffcanvasLabel">Your Account</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <%- include("../../views/partials/user/sidebar") %>
      </div>
    </div>

    <!-- Main Body -->
    <div class="col-md-8">
      <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/profile" class="text-decoration-none">Your Account</a></li>
          <li class="breadcrumb-item active" aria-current="page">Your Addresses</li>
        </ol>
      </nav>

      <h2 class="mb-4 fw-bold">Your Addresses</h2>

      <!-- Flash Messages -->
      <% if (error && error.length > 0) { %>
        <div class="alert alert-danger" role="alert">
          <% error.forEach(msg => { %><p class="mb-0"><%= msg %></p><% }) %>
        </div>
      <% } %>

      <% if (success && success.length > 0) { %>
        <div class="alert alert-success" role="alert">
          <% success.forEach(msg => { %><p class="mb-0"><%= msg %></p><% }) %>
        </div>
      <% } %>

      <div class="row g-4">

        <!-- Add Address Card -->
        <div class="col-md-6">
          <div class="card h-100 border-2 border-dashed border-secondary d-flex align-items-center justify-content-center">
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addAddressModal">
              <i class="fas fa-plus"></i> + Add New Address
            </button>
          </div>
        </div>

        <!-- Add Address Modal -->
        <%- include("../../views/partials/user/addAddressModal") %>

        <!-- Existing Addresses -->
        <% if (addresses && addresses.length > 0) { %>
          <% addresses.forEach(address => { %>
            <div class="col-md-6">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <% if (address.isDefault) { %>
                    <span class="badge bg-success text-light mb-2">Default Address</span>
                  <% } %>

                  <h6 class="fw-bold mb-2"><%= address.name %></h6>
                  <div class="text-muted mb-2">
                    <%= address.streetAddress %><br>
                    <%= address.city %>, <%= address.state %> - <%= address.pinCode %><br>
                    India
                  </div>

                  <div class="mb-2">
                    <strong>Phone:</strong> <%= address.phone %>
                    <% if (address.altPhone) { %><br><strong>Alt:</strong> <%= address.altPhone %><% } %>
                  </div>

                  <small class="text-muted d-block mb-3">Type: <%= address.addressType %></small>

                  <div class="d-flex gap-3">
                    <a href="javascript:void(0)" class="text-primary" data-bs-toggle="modal" data-bs-target="#editAddressModal-<%= address._id %>">Edit</a>
                    <span>|</span>
                    <a href="javascript:void(0)" class="text-danger" onclick="deleteAddress('<%= address._id %>', '<%= address.name %>')">Remove</a>
                  </div>
                </div>
              </div>

              <!-- Edit Modal -->
              <%- include("../../views/partials/user/editAddressModal")%>
            </div>
          <% }) %>
        <% } %>

        <% if (!addresses || addresses.length === 0) { %>
          <div class="col-12 mt-4 text-center text-muted">
            <p>You haven't added any addresses yet.</p>
          </div>
        <% } %>
      </div>

      <!-- Pagination -->
      <% if (totalPages > 1) { %>
        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-center mt-4">
            <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
              <a class="page-link" href="/profile/address?page=<%= currentPage - 1 %>">Previous</a>
            </li>
            <% for (let i = 1; i <= totalPages; i++) { %>
              <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                <a class="page-link" href="/profile/address?page=<%= i %>"><%= i %></a>
              </li>
            <% } %>
            <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
              <a class="page-link" href="/profile/address?page=<%= currentPage + 1 %>">Next</a>
            </li>
          </ul>
        </nav>
      <% } %>
    </div>
  </div>
</div>
<%- include("../../views/partials/user/footer") %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
/* ---------------- PINCODE VALIDATION ---------------- */
async function validatePincode(pin, cityInput, stateInput) {
  if (!/^\d{6}$/.test(pin)) return false;
  try {
    const res = await fetch(`https://api.postalpincode.in/pincode/${pin}`);
    const data = await res.json();
    const result = data[0];
    if (result.Status !== "Success" || !result.PostOffice?.length) {
      Swal.fire({ icon: "error", title: "Invalid Pincode", text: "Entered Pincode does not exist in India Post records." });
      return false;
    }
    const post = result.PostOffice[0];
    if (cityInput && !cityInput.value) cityInput.value = post.District;
    if (stateInput && !stateInput.value) stateInput.value = post.State;
    return true;
  } catch (err) {
    console.error("Pincode validation failed:", err);
    Swal.fire({ icon: "error", title: "Error", text: "Could not verify pincode. Please try again." });
    return false;
  }
}

/* ---------------- DELETE ADDRESS ---------------- */
function deleteAddress(id, name) {
  Swal.fire({
    title: `Delete address for "${name}"?`,
    text: "This action cannot be undone.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: "#d33",
    cancelButtonColor: "#3085d6",
    confirmButtonText: "Yes, delete it"
  }).then(result => {
    if (result.isConfirmed) {
      fetch(`/profile/address/delete`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      }).then(res => res.json()).then(data => {
        if (data.success) {
          Swal.fire("Deleted!", data.message || "Address deleted.", "success").then(() => window.location.reload());
        } else {
          Swal.fire("Error", data.message || "Failed to delete address", "error");
        }
      }).catch(() => Swal.fire("Error", "Server error", "error"));
    }
  });
}

/* ---------------- ADD / EDIT ADDRESS ---------------- */
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("form[id^='addAddressForm'], form[id^='editAddressForm']").forEach(form => {
    const pinInput = form.querySelector('input[name="pinCode"]');
    const cityInput = form.querySelector('input[name="city"]');
    const stateInput = form.querySelector('input[name="state"]');

    pinInput?.addEventListener("input", async () => {
      const pin = pinInput.value.trim();
      if (pin.length === 6) await validatePincode(pin, cityInput, stateInput);
    });

    form.addEventListener("submit", async e => {
      e.preventDefault();
      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());
      const pinValid = await validatePincode(payload.pinCode, cityInput, stateInput);
      if (!pinValid) return;

      const isEdit = form.id.startsWith("edit");
      const addressId = isEdit ? form.id.split("-")[1] : null;
      const url = isEdit ? `/profile/address/edit/${addressId}` : `/profile/address/add`;

      try {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) {
          Swal.fire({ icon: "success", title: "Success", text: data.message || (isEdit ? "Address updated!" : "Address added!") })
          .then(() => window.location.reload());
        } else {
          Swal.fire({ icon: "error", title: "Error", text: data.message || "Something went wrong." });
        }
      } catch {
        Swal.fire({ icon: "error", title: "Error", text: "Server communication failed." });
      }
    });
  });
});
</script>


