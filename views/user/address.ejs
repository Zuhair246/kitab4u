<%- include("../../views/partials/user/header") %>

<div class="container my-5">
  <div class="row">
   <!-- Sidebar (Desktop) -->
    <div class="col-md-4 d-none d-md-block">
      <%- include("../../views/partials/user/sidebar") %>
    </div>

    <!-- Sidebar Toggle Button (Mobile) -->
    <div class="d-block d-md-none mb-3">
      <button class="btn btn-outline-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas">
        <i class="bi bi-list"></i> Menu
      </button>
    </div>

    <!-- Offcanvas Sidebar (Mobile) -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas" aria-labelledby="sidebarOffcanvasLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="sidebarOffcanvasLabel">Your Account</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <%- include("../../views/partials/user/sidebar") %>
      </div>
    </div>
    
    <!-- Main Body -->
    <div class="col-md-8">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/profile" class="text-decoration-none">Your Account</a></li>
          <li class="breadcrumb-item active" aria-current="page">Your Addresses</li>
        </ol>
      </nav>

      <h2 class="mb-4 fw-bold">Your Addresses</h2>

      <!-- Flash Messages -->
      <% if (error && error.length > 0) { %>
        <div class="alert alert-danger" role="alert">
          <% error.forEach(function(msg) { %>
            <p class="mb-0"><%= msg %></p>
          <% }); %>
        </div>
      <% } %>

      <% if (success && success.length > 0) { %>
        <div class="alert alert-success" role="alert">
          <% success.forEach(function(msg) { %>
            <p class="mb-0"><%= msg %></p>
          <% }); %>
        </div>
      <% } %>

      <div class="row g-4">
        <!-- Add Address Card -->
<div class="col-md-6">
  <div class="card h-100 border-2 border-dashed border-secondary d-flex align-items-center justify-content-center">
    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addAddressModal">
      <i class="fas fa-plus"></i>+  Add New Address
    </button>
  </div>
</div>

<!-- Add Address Modal -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="addAddressForm" class="row g-3">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="addAddressLabel">Add New Address</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
<div class="modal-body">
            <!-- Name -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Name:</label>
              <input type="text" name="name" class="form-control" maxlength="15">
            </div>

            <!-- City -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">City:</label>
              <input type="text" name="city" class="form-control" maxlength="15">
            </div>

            <!-- Street Address -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Street address:</label>
              <input type="text" name="streetAddress" class="form-control" maxlength="25">
            </div>

            <!-- State -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">State:</label>
              <select name="state" id="stateSelect" class="form-select">
                <option value="Andhra Pradesh">Andhra Pradesh</option>
                <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                <option value="Assam">Assam</option>
                <option value="Bihar">Bihar</option>
                <option value="Chathisgarh">Chathisgarh</option>
                <option value="Goa">Goa</option>
                <option value="Gujarat">Gujarat</option>
                <option value="Haryana">Haryana</option>
                <option value="Himachal Pradesh">Himachal Pradesh</option>
                <option value="Jharkhand">Jharkhand</option>
                <option value="Karnataka">Karnataka</option>
                <option value="Kerala">Kerala</option>
                <option value="Maharashtra">Maharashtra</option>
                <option value="Manipur">Manipur</option>
                <option value="Meghalaya">Meghalaya</option>
                <option value="Mizoram">Mizoram</option>
                <option value="Nagaland">Nagaland</option>
                <option value="Odisha">Odisha</option>
                <option value="Punjab">Punjab</option>
                <option value="Rajasthan">Rajasthan</option>
                <option value="Sikkim">Sikkim</option>
                <option value="Tamil Nadu">Tamil Nadu</option>
                <option value="Telangana">Telangana</option>
                <option value="Tripura">Tripura</option>
                <option value="Uttar Pradesh">Uttar Pradesh</option>
                <option value="Uttatakand">Uttatakand</option>
                <option value="West Bengal">West Bengal</option>
              </select>
            </div>

            <!-- Pin Code -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Pin Code:</label>
              <input type="text" 
                          name="pinCode" 
                          class="form-control"  
                          maxlength="6" 
                          pattern="[0-9]{6}"
                          placeholder="6-digit PIN"
                          title="Pin code must be 6 digits"
                          oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,6)">
            </div>

            <!-- Phone -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Phone:</label>
              <input type="text" name="phone" class="form-control" maxlength="10" pattern="[0-9]{10}" placeholder="Mobile Number"
                                              title="Phone number must be 10 digits"
                                              oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,10)" 
                                              >
            </div>

            <!-- Alternative Phone -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Alternative Phone:</label>
              <input type="text" name="altPhone" class="form-control"  maxlength="10" 
                          placeholder="Alt. Phone"
                          pattern="[0-9]{10}"
                          title="Alternative phone must be 10 digits"
                          oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,10)">
            </div>

            <!-- Address Type -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Address Type:</label>
              <select name="addressType" class="form-select">
                <option value="Home">Home</option>
                <option value="Work">Work</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <!-- Default Address -->
            <div class="col-md-12 mt-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="isDefault">
                <label class="form-check-label">Set as default address</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Address</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

        <!-- Existing Addresses -->
        <% if (userAddress && userAddress.length > 0) { %>
          <% userAddress.forEach(function(address, index) { %>
            <div class="col-md-6">
              <div class="card h-100 shadow-sm">
                <div class="card-body">

                  <!-- Default Badge -->
                  <% if (address.isDefault) { %>
                    <div class="mb-2">
                      <span class="badge bg-success text-light">Default: <strong>Address</strong></span>
                    </div>
                  <% } %>

                  <!-- Address Details -->
                  <div class="address-details">
                    <h6 class="fw-bold mb-2"><%= address.name %></h6>
                    
                    <div class="text-muted mb-2">
                      <% if (address.landMark) { %>
                        <%= address.landMark %>,<br>
                      <% } %>
                      <%= address.streetAddress %><br>
                      <%= address.city %><br>
                      <%= address.state %> <%= address.pinCode %><br>
                      India
                    </div>

                    <div class="mb-2">
                      <strong>Phone number:</strong> <%= address.phone %>
                      <% if (address.altPhone) { %>
                        <br>Alt. Phone: <%= address.altPhone %>
                      <% } %>
                    </div>

                    <% if (address.addressType) { %>
                      <div class="mb-3">
                        <small class="text-muted">Type: <%= address.addressType %></small>
                      </div>
                    <% } %>

                  </div>

                  <!-- Action Buttons -->
                  <div class="d-flex gap-3">
                  <!-- Edit Button triggers modal -->
                  <a href="javascript:void(0)" 
                    class="text-primary text-decoration-none" 
                    data-bs-toggle="modal" 
                    data-bs-target="#editAddressModal-<%= address._id %>">
                    Edit
                  </a>
                    <span class="text-muted">|</span>
                    <a href="javascript:void(0)" class="text-danger text-decoration-none" 
                      onclick="deleteAddress('<%= address._id %>', '<%= address.name %>')">
                      Remove
                    </a>

                  </div>
                </div>
              </div>

                <!-- Edit Address Modal -->
  <div class="modal fade" id="editAddressModal-<%= address._id %>" tabindex="-1" aria-labelledby="editAddressLabel-<%= address._id %>" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="editAddressForm-<%= address._id %>" class="row g-3">
          <div class="modal-header">
            <h5 class="modal-title" id="editAddressLabel-<%= address._id %>">Edit Address</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <!-- Name -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Name:</label>
              <input type="text" name="name" class="form-control" value="<%= address.name %>" maxlength="15">
            </div>

            <!-- City -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">City:</label>
              <input type="text" name="city" class="form-control" value="<%= address.city %>" maxlength="15">
            </div>

            <!-- Street Address -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Street address:</label>
              <input type="text" name="streetAddress" class="form-control" value="<%= address.streetAddress %>" maxlength="25">
            </div>

            <!-- State -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">State:</label>
               <select name="state" id="stateSelect" class="form-select">
                <option value="<%= address.state %>"><%= address.state %></option>
                <option value="Andhra Pradesh">Andhra Pradesh</option>
                <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                <option value="Assam">Assam</option>
                <option value="Bihar">Bihar</option>
                <option value="Chathisgarh">Chathisgarh</option>
                <option value="Goa">Goa</option>
                <option value="Gujarat">Gujarat</option>
                <option value="Haryana">Haryana</option>
                <option value="Himachal Pradesh">Himachal Pradesh</option>
                <option value="Jharkhand">Jharkhand</option>
                <option value="Karnataka">Karnataka</option>
                <option value="Kerala">Kerala</option>
                <option value="Maharashtra">Maharashtra</option>
                <option value="Manipur">Manipur</option>
                <option value="Meghalaya">Meghalaya</option>
                <option value="Mizoram">Mizoram</option>
                <option value="Nagaland">Nagaland</option>
                <option value="Odisha">Odisha</option>
                <option value="Punjab">Punjab</option>
                <option value="Rajasthan">Rajasthan</option>
                <option value="Sikkim">Sikkim</option>
                <option value="Tamil Nadu">Tamil Nadu</option>
                <option value="Telangana">Telangana</option>
                <option value="Tripura">Tripura</option>
                <option value="Uttar Pradesh">Uttar Pradesh</option>
                <option value="Uttatakand">Uttatakand</option>
                <option value="West Bengal">West Bengal</option>
              </select>
            </div>

            <!-- Pin Code -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Pin Code:</label>
              <input type="text" name="pinCode" class="form-control" value="<%= address.pinCode %>" maxlength="6" pattern="[0-9]{6}" >
            </div>

            <!-- Phone -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Phone:</label>
              <input type="text" name="phone" class="form-control" value="<%= address.phone %>" maxlength="10" pattern="[0-9]{10}" >
            </div>

            <!-- Alternative Phone -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Alternative Phone:</label>
              <input type="text" name="altPhone" class="form-control" value="<%= address.altPhone %>" maxlength="10" pattern="[0-9]{10}">
            </div>

            <!-- Address Type -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Address Type:</label>
              <select name="addressType" class="form-select">
                <option value="Home" <%= address.addressType === 'Home' ? 'selected' : '' %>>Home</option>
                <option value="Work" <%= address.addressType === 'Work' ? 'selected' : '' %>>Work</option>
                <option value="Other" <%= address.addressType === 'Other' ? 'selected' : '' %>>Other</option>
              </select>
            </div>

            <!-- Default Address -->
            <div class="col-md-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="isDefault" <%= address.isDefault ? 'checked' : '' %>>
                <label class="form-check-label">Set as default address</label>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
            </div>
          <% }); %>
        <% } %>
          <!-- Pagination -->
                <% if (totalPages > 1) { %>
                  <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center mt-4">

                      <!-- Previous Button -->
                      <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                        <a class="page-link" href="/profile/address?page=<%= currentPage - 1 %>">Previous</a>
                      </li>

                      <!-- Page Numbers -->
                      <% for (let i = 1; i <= totalPages; i++) { %>
                        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                          <a class="page-link" href="/profile/address?page=<%= i %>"><%= i %></a>
                        </li>
                      <% } %>

                      <!-- Next Button -->
                      <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                        <a class="page-link" href="/profile/address?page=<%= currentPage + 1 %>">Next</a>
                      </li>

                    </ul>
                  </nav>
                <% } %>
      </div>

      <!-- No Addresses Message -->
      <% if (!userAddress || userAddress.length === 0) { %>
        <div class="col-12 mt-4">
          <div class="text-center text-muted">
            <p>You haven't added any addresses yet.</p>
          </div>
        </div>
      <% } %>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this address ? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteForm" method="POST" style="display: inline;">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function deleteAddress(id, name) {
    Swal.fire({
        title: `Delete address for "${name}"?`,
        text: "This action cannot be undone.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "Yes, delete it",
        cancelButtonText: "Cancel"
    }).then((result) => {
        if (result.isConfirmed) {
            // Create a hidden form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/profile/address/delete`;

            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'id';
            idInput.value = id;

            form.appendChild(idInput);
            document.body.appendChild(form);
            form.submit();
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
  const addAddressForm = document.getElementById('addAddressForm');
  if (addAddressForm) {
    addAddressForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      const formData = new FormData(addAddressForm);
      const payload = Object.fromEntries(formData.entries());

      try {
        const res = await fetch('/profile/address/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (data.success) {
          Swal.fire({
            icon: "success",
            title: "Success",
            text: data.message || "Address added successfully",
            confirmButtonColor: "#3085d6"
          }).then(() => {
            window.location.reload();
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: data.message || "An error occurred",
            confirmButtonColor: "#d33"
          });
        }
      } catch (err) {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Error contacting server.",
          confirmButtonColor: "#d33"
        });
      }
    });
  }
});

document.addEventListener('DOMContentLoaded', function() {
  // Handle all edit forms dynamically
  document.querySelectorAll('[id^="editAddressForm-"]').forEach(form => {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());
      const addressId = form.id.split('-')[1]; 

      try {
        const res = await fetch(`/profile/address/edit/${addressId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (data.success) {
          Swal.fire({
            icon: "success",
            title: "Updated",
            text: data.message || "Address updated successfully",
            confirmButtonColor: "#3085d6"
          }).then(() => {
            window.location.reload();
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: data.message || "Update failed",
            confirmButtonColor: "#d33"
          });
        }
      } catch (err) {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Server error",
          confirmButtonColor: "#d33"
        });
      }
    });
  });
});

</script>

<%- include("../../views/partials/user/footer") %>
