<%-include("../../views/partials/user/header") %>
<!-- Main Body for Payment Failed Page -->
<main class="flex-grow-1 py-5">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-md-8 col-lg-6 text-center">
        <!-- Empty State Card -->
        <div class="card shadow-sm border-0 p-4 p-md-5">
          <div class="card-body">
            <!-- Error Icon -->
            <div class="d-flex justify-content-center mb-3">
              <i class="bi bi-exclamation-triangle text-danger" style="font-size: 4rem;"></i>
            </div>
            <!-- Title -->
            <h1 class="h2 fw-bold text-danger mb-3">Payment Failed</h1>
            <!-- Description -->
            <p class="text-dark mb-4 lead fw-semibold">We were unable to process your payment for <br> Order: #<%= order.orderId || '12345' %>. 
              <br>Please check your payment details and try again. Don't worry, your order has been saved.</p>
            <!-- Buttons Row -->
            <div class="row g-3 justify-content-center">
              <div class="col-12 col-md-6">
                <form id="retryForm">
                  <input type="hidden" name="orderId" value="<%= order.orderId %>" id="retryOrderId">
                  <button type="submit" class="btn btn-primary w-100 fw-bold"> Retry Payment</button>
                </form>
              </div>
              <div class="col-12 col-md-6">
                <a href="/myOrders/<%= order._id || '' %>" class="btn btn-outline-secondary w-100 fw-bold">
                  View Order Details
                </a>
              </div>
            </div>
            <!-- Support Link -->
            <!-- <p class="text-muted mt-4 small">
              If the problem persists, please <a href="/support" class="text-primary">contact our support team</a>.
            </p> -->
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
<%-include("../../views/partials/user/footer")%>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("retryForm").addEventListener("submit", async (e) => {
      e.preventDefault();
    
      const orderId = document.getElementById("retryOrderId").value;
    
      const res = await fetch("/retryPayment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ orderId })
      });
    
      const data = await res.json();
    
      if (!data.success) {
        return Swal.fire("Error", data.message, "error");
      }
    
      // ðŸ”¥ REDIRECT BACK TO CHECKOUT WITH NEW RAZORPAY ORDER ID
      window.location.href =
        `/orders?retry=1&orderId=${data.orderDbId}&rzpOrder=${data.orderId}`;
    });
  })
</script>
