<link rel="stylesheet" href="../../styles/admin/productList.css">
<%-include("../../views/partials/admin/header")%>

<!-- Main Content Area for Product Management -->
<div class="col-md-10">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
        <h2>Products Management</h2>
        <div class="d-flex gap-3">
            <div class="position-relative">
                <i class="fas fa-search position-absolute" style="left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d;"></i>
                <input type="text" class="form-control" placeholder="Search here" 
                       style="padding-left: 40px; width: 300px;" id="productSearch" name="search" 
                       value="<%= search %>">
            </div>
            <button type="button" class="btn btn-outline-primary ms-2" id="searchBtn" onclick="searchProducts()">
                    Search
                </button>
            <% if (search && search.trim() !== '') { %>
                <button class="btn btn-outline-secondary" onclick="clearSearch()">
                    <i class="fas fa-times"></i> Clear
                </button>
            <% } %>
            <a href="/admin/addProducts" style="text-decoration: none;">
            <button class="btn btn-dark d-flex align-items-center gap-2" onclick="window.location.href='/admin/products/add'">
                <i class="fas fa-plus"></i> New
            </button></a>
        </div>
    </div>

    <!-- Products Table -->
    <div class="p-4">
        <div class="bg-white rounded-3 shadow-sm overflow-hidden">
            <table class="table table-hover mb-0">
                <thead class="bg-dark text-white">
                    <tr>
                        <th>Product</th>
                        <th>Author</th>
                        <th>Category</th>
                        <th>Prices</th>
                        <th>Stock</th>
                        <th>Listed</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (products && products.length > 0) { %>
                        <% products.forEach((product) => { %>
                        <tr>
                            <!-- Product Name & Image -->
                            <td class="py-3 px-4 border-0">
                                <div class="d-flex align-items-center">
                                    <img src="<%= product.images && product.images.length > 0 ? product.images[0] : '/placeholder.svg?height=50&width=40' %>" 
                                         alt="<%= product.name %>" 
                                         class="rounded me-3" 
                                         style="width: 40px; height: 50px; object-fit: cover;">
                                    <div>
                                        <span class="fw-medium d-block product-name"><%= product.name %></span>
                                        <!-- <small class="text-muted">ID: <%= product._id %></small> -->
                                    </div>
                                </div>
                            </td>

                            <!-- Author -->
                            <td>
                                 <span class="fw-medium d-block"><%= product.author %></span>
                            </td>

                            <!-- Category -->
                            <td>
                                <span class="badge bg-light text-dark px-2 py-1">
                                    <%= product.categoryId ? product.categoryId.name : "N/A" %>
                                </span>
                            </td>

                            <!-- Price (from all variants) -->
                            <td>
                                <% if (product.variants && product.variants.length > 0) { %>
                                    <div class="small">
                                        <% product.variants.forEach((v) => { %>
                                            <div><%= v.coverType %>: ₹<%= v.originalPrice %><% if (v.discountPrice && v.discountPrice < v.originalPrice) { %> <span class="text-success">(Sale: ₹<%= v.discountPrice %>)</span><% } %></div>
                                        <% }) %>
                                    </div>
                                <% } else { %>
                                    <span class="text-muted">No variants</span>
                                <% } %>
                            </td>

                            <!-- Stock (from all variants) -->
                            <td>
                                <% if (product.variants && product.variants.length > 0) { %>
                                    <div class="small">
                                        <% product.variants.forEach((v) => { %>
                                            <div><%= v.coverType %>: <span class="<%= v.stock > 10 ? 'text-success' : v.stock > 0 ? 'text-warning' : 'text-danger' %>"><%= v.stock %></span></div>
                                        <% }) %>
                                    </div>
                                <% } else { %>
                                    <span class="text-muted">No variants</span>
                                <% } %>
                            </td>

                            <!-- Listed / Unlisted -->
                            <td>
                                <% if (!product.isBlocked) { %>
                                    <span class="badge rounded-pill px-3 py-2" style="background-color: #d1f2eb; color: #00875a; font-size: 12px;">
                                        Listed
                                    </span>
                                <% } else { %>
                                    <span class="badge rounded-pill px-3 py-2" style="background-color: #ffebee; color: #d32f2f; font-size: 12px;">
                                        Unlisted
                                    </span>
                                <% } %>
                            </td>

                            <!-- Actions -->
                            <td>

                                <button class="btn btn-sm me-1" style="background-color: #e3f2fd; color: #1976d2;"
                                        onclick="window.location.href='/admin/editProduct/<%= product._id %>'" 
                                        title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                                                <% if(product.isBlocked) { %>

                                                                        <button class="btn btn-sm me-1" 
                                        style="background-color: <%= !product.isBlocked ? '#ffebee' : '#e8f5e8' %>; color: <%= !product.isBlocked ? '#d32f2f' : '#2e7d32' %>;"
                                        onclick="toggleProductListing('<%= product._id %>', <%= product.isBlocked %>)"
                                        title="<%= !product.isBlocked ? 'Unlist' : 'List' %>">
                                    <i class="fa-solid fa-arrows-rotate"></i>
                                </button>

                                    <%} else {%>

                                            <button class="btn btn-sm me-1" 
                                        style="background-color: <%= !product.isBlocked ? '#ffebee' : '#e8f5e8' %>; color: <%= !product.isBlocked ? '#d32f2f' : '#2e7d32' %>;"
                                        onclick="toggleProductListing('<%= product._id %>', <%= product.isBlocked %>)"
                                        title="<%= !product.isBlocked ? 'Unlist' : 'List' %>">
                                    <i class="fas fa-<%= !product.isBlocked ? 'eye-slash' : 'eye' %>"></i>
                                </button>

                                        <%}%>
                            
                            </td>
                        </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                <i class="fas fa-box-open fa-3x mb-3 d-block"></i>
                                <h5>No products found</h5>
                                <p>Start by adding your first product</p>
                            </td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <% if (totalPages > 1) { %>
        <div class="d-flex justify-content-between align-items-center mt-4">
            <div class="text-muted">
                Showing <%= totalProducts %> results
            </div>
            <nav aria-label="Product pagination">
                <ul class="pagination mb-0">
                    <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                        <a class="page-link" href="?page=<%= currentPage - 1 %><%= search ? '&search=' + search : '' %>">Prev</a>
                    </li>
                    <% for (let i = 1; i <= totalPages; i++) { %>
                        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                            <a class="page-link" href="?page=<%= i %><%= search ? '&search=' + search : '' %>"><%= i %></a>
                        </li>
                    <% } %>
                    <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                        <a class="page-link" href="?page=<%= currentPage + 1 %><%= search ? '&search=' + search : '' %>">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
        <% } %>
    </div>
</div>

<%-include("../../views/partials/admin/footer")%>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// Handle query params for error/success on page load
const urlParams = new URLSearchParams(window.location.search);
const errorParam = urlParams.get('error');
const successParam = urlParams.get('success');

if (errorParam) {
    Swal.fire({
        icon: 'error',
        title: 'Error',
        text: decodeURIComponent(errorParam)
    });
}

if (successParam) {
    Swal.fire({
        icon: 'success',
        title: 'Success',
        text: decodeURIComponent(successParam)
    });
}

function clearSearch() {
    window.location.href = '/admin/listProducts';
}

function searchProducts() {
    const searchValue = document.getElementById('productSearch').value;
    if (searchValue.trim() !== '') {
        window.location.href = `/admin/listProducts?search=${encodeURIComponent(searchValue)}`;
    }
}

document.getElementById('productSearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchProducts();
    }
});

function toggleProductListing(id, isBlocked) {
    const actionText = isBlocked ? 'list' : 'unlist';
    Swal.fire({
        title: 'Are you sure?',
        text: `You are about to ${actionText} this product.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('/admin/deleteProduct', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id })
            }).then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    Swal.fire('Error', 'Failed to toggle product listing.', 'error');
                }
            }).catch(error => {
                console.error('Toggle error:', error);
                Swal.fire('Error', 'An error occurred.', 'error');
            });
        }
    });
}
</script>