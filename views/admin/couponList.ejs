<%- include("../../views/partials/admin/header") %>

<!-- Main Content Area for Coupon Management -->
<div class="col-md-10">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
    <h2>Coupon Management</h2>
    <div class="d-flex gap-3 align-items-center">
      <div class="position-relative">
        <i class="fas fa-search position-absolute" style="left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d;"></i>
        <input type="text" class="form-control" placeholder="Search coupons..." style="padding-left: 40px; width: 300px;" id="couponSearch" name="search" maxlength="20" value="<%= typeof search !== 'undefined' ? search : '' %>">
      </div>
      <button class="btn btn-outline-primary" id="searchBtn">Search</button>
      <% if (typeof search !== 'undefined' && search.trim() !== '') { %>
        <button class="btn btn-outline-secondary" onclick="clearSearch()"><i class="fas fa-times"></i> Clear</button>
      <% } %>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCouponModal"><i class="fas fa-plus"></i> Add Coupon</button>
    </div>
  </div>

  <!-- Table -->
  <div class="p-4">
    <div class="bg-white rounded-3 shadow-sm overflow-hidden">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="bg-light">
            <tr>
              <th class="border-0 py-3 px-4 fw-semibold text-muted">Name</th>
              <th class="border-0 py-3 px-4 fw-semibold text-muted">Code</th>
              <th class="border-0 py-3 px-4 fw-semibold text-muted d-none d-md-table-cell">Type</th>
              <th class="border-0 py-3 px-4 fw-semibold text-muted d-none d-lg-table-cell">Value</th>
              <th class="border-0 py-3 px-4 fw-semibold text-muted">Status</th>
              <th class="border-0 py-3 px-4 fw-semibold text-muted d-none d-xxl-table-cell">Expiry</th>
              <th class="border-0 py-3 px-4 fw-semibold text-muted text-end">Action</th>
            </tr>
          </thead>
          <tbody>
            <% if (coupons && coupons.length > 0) { %>
              <% coupons.forEach(c => { %>
              <tr>
                <td class="py-3 px-4 border-0 fw-bold"><%= c.name %></td>
                <td class="py-3 px-4 border-0 fw-bold"><%= c.code %></td>
                <td class="py-3 px-4 border-0 text-muted d-none d-md-table-cell"><%= c.discountType %></td>
                <td class="py-3 px-4 border-0 text-muted d-none d-lg-table-cell">
                  <% if (c.discountType === 'percentage') { %>
                    <%= c.discountValue %>%
                  <% } else if (c.discountType === 'flat') { %>
                    ₹ <%= c.discountValue %>
                  <% } else { %>
                    <%= c.discountValue %>
                  <% } %>
                </td>
                <td class="py-3 px-4 border-0">
                  <% if (c.isActive) { %>
                    <span class="badge rounded-pill px-3 py-2" style="background-color:#d1f2eb;color:#00875a;font-size:12px;">Active</span>
                  <% } else { %>
                    <span class="badge rounded-pill px-3 py-2" style="background-color:#ffebee;color:#d32f2f;font-size:12px;">Inactive</span>
                  <% } %>
                </td>
                <td class="py-3 px-4 border-0 text-muted d-none d-xxl-table-cell"><%= c.expiryDate ? c.expiryDate.toISOString().slice(0,10) : '—' %></td>
                <td class="py-3 px-4 border-0 text-end">
                  <button class="btn btn-sm me-2 d-inline-flex align-items-center justify-content-center" style="width:35px;height:35px;background-color:#e3f2fd;color:#1976d2;border:none;border-radius:8px;"
                    onclick="openEditModal('<%= c._id %>', '<%= c.name %>', '<%= c.code %>', '<%= c.discountType %>', '<%= c.discountValue %>', '<%= c.minPrice %>', '<%= c.maxDiscAmount %>', '<%= c.expiryDate ? c.expiryDate.toISOString().slice(0,10) : '' %>', '<%= c.isActive ? 'active' : 'inactive' %>', )">
                    <i class="fas fa-edit"></i>
                  </button>
                  <% if (c.isActive === true) { %>
                    <button class="btn btn-sm d-inline-flex align-items-center justify-content-center"
                      style="width:35px;height:35px;background-color:#ffebee;color:#d32f2f;border:none;border-radius:8px;"
                      onclick="deleteCoupon('<%= c._id %>', '<%= c.code %>')" title="Deactivate Coupon">
                      <i class="fas fa-trash"></i>
                    </button>
                  <% } else { %>
                    <button class="btn btn-sm d-inline-flex align-items-center justify-content-center"
                      style="width:35px;height:35px;background-color:#e9ffe9;color:#20b20d;border:none;border-radius:8px;"
                      onclick="activateCoupon('<%= c._id %>', '<%= c.code %>')" title="Activate Coupon">
                      <i class="fas fa-sync"></i>
                    </button>
                  <% } %>
                </td>
              </tr>
              <% }) %>
            <% } else { %>
              <tr>
                <td colspan="6" class="text-center py-5 text-muted">
                  <i class="fas fa-ticket-alt fa-3x mb-3 d-block"></i>
                  <h5>No coupons found</h5>
                  <p>Add your first coupon to get started.</p>
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    <nav aria-label="Page navigation" class="mt-3">
      <ul class="pagination justify-content-center">
        <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
          <a class="page-link" href="/admin/coupons?page=<%= currentPage - 1 %><%= search ? '&search=' + encodeURIComponent(search) : '' %>">Previous</a>
        </li>

        <% for (let i = 1; i <= totalPages; i++) { %>
          <li class="page-item <%= currentPage === i ? 'active' : '' %>">
            <a class="page-link" href="/admin/coupons?page=<%= i %><%= search ? '&search=' + encodeURIComponent(search) : '' %>"><%= i %></a>
          </li>
        <% } %>

        <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
          <a class="page-link" href="/admin/coupons?page=<%= currentPage + 1 %><%= search ? '&search=' + encodeURIComponent(search) : '' %>">Next</a>
        </li>
      </ul>
    </nav>
  </div>
</div>

<!-- Add Coupon Modal -->
<div class="modal fade" id="addCouponModal" tabindex="-1" aria-labelledby="addCouponModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="addCouponForm" action="/admin/coupons/add" method="POST" class="modal-content needs-validation">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="addCouponModalLabel">Add New Coupon</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
            <!-- Coupon Name -->
            <div class="mb-3">
                <label for="couponName" class="form-label">Coupon Name:</label>
                <input type="text" class="form-control" id="couponName" name="name" maxlength="30" >
            </div>

            <!-- Coupon Code -->
            <div class="mb-3">
                <label for="couponCode" class="form-label">Coupon Code:</label>
                <input type="text" class="form-control" id="couponCode" name="code" maxlength="20" >
            </div>

            <!-- Discount Type -->
            <div class="mb-3">
                <label for="discountType" class="form-label">Discount Type:</label>
                <select class="form-select" id="discountType" name="discountType" >
                <option value="percentage">Percentage Discount</option>
                <option value="flat">Flat Price</option>
                </select>
            </div>

            <!-- Discount Value -->
            <div class="mb-3">
                <label for="discountValue" class="form-label">Discount Value:</label>
                <input type="number" step="0.01"  class="form-control" id="discountValue" name="discountValue" max="100">
                <div class="form-text">Enter % for Percentage or amount for Fixed type.</div>
            </div>

            <!-- Minimum Price -->
            <div class="mb-3">
                <label for="minPrice" class="form-label">Minimum Order Value:</label>
                <input type="number" step="0.01"  class="form-control" id="minPrice" name="minPrice" maxlength="3">
                <div class="form-text">Optional: Minimum order value required to apply coupon.</div>
            </div>

            <!-- Maximum Discount Amount -->
            <div class="mb-3">
                <label for="maxDiscAmount" class="form-label">Maximum Discount Amount:</label>
                <input type="number" step="0.01"  class="form-control" id="maxDiscAmount" name="maxDiscAmount" maxlength="3">
                <div class="form-text">Optional: Set a cap for percentage discounts.</div>
            </div>

            <!-- Expiry Date -->
            <div class="mb-3">
                <label for="expiryDate" class="form-label">Expiry Date:</label>
                <input type="date" class="form-control" id="expiryDate" name="expiryDate" >
            </div>

            <p class="text-info text-center">
                Verify all details before adding.<br>
                <strong>Note:</strong> Coupon code must be unique.
            </p>
            </div>


      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Add Coupon</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Coupon Modal -->
<div class="modal fade" id="editCouponModal" tabindex="-1" aria-labelledby="editCouponModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editCouponForm" action="/admin/coupons/edit" method="POST" class="modal-content">
      <input type="hidden" name="id" id="editCouponId">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="editCouponModalLabel">Edit Coupon</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">

        <div class="mb-3">
          <label for="editCouponName" class="form-label">Coupon Name:</label>
          <input type="text" class="form-control" id="editCouponName" name="name" readonly>
          <small class="form-text text-muted">Coupon name cannot be changed.</small>
        </div>
        
        <div class="mb-3">
          <label for="editCouponCode" class="form-label">Code:</label>
          <input type="text" class="form-control" id="editCouponCode" name="code" readonly>
          <small class="form-text text-muted">Coupon code cannot be changed.</small>
        </div>

        <div class="mb-3">
          <label for="editDiscountType" class="form-label">Discount Type:</label>
          <select class="form-select" id="editDiscountType" name="discountType" >
            <option value="percentage">Percentage</option>
            <option value="flat">Flat Price</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="editDiscountValue" class="form-label">Discount Value:</label>
          <input type="number" step="0.01" class="form-control" id="editDiscountValue" name="discountValue" maxlength="2">
        </div>

        <div class="mb-3">
          <label for="editMinPrice" class="form-label">Minimum Order Value:</label>
          <input type="number" step="0.01" class="form-control" id="editMinPrice" name="minPrice" maxlength="3">
        </div>        

        <div class="mb-3">
          <label for="editMaxDiscAmount" class="form-label">Maximum Discount Amount:</label>
          <input type="number" step="0.01" class="form-control" id="editMaxDiscAmount" name="maxDiscAmount" maxlength="3">
        </div>            

        <div class="mb-3">
          <label for="editCouponExpiry" class="form-label">Expiry Date:</label>
          <input type="date" class="form-control" id="editCouponExpiry" name="expiryDate">
        </div>

        <div class="mb-3">
          <label for="editCouponStatus" class="form-label">Status</label>
          <select class="form-select" id="editCouponStatus" name="status">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Update Coupon</button>
      </div>
    </form>
  </div>
</div>

<%- include("../../views/partials/admin/footer") %>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// Search
document.getElementById('searchBtn').addEventListener('click', performSearch);
function performSearch() {
  const term = document.getElementById('couponSearch').value;
  const url = new URL(window.location);
  if (term.trim()) url.searchParams.set('search', term);
  else url.searchParams.delete('search');
  url.searchParams.set('page', '1');
  window.location.href = url.toString();
}
function clearSearch() {
  const url = new URL(window.location);
  url.searchParams.delete('search');
  url.searchParams.set('page', '1');
  window.location.href = url.toString();
}

// Edit modal opener
function openEditModal(id, name, code, discountType, discountValue, minPrice, maxDiscAmount, expiryDate, status ) {
  document.getElementById('editCouponId').value = id;
  document.getElementById('editCouponName').value = name; 
  document.getElementById('editCouponCode').value = code;
  document.getElementById('editDiscountType').value = discountType;
  document.getElementById('editDiscountValue').value = discountValue || '';
  document.getElementById('editMinPrice').value = minPrice || '';
  document.getElementById('editMaxDiscAmount').value = maxDiscAmount || '';
  document.getElementById('editCouponExpiry').value = expiryDate || '';
  document.getElementById('editCouponStatus').value = status === 'active' ? 'active' : 'inactive';

  const editModal = new bootstrap.Modal(document.getElementById('editCouponModal'));
  editModal.show();
}

// Deactivate with Swal and POST
function deleteCoupon(id, code) {
  Swal.fire({
    title: `Deactivate coupon "${code}"?`,
    text: "Users won't be able to use this coupon.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: "#d33",
    cancelButtonColor: "#3085d6",
    confirmButtonText: "Yes, deactivate it!",
    cancelButtonText: "Cancel"
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/admin/coupons/delete/${id}`, {
        method: "POST",
        headers: {"Content-Type" : 'application/json'}
      })
      .then(res => res.json())
      .then(data => {
        if(data.success) {
          Swal.fire({
            icon: "success",
            title: "Coupon Deactivated!",
            text: data.message
          }).then(()=> {
            location.reload();
          })
        }else {
          Swal.fire({
            icon: "error",
            title: "Failed",
            text: data.message || "Something wenr wrong!"
          })
        }
      })
      .catch(()=> {
        Swal.fire({
          icon: 'error',
          title: "Server Error",
          text: "Please try again later"
        })
      })
    }
  });
}

// Activate with Swal and POST
function activateCoupon(id, code) {
  Swal.fire({
    title: `Activate coupon "${code}"?`,
    text: "Users will be able to use this coupon.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: "#20b20d",
    cancelButtonColor: "#3085d6",
    confirmButtonText: "Yes, Activate it!",
    cancelButtonText: "Cancel"
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/admin/coupons/activate/${id}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"}
      })
      .then(res => res.json())
      .then(data => {
        if(data.success) {
          Swal.fire({
            icon: "success",
            title: "Coupon Activated",
            text: data.message
          }).then(()=> {
            location.reload();
          });
        }else{
          Swal.fire({
            icon: 'error',
            title: "Failed!",
            text: data.message || "Something went wrong."
          })
        }
      })
      .catch(()=> {
        Swal.fire({
          icon: 'error',
          title: "Server Error",
          text: "Please try again later"
        })
      })
    }
  });
}

// Show success/error from query params
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const success = urlParams.get('success');
  const error = urlParams.get('error');

  if (success) {
    Swal.fire({ icon: 'success', title: 'Success', text: success, confirmButtonColor: '#3085d6' })
      .then(() => { window.history.replaceState({}, document.title, window.location.pathname + window.location.search.replace(/([?&])success=[^&]*(&|$)/, '$1').replace(/[?&]$/, '')); });
  }
  if (error) {
    Swal.fire({ icon: 'error', title: 'Error', text: error, confirmButtonColor: '#d33' })
      .then(() => { window.history.replaceState({}, document.title, window.location.pathname + window.location.search.replace(/([?&])error=[^&]*(&|$)/, '$1').replace(/[?&]$/, '')); });
  }
});

// // Bootstrap native form validation for add modal
// (function() {
//   'use strict'
//   var forms = document.querySelectorAll('.needs-validation')
//   Array.prototype.slice.call(forms).forEach(function(form) {
//     form.addEventListener('submit', function(event) {
//       if (!form.checkValidity()) { event.preventDefault(); event.stopPropagation(); }
//       form.classList.add('was-validated');
//     }, false)
//   })
// })();

document.getElementById("addCouponModal").addEventListener("show.bs.modal", () => {
    const form = document.querySelector("#addCouponModal form");
    form.reset();
});

// ADD COUPON WITH AJAX + SWEETALERT
document.getElementById("addCouponForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const form = e.target;
  if (!form.checkValidity()) {
    form.classList.add("was-validated");
    return;
  }

  const formData = Object.fromEntries(new FormData(form).entries());

  try {
    const res = await fetch("/admin/coupons/add", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(formData)
    });

    const data = await res.json();

    if (data.success) {
      Swal.fire({
        icon: "success",
        title: "Success",
        text: data.message
      }).then(() => {
        form.reset();
        form.classList.remove("was-validated");
        bootstrap.Modal.getInstance(document.getElementById("addCouponModal")).hide();
        location.reload(); 
      });
    } else {
      Swal.fire({ icon: "error", title: "Error", text: data.message });
    }

  } catch (err) {
    Swal.fire({ icon: "error", title: "Error", text: "Something went wrong!" });
  }
});

// EDIT COUPON AJAX + SWEETALERT
document.getElementById("editCouponForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const form = e.target;
  const formData = Object.fromEntries(new FormData(form).entries());
  const id = document.getElementById("editCouponId").value;

  try {
    const res = await fetch(`/admin/coupons/edit/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(formData)
    });

    const data = await res.json();

    if (data.success) {
      Swal.fire({
        icon: "success",
        title: "Success",
        text: data.message
      }).then(() => {
        bootstrap.Modal.getInstance(document.getElementById("editCouponModal")).hide();
        location.reload();
      });
    } else {
      Swal.fire({ icon: "error", title: "Error", text: data.message });
    }

  } catch (err) {
    Swal.fire({ icon: "error", title: "Error", text: "Something went wrong!" });
  }
});


</script>
