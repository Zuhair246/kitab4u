<%- include("../../views/partials/user/header") %>
<link rel="stylesheet" href="../../styles/user/checkout.css">
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

<div class="container py-5">
 <form id="checkoutForm" action="/orders" method="post">
  <div class="row justify-content-center">
    
    <!-- Address Selection (Right) -->
    <div class="col-lg-7 mb-4 order-lg-1">
      <div class="bg-white p-4 rounded shadow-sm">
        <h4 class="mb-4"> Select Delivery Address:</h4>
        
        <div class="mb-3">
          <% if(addresses && addresses.length > 0) { %>
            <% addresses.forEach((address, index) => { %>
              <div class="border rounded p-3 mb-3 position-relative" 
                   style="border-width:2px; border-color:#edc2ba; border-style:solid;">
                <div>
                  <input type="radio" name="selectedAddressId" 
                         value="<%= address._id %>" 
                         <%= index === 0 ? "checked" : "" %>
                         onchange="updateSelectedAddress('<%= address._id %>')" />
                  <strong><%= address.name %></strong><br>
                  <%= address.phone %><br>
                  <%= address.streetAddress %><br>
                  <%= address.city %>, <%= address.state %> - <%= address.pinCode %>
                </div>
                <span class="badge bg-secondary position-absolute top-0 end-0 mt-2 me-2">
                  <%= address.addressType %>
                </span>
                <button type="button" 
                        class="btn btn-sm btn-dark position-absolute top-0 end-0 mt-2 me-2" 
                        style="transform:translateY(1.8rem);" 
                        data-bs-toggle="modal"
                        data-bs-target="#editAddressModal-<%=address._id %>">Edit</button>
              </div>
            <% }); %>
          <% } else { %>
            <p>No saved addresses. Please add one.</p>
          <% } %>
        </div>

        <!-- View More + Add New -->
        <div class="d-flex justify-content-between mt-3">
          <button type="button" class="btn btn-outline-primary w-40" 
                  data-bs-toggle="modal" data-bs-target="#viewMoreAddressesModal">
            View more Addresses
          </button>
          <button type="button" class="btn btn-outline-primary w-40 me-1" data-bs-toggle="modal" data-bs-target="#addAddressModal">
            + Add New Address
          </button>
        </div>

        <!-- Payment Method Selection -->
<h5 class="mt-4 mb-3">Select Payment Method:</h5>
<div class="mb-3">
  <div class="border rounded p-3 mb-2 payment-option" data-target="cod">
    <div class="form-check w-100">
      <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="COD">
      <label class="form-check-label fw-semibold w-100 p-0" for="cod">
        <i class="bi bi-cash-coin me-2 fs-3 text-primary"></i>Cash on Delivery
      </label>
    </div>
  </div>
  <div class="border rounded p-3 payment-option" data-target="online">
    <div class="form-check w-100">
      <input class="form-check-input" type="radio" name="paymentMethod" id="online" value="Online">
      <label class="form-check-label fw-semibold w-100 p-0" for="online">
        <i class="bi bi-credit-card-fill me-2 fs-3 text-primary"></i>Online Payment
      </label>
    </div>
  </div>
</div>


        <!-- Hidden field -->
        <input type="hidden" name="selectedAddressIdHidden" id="selectedAddressIdHidden" 
               value="<%= addresses.length > 0 ? addresses[0]._id : "" %>">

      </div>
    </div>

    <!-- Order Summary (Left column, exact left to address selection) -->
    <div class="col-lg-5 order-lg-2">
      <div class="bg-white p-4 rounded shadow-sm">
        <h4 class="mb-4">Order Summary</h4>
        <ul class="list-group mb-3">
          <% for (let i = 0; i < items.length; i++) { %>
            <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
              <div class="d-flex align-items-center">
                <img
                  src="<%= items[i].image ? items[i].image : '/placeholder.svg?height=80&width=60' %>"
                  alt="<%= items[i].name %>"
                  class="rounded me-2"
                  style="width: 60px; height: 80px; object-fit: cover;"
                >
                <div>
                  <strong><%= items[i].name %></strong>
                  <div class="text-muted small">Qty: <%=items[i].quantity%></div>
                </div>
              </div>
              <span>₹ <%= items[i].totalPrice %></span>
            </li>
          <% } %>
          <li class="list-group-item d-flex justify-content-between border-0 px-0">
            <span>Delivery Charge:</span>
            <span class="text-success fw-bold">₹ <%=shippingCharge%></span>
          </li>
          <li class="list-group-item d-flex justify-content-between border-0 px-0">
            <span>Coupon Discount:</span>
            <span class="text-success fw-bold">-₹ 0</span>
          </li>
        </ul>
        <div class="mb-3">
          <div class="input-group">
            <input type="text" class="form-control" placeholder="Enter Coupon Code" aria-label="Enter Coupon Code">
            <button class="btn btn-danger" type="button">Apply</button>
          </div>
        </div>
        <div class="d-flex justify-content-between mb-3 px-1">
          <div>
            <span class="fw-bold">Total</span><br>
            <small class="text-muted">In Rupees</small>
          </div>
          <span class="h5 fw-bold">₹ <%=finalAmount %></span>
        </div>

        <!-- Submit button -->
        <button class="btn btn-danger w-100 fw-bold" type="submit">
          Continue
        </button>
      </div>
    </div>
  </div>
</form>

  <!-- View More Addresses Modal -->
  <div class="modal fade" id="viewMoreAddressesModal" tabindex="-1" 
       aria-labelledby="viewMoreAddressesLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewMoreAddressesLabel">All Addresses</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <% if(allAddresses && allAddresses.length > 0) { %>
            <% allAddresses.forEach(address => { %>
              <div class="border p-3 mb-2 rounded">
                <strong><%= address.name %></strong><br>
                <%= address.phone %><br>
                <%= address.streetAddress %><br>
                <%= address.city %>, <%= address.state %> - <%= address.pinCode %><br>
                <span class="badge bg-secondary"><%= address.addressType %></span>
                <button type="button" 
                        class="btn btn-primary btn-sm float-end ms-2"
                        onclick="selectAddressFromModal('<%= address._id %>', '<%= address.name %>', '<%= address.phone %>', '<%= address.streetAddress %>', '<%= address.city %>', '<%= address.state %>', '<%= address.pinCode %>', '<%= address.addressType %>')">
                  Select this address
                </button>
              </div>
            <% }); %>
          <% } else { %>
            <p>No addresses found.</p>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Address Modals -->
  <% if(addresses && addresses.length > 0) { %>
    <% addresses.forEach(address => { %>
      <!-- Edit Address Modal -->
      <div class="modal fade" id="editAddressModal-<%= address._id %>" tabindex="-1" aria-labelledby="editAddressLabel-<%= address._id %>" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <form id="editAddressForm-<%= address._id %>" class="row g-3">
              <div class="modal-header">
                <h5 class="modal-title" id="editAddressLabel-<%= address._id %>">Edit Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>

              <div class="modal-body">
                <!-- Name -->
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Name</label>
                  <input type="text" name="name" class="form-control" value="<%= address.name %>" >
                </div>

                <!-- City -->
                <div class="col-md-6">
                  <label class="form-label fw-semibold">City</label>
                  <input type="text" name="city" class="form-control" value="<%= address.city %>" >
                </div>

                <!-- Street Address -->
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Street address</label>
                  <input type="text" name="streetAddress" class="form-control" value="<%= address.streetAddress %>">
                </div>

                <!-- State -->
                <div class="col-md-6">
                  <label class="form-label fw-semibold">State</label>
                  <input type="text" name="state" class="form-control" value="<%= address.state %>">
                </div>

                <!-- Pin Code -->
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Pin Code</label>
                  <input type="text" name="pinCode" class="form-control" value="<%= address.pinCode %>" maxlength="6" pattern="[0-9]{6}" >
                </div>

                <!-- Phone -->
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Phone</label>
                  <input type="text" name="phone" class="form-control" value="<%= address.phone %>" maxlength="10" pattern="[0-9]{10}" >
                </div>

                <!-- Alternative Phone -->
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Alternative Phone</label>
                  <input type="text" name="altPhone" class="form-control" value="<%= address.altPhone %>" maxlength="10" pattern="[0-9]{10}">
                </div>

                <!-- Address Type -->
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Address Type</label>
                  <select name="addressType" class="form-select">
                    <option value="Home" <%= address.addressType === 'Home' ? 'selected' : '' %>>Home</option>
                    <option value="Work" <%= address.addressType === 'Work' ? 'selected' : '' %>>Work</option>
                    <option value="Other" <%= address.addressType === 'Other' ? 'selected' : '' %>>Other</option>
                  </select>
                </div>

                <!-- Default Address -->
                <div class="col-md-12">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="isDefault" <%= address.isDefault ? 'checked' : '' %>>
                    <label class="form-check-label">Set as default address</label>
                  </div>
                </div>
              </div>

              <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    <% }); %>
  <% } %>

  <!-- Add Address Modal -->
  <div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="addAddressForm" action="/profile/address/add" class="row g-3">
          <div class="modal-header">
            <h5 class="modal-title" id="addAddressLabel">Add New Address</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Name -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Name</label>
              <input type="text" name="name" class="form-control">
            </div>

            <!-- City -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">City</label>
              <input type="text" name="city" class="form-control" >
            </div>

            <!-- Street Address -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Street address</label>
              <input type="text" name="streetAddress" class="form-control" >
            </div>

            <!-- State -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">State</label>
              <input type="text" name="state" class="form-control">
            </div>

            <!-- Pin Code -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Pin Code</label>
              <input type="text" 
                            name="pinCode" 
                            class="form-control"  
                            maxlength="6" 
                            pattern="[0-9]{6}"
                            placeholder="6-digit PIN"
                            title="Pin code must be 6 digits"
                            oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,6)">
            </div>

            <!-- Phone -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Phone</label>
              <input type="text" name="phone" class="form-control" maxlength="10" pattern="[0-9]{10}" placeholder="Mobile Number"
                                                      title="Phone number must be 10 digits"
                                                      oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,10)" 
                                                      >
            </div>

            <!-- Alternative Phone -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Alternative Phone</label>
              <input type="text" name="altPhone" class="form-control"  maxlength="10" 
                          placeholder="Alt. Phone"
                          pattern="[0-9]{10}"
                          title="Alternative phone must be 10 digits"
                          oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,10)">
            </div>

            <!-- Address Type -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Address Type</label>
              <select name="addressType" class="form-select">
                <option value="Home">Home</option>
                <option value="Work">Work</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <!-- Default Address -->
            <div class="col-md-12 mt-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="isDefault">
                <label class="form-check-label">Set as default address</label>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Add Address</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<%- include("../../views/partials/user/footer") %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
 const urlParams = new URLSearchParams(window.location.search);
  const error = urlParams.get('error');
  const success = urlParams.get('success');

  if (error) {
    Swal.fire({
      icon: 'error',
      title: 'Oops...',
      text: decodeURIComponent(error),
      confirmButtonColor: '#d33'
    });
  }

  if (success) {
    Swal.fire({
      icon: 'success',
      title: 'Success!',
      text: decodeURIComponent(success),
      confirmButtonColor: '#3085d6'
    });
  }

  function updateSelectedAddress(addressId) {
    document.getElementById("selectedAddressIdHidden").value = addressId;
  }

  function selectAddressFromModal(id, name, phone, street, city, state, pin, type) {
    document.getElementById("selectedAddressIdHidden").value = id;
    
    // Find the currently selected address div in the main section
    const currentRadio = document.querySelector('input[name="selectedAddressId"]:checked');
    if (currentRadio) {
      const currentDiv = currentRadio.closest('.position-relative');
      if (currentDiv) {
        // Update the content of the current selected address div
        currentDiv.innerHTML = `
          <div>
            <input type="radio" name="selectedAddressId" value="${id}" checked onchange="updateSelectedAddress('${id}')" />
            <strong>${name}</strong><br>
            ${phone}<br>
            ${street}<br>
            ${city}, ${state} - ${pin}
          </div>
          <span class="badge bg-secondary position-absolute top-0 end-0 mt-2 me-2">
            ${type}
          </span>
          <button type="button" 
                  class="btn btn-sm btn-dark position-absolute top-0 end-0 mt-2 me-2" 
                  style="transform:translateY(1.8rem);">Edit</button>
        `;
      }
    }
    
    // Close the modal
    const modalElement = document.getElementById('viewMoreAddressesModal');
    const modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) {
      modal.hide();
    }
  }

  document.getElementById("addAddressForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
      const res = await fetch(form.action, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      const result = await res.json();

      if (result.success) {
        // ✅ Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById("addAddressModal"));
        modal.hide();

        // ✅ Add new address to checkout list dynamically
        const addressList = document.querySelector(".mb-3"); // container for addresses
        const newDiv = document.createElement("div");
        newDiv.className = "border rounded p-3 mb-3 position-relative";
        newDiv.style.border = "2px solid #edc2ba";
        newDiv.innerHTML = `
          <div>
            <input type="radio" name="selectedAddressId" 
                   value="${result.addressId}" 
                   checked 
                   onchange="updateSelectedAddress('${result.addressId}')"/>
            <strong>${data.name}</strong><br>
            ${data.phone}<br>
            ${data.streetAddress}<br>
            ${data.city}, ${data.state} - ${data.pinCode}
          </div>
          <span class="badge bg-secondary position-absolute top-0 end-0 mt-2 me-2">
            ${data.addressType}
          </span>
          <button type="button" 
                  class="btn btn-sm btn-dark position-absolute top-0 end-0 mt-2 me-2" 
                  style="transform:translateY(1.8rem);" 
                  data-bs-toggle="modal"
                  data-bs-target="#editAddressModal-${result.addressId}">Edit</button>
        `;
        addressList.prepend(newDiv);

        // ✅ Update hidden field
        document.getElementById("selectedAddressIdHidden").value = result.addressId;

        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: 'Address added successfully!',
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error!',
          text: result.message || 'Failed to add address',
        });
      }
    } catch (err) {
      console.error("Error:", err);
      Swal.fire({
        icon: 'error',
        title: 'Error!',
        text: 'Something went wrong',
      });
    }
  });

  <% if(addresses && addresses.length > 0) { %>
    <% addresses.forEach(address => { %>
      document.getElementById("editAddressForm-<%= address._id %>").addEventListener("submit", async function(e) {
        e.preventDefault();
        await saveEditedAddress(e, "<%= address._id %>");
      });
    <% }); %>
  <% } %>

 async function saveEditedAddress(e, addressId) {
  const form = document.getElementById(`editAddressForm-${addressId}`);
  const formData = new FormData(form);
  const data = Object.fromEntries(formData.entries());

  const radio = document.querySelector(`input[value="${addressId}"]`);
  const wasChecked = radio ? radio.checked : false;
  const checkedAttr = wasChecked ? 'checked' : '';

  try {
    const res = await fetch(`/profile/address/edit/${addressId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    // Always parse the JSON!
    const result = await res.json();

    if (result.success) {
      // Only on success: update address card and hide modal
      const card = document.querySelector(`input[value="${addressId}"]`)?.closest(".position-relative");
      if (card) {
        card.innerHTML = `
          <div>
            <input type="radio" name="selectedAddressId" value="${addressId}" ${checkedAttr} onchange="updateSelectedAddress('${addressId}')" />
            <strong>${data.name}</strong><br>
            ${data.phone}<br>
            ${data.streetAddress}<br>
            ${data.city}, ${data.state} - ${data.pinCode}
          </div>
          <span class="badge bg-secondary position-absolute top-0 end-0 mt-2 me-2">
            ${data.addressType}
          </span>
          <button type="button" 
                  class="btn btn-sm btn-dark position-absolute top-0 end-0 mt-2 me-2" 
                  style="transform:translateY(1.8rem);" 
                  data-bs-toggle="modal"
                  data-bs-target="#editAddressModal-${addressId}">Edit</button>
        `;
        if (wasChecked) {
          updateSelectedAddress(addressId);
        }
      }

      // Only close the modal here!
      const modalEl = document.getElementById(`editAddressModal-${addressId}`);
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();

      Swal.fire({
        icon: 'success',
        title: 'Success!',
        text: 'Address updated successfully!',
      });
    } else {
      // Show Swal for errors and do NOT close the modal!
      Swal.fire({
        icon: 'error',
        title: 'Error!',
        text: result.message || 'Failed to update address',
      });
    }
  } catch (err) {
    console.error(err);
    Swal.fire({
      icon: 'error',
      title: 'Error!',
      text: 'Something went wrong',
    });
  }
}

document.addEventListener('DOMContentLoaded', function() {
  const paymentOptions = document.querySelectorAll('.payment-option');
  paymentOptions.forEach(option => {
    option.addEventListener('click', function() {
      const targetId = this.dataset.target;
      document.getElementById(targetId).checked = true;
      // Trigger change event if needed
      document.getElementById(targetId).dispatchEvent(new Event('change'));
    });
  });

  // Update visual state on radio change
  document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
    radio.addEventListener('change', function() {
      paymentOptions.forEach(opt => opt.classList.remove('selected'));
      const selectedOption = document.querySelector(`[data-target="${this.value}"]`);
      if (selectedOption) {
        selectedOption.classList.add('selected');
      }
    });
  });
});

</script>