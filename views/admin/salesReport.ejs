<%- include('../../views/partials/admin/header') %>
<%
let queryString = "";
if (startDate && endDate) {
  queryString = `&startDate=${startDate}&endDate=${endDate}`;
} else if (range) {
  queryString = `&range=${range}`;
}
%>


<style>
  .text-purple { color: #9c27b0; }
</style>


<!-- Main Content Area -->
<div class="col-md-10">

  <!-- Page Header -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center p-3 border-bottom mb-4 gap-3">
    <h1 class="h2 mb-0 fw-bold">Sales Report</h1>
  </div>

  

  <!-- KPI GRID START -->
  <div class="row g-4 mb-4">

    <!-- 1. Total Revenue (Gross) -->
    <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
      <div class="card shadow-sm border-0 h-100 text-center p-3">
        <i class="bi bi-cash-coin text-success" style="font-size: 2.5rem;"></i>
        <h6 class="text-muted mt-2">Total Revenue (Gross)</h6>
        <h3 class="fw-bold text-success">₹<%=kpis.grossRevenue.toFixed(2) %>/-</h3>
      </div>
    </div>

    <!-- 2. Net Revenue -->
    <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
      <div class="card shadow-sm border-0 h-100 text-center p-3">
        <i class="bi bi-wallet2 text-primary" style="font-size: 2.5rem;"></i>
        <h6 class="text-muted mt-2">Net Revenue</h6>
        <h3 class="fw-bold text-primary">₹<%=kpis.netRevenue.toFixed(2) %>/-</h3>
      </div>
    </div>

    <!-- 3. Total Orders -->
    <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
      <div class="card shadow-sm border-0 h-100 text-center p-3">
        <i class="bi bi-bag-check text-dark" style="font-size: 2.5rem;"></i>
        <h6 class="text-muted mt-2">Total Orders</h6>
        <h3 class="fw-bold text-info"><%= kpis.totalOrders %></h3>
      </div>
    </div>

    <!-- 4. Delivered Orders -->
    <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
      <div class="card shadow-sm border-0 h-100 text-center p-3">
        <i class="bi bi-truck text-success" style="font-size: 2.5rem;"></i>
        <h6 class="text-muted mt-2">Delivered Orders</h6>
        <h3 class="fw-bold text-success"><%= kpis.deliveredOrders %></h3>
      </div>
    </div>

    <!-- 5. Cancelled Orders -->
    <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
      <div class="card shadow-sm border-0 h-100 text-center p-3">
        <i class="bi bi-x-octagon text-danger" style="font-size: 2.5rem;"></i>
        <h6 class="text-muted mt-2">Cancelled Orders</h6>
        <h3 class="fw-bold text-danger"><%= kpis.cancelledOrders %></h3>
      </div>
    </div>

    <!-- 6. Returned Orders -->
    <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
      <div class="card shadow-sm border-0 h-100 text-center p-3">
        <i class="bi bi-arrow-return-left text-warning" style="font-size: 2.5rem;"></i>
        <h6 class="text-muted mt-2">Returned Orders</h6>
        <h3 class="fw-bold text-dark"><%= kpis.returnedOrders %></h3>
      </div>
    </div>

    <!-- 7. Total Discount -->
    <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
      <div class="card shadow-sm border-0 h-100 text-center p-3">
        <i class="bi bi-ticket-perforated text-danger" style="font-size: 2.5rem;"></i>
        <h6 class="text-muted mt-2">Total Discount</h6>
        <h3 class="fw-bold text-danger">₹<%= (kpis.totalDiscountFromOffers + kpis.totalCouponDiscount).toFixed(2) %>/-</h3>
      </div>
    </div>

    <!-- 8. Coupon Deductions -->
    <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
      <div class="card shadow-sm border-0 h-100 text-center p-3">
        <i class="bi bi-percent text-info" style="font-size: 2.5rem;"></i>
        <h6 class="text-muted mt-2">Coupon Deductions</h6>
        <h3 class="fw-bold text-primary">₹<%= kpis.totalCouponDiscount.toFixed(2) %>/-</h3>
      </div>
    </div>

    <!-- 9. Cancelled Items -->
<div class="col-12 col-sm-6 col-lg-4 col-xl-3">
  <div class="card shadow-sm border-0 h-100 text-center p-3">
    <i class="bi bi-arrow-counterclockwise text-warning" style="font-size: 2.5rem;"></i>
    <h6 class="text-muted mt-2">Total Cancelled Items</h6>
    <h3 class="fw-bold text-danger"><%= kpis.cancelledItems %></h3>
  </div>
</div>

<!-- 10. Returned Items -->
<div class="col-12 col-sm-6 col-lg-4 col-xl-3">
  <div class="card shadow-sm border-0 h-100 text-center p-3">
    <i class="bi bi-slash-circle text-danger" style="font-size: 2.5rem;"></i>
    <h6 class="text-muted mt-2">Total Returned Items</h6>
    <h3 class="fw-bold text-dark"><%= kpis.returnedItems %></h3>
  </div>
</div>

<!-- 11. Total Customers -->
<div class="col-12 col-sm-6 col-lg-4 col-xl-3">
  <div class="card shadow-sm border-0 h-100 text-center p-3">
    <i class="bi bi-people text-secondary" style="font-size: 2.5rem;"></i>
    <h6 class="text-muted mt-2">Total Customers</h6>
    <h3 class="fw-bold text-info"><%= totalCustomers %></h3>
  </div>
</div>

<!-- 12. Total Shipping Charges Collected -->
<div class="col-12 col-sm-6 col-lg-4 col-xl-3">
  <div class="card shadow-sm border-0 h-100 text-center p-3">
    <i class="bi bi-box-seam text-primary" style="font-size: 2.5rem;"></i>
    <h6 class="text-muted mt-2">Shipping Charges Collected</h6>
    <h3 class="fw-bold text-primary">₹<%=kpis.totalShippingCharge.toFixed(2) %>/-</h3>
  </div>
</div>


  </div>
  <!-- KPI GRID END -->

  <!-- Sales Table -->
  <div class="card shadow-sm border-0">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h5 class="mb-0 fw-semibold">Detailed Sales Report</h5>

    <div class="ms-auto d-flex flex-wrap gap-2">
      <button id="downloadPdfBtn" class="btn btn-outline-danger d-flex align-items-center gap-2">
        <i class="bi bi-filetype-pdf"></i> Download PDF
      </button>

      <button id="downloadExcelBtn" class="btn btn-outline-success d-flex align-items-center gap-2">
        <i class="bi bi-filetype-xlsx"></i> Download Excel
      </button>
    </div>
  </div>

    <!-- Date Filters -->
  <div class="card mb-4 shadow-sm border-0">
    <div class="card-body">
      <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">

        <!-- Radio Filters -->
        <div class="btn-group" role="group" aria-label="Date Filters">
          <input type="radio" class="btn-check" name="range" id="daily">
          <label class="btn btn-outline-success" for="daily">Daily</label>

          <input type="radio" class="btn-check" name="range" id="weekly" checked>
          <label class="btn btn-outline-primary" for="weekly">Weekly</label>

          <input type="radio" class="btn-check" name="range" id="monthly">
          <label class="btn btn-outline-secondary" for="monthly">Monthly</label>

          <input type="radio" class="btn-check" name="range" id="yearly">
          <label class="btn btn-outline-danger" for="yearly">Yearly</label>

        </div>

        <!-- Custom Date Range -->
        <div class="d-flex gap-2 align-items-center" id="customDateInputs" style="display: none;">
          <input type="date" class="form-control" id="startDate">
          <input type="date" class="form-control" id="endDate">
        </div>

        <!-- Generate Button -->
        <button id="generateReportBtn" class="btn btn-primary">
          Generate Report
        </button>
      </div>
    </div>
  </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 text-center">
          <thead class="table-light">
            <tr>
              <th>Order ID</th>
              <th>Date</th>
              <th>Customer</th>
              <th class="text-end">Discount</th>
              <th class="text-end">Paid Amount</th>
              <th class="text-end">Payment Method</th>
              <th class="text-center">Status</th>
            </tr>
          </thead>
          <tbody id="salesTableBody">
            <% if (detailed && detailed.length > 0 ) { %>
              <% detailed.forEach( order => { %>
                <tr>
                  <td>#<%= order.orderId %></td>
                  <td class="text-center"><%= order.createdAt.toLocaleDateString() %></td>
                  <td><%= order.userId?.name %></td>

                  <td class="text-end text-danger">-₹<%= order.discount.toFixed(2) %>/-</td>
                  <% if (order.finalPayableAmount>0) { %>
                    <td class="text-end">₹<%= order.finalPayableAmount.toFixed(2) %>/-</td>
                  <% }else { %>
                    <td class="text-end">₹<%= order.finalAmount.toFixed(2) %>/-</td>
                  <% } %> 
                  <td class="text-center text-info"><%= order.paymentMethod %></td>

                    <% if (order.status == "Delivered" ) { %>
                      <td class="text-center text-success fw-semibold"><%= order.status %></td>
                    <% } else { %>
                      <td class="text-center text-danger"><%= order.status %></td>
                    <% } %>
                </tr>
              <% }) %>  

            <% } else { %>
              <tr>
                <td colspan="7" class="text-center text-muted py-4">
                  No orders for seleted date range !
                </td>
              </tr>
            <% } %>  
          </tbody>
          <tfoot class="table-light">
            <tr class="fw-bold fs-5">
              <td colspan="3">TOTAL</td>
              <td class="text-end text-danger">-₹<%= totalDiscount.toFixed(2) %>/-</td>
              <td class="text-end ">₹<%= totalAmount.toFixed(2) %>/-</td>
              <!-- <td class="text-end">₹1,216.50</td>
              <td></td> -->
            </tr>
          </tfoot>
        </table>
        <nav>
          <ul class="pagination justify-content-center">

            <% if (pagination.page > 1) { %>
              <li class="page-item">
                <a class="page-link"
                      href="?page=<%= pagination.page - 1 %>&limit=<%= pagination.limit %><%= queryString %>">Previous</a>

              </li>
            <% } %> 

          <% for (let i = 1 ; i <= pagination.totalPages; i++ ) { %>
            <li class="page-item <%= i === pagination.page ? 'active' : '' %>">
              <a class="page-link"
                    href="?page=<%= i %>&limit=<%= pagination.limit %><%= queryString %>">
                    <%= i %>
                  </a>
            </li>
          <% } %>

          <% if (pagination.page < pagination.totalPages) { %>
            <li class="page-item">
              <a class="page-link"
                    href="?page=<%= pagination.page + 1 %>&limit=<%= pagination.limit %><%= queryString %>">Next</a>
            </li>
          <% } %>

          </ul>
        </nav>
      </div>
    </div>
  </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ----------------------------------
     0️⃣ SHOW BACKEND ERROR (FROM URL)
  ---------------------------------- */
  const params = new URLSearchParams(window.location.search);
  const errorMessage = params.get("error");

  if (errorMessage) {
    Swal.fire({
      icon: "error",
      title: "Invalid Date Selection",
      text: decodeURIComponent(errorMessage)
    });

    params.delete("error");
    const cleanUrl =
      window.location.pathname +
      (params.toString() ? "?" + params.toString() : "");

    window.history.replaceState({}, "", cleanUrl);
  }

  /* ----------------------------------
     1️⃣ ELEMENT REFERENCES
  ---------------------------------- */
  const radios = ["daily", "weekly", "monthly", "yearly"];
  const startDateInput = document.getElementById("startDate");
  const endDateInput = document.getElementById("endDate");
  const customBox = document.getElementById("customDateInputs");
  const generateBtn = document.getElementById("generateReportBtn");

  radios.forEach(id => {
    document.getElementById(id).addEventListener("change", () => {
      customBox.style.display = "none";
      startDateInput.value = "";
      endDateInput.value = "";
    });
  });

  function activateCustomDate() {
    customBox.style.display = "flex";
    radios.forEach(id => {
      document.getElementById(id).checked = false;
    });
  }

  startDateInput.addEventListener("focus", activateCustomDate);
  endDateInput.addEventListener("focus", activateCustomDate);

  /* ----------------------------------
      2️⃣ GENERATE REPORT
  ---------------------------------- */
  generateBtn.addEventListener("click", (e) => {
    e.preventDefault();

    const startDate = startDateInput.value;
    const endDate = endDateInput.value;
    let query = "";

    if (startDate && endDate) {
      query = `?startDate=${startDate}&endDate=${endDate}`;
    } else {
      const range = document.querySelector("input[name='range']:checked")?.id;

      if (!range) {
        Swal.fire({
          icon: "warning",
          title: "Select a filter",
          text: "Choose a date range or custom dates"
        });
        return;
      }
      query = `?range=${range}`;
    }

    window.location.href = `/admin/salesReport${query}`;
  });

  /* ----------------------------------
     3️⃣ RESTORE STATE FROM URL
  ---------------------------------- */
  const range = params.get("range");
  const startDate = params.get("startDate");
  const endDate = params.get("endDate");

  if (startDate && endDate) {
    customBox.style.display = "flex";
    startDateInput.value = startDate;
    endDateInput.value = endDate;
    radios.forEach(id => document.getElementById(id).checked = false);
  } else if (range) {
    document.getElementById(range)?.setAttribute("checked", true);
  }
});

/* ----------------------------------
   4️⃣ DOWNLOAD HELPERS
---------------------------------- */
function getFilters() {
  return new URLSearchParams(window.location.search).toString();
}

document.getElementById("downloadPdfBtn").addEventListener("click", () => {
  window.location.href = `/admin/salesReport/downloadPDF?${getFilters()}`;
});

document.getElementById("downloadExcelBtn").addEventListener("click", () => {
  window.location.href = `/admin/salesReport/downloadExcel?${getFilters()}`;
});
</script>

<%- include('../../views/partials/admin/footer') %>
