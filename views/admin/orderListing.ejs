<%- include('../../views/partials/admin/header') %>

  <!-- Main Content Area -->
  <div class="col-md-10 p-4" style="background-color: #f8f9fa; min-height: 100vh;">
    
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
      <h2 class="fw-semibold mb-0">Orders</h2>
      <div class="d-flex gap-2">
        <div class="d-flex gap-2">
  <form class="d-flex gap-2" action="/admin/userOrders" method="get">
    <input 
      type="text" 
      id="searchBox" 
      name="search"
      value="<%= typeof search !== 'undefined' ? search : '' %>"
      class="form-control" 
      placeholder="Search by Order ID, Product, or Status"
      style="max-width: 300px;"
    >

    <button type="submit" class="btn btn-dark">Search</button>

    <% if (search && search.length > 0) { %>
      <a href="/admin/userOrders" class="btn btn-outline-secondary">Clear</a>
    <% } else { %>
      <button type="button" class="btn btn-outline-secondary" disabled>Clear</button>
    <% } %>
  </form>
</div>

        <select id="sortBy" class="form-select" style="max-width: 150px;">
          <option value="">Sort By</option>
          <option value="date_desc">Newest</option>
          <option value="date_asc">Oldest</option>
          <option value="total_desc">Highest Price</option>
          <option value="total_asc">Lowest Price</option>
        </select>

<div class="btn-group">
  <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
    Filters
  </button>
  <ul class="dropdown-menu dropdown-menu-end">
    <li><a class="dropdown-item" href="#" onclick="filterStatus('pending')">Pending</a></li>
    <li><a class="dropdown-item" href="#" onclick="filterStatus('packed')">Packed</a></li>
    <li><a class="dropdown-item" href="#" onclick="filterStatus('shipped')">Shipped</a></li>
    <li><a class="dropdown-item" href="#" onclick="filterStatus('out for delivery')">Out for Delivery</a></li>
    <li><a class="dropdown-item" href="#" onclick="filterStatus('delivered')">Delivered</a></li>
    <li><a class="dropdown-item" href="#" onclick="filterStatus('return requested')">Return Requested</a></li>
    <li><a class="dropdown-item" href="#" onclick="filterStatus('returned')">Returned</a></li>
    <li><a class="dropdown-item" href="#" onclick="filterStatus('cancel requested')">Cancel Requested</a></li>
    <li><a class="dropdown-item" href="#" onclick="filterStatus('cancelled')">Cancelled</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item text-danger" href="#" onclick="clearFilters()">Clear Filters</a></li>
  </ul>
</div>

        <!-- <button class="btn btn-dark" onclick="exportOrders()">Export</button> -->
      </div>
    </div>

    <!-- Orders Table -->
    <div class="bg-white shadow-sm rounded-3 overflow-hidden">
      <table class="table table-hover align-middle mb-0 text-center">
        <thead class="bg-dark text-white">
          <tr>
            <th>Image</th>
            <th>Order ID</th>
            <th>Date</th>
            <th>Customer</th>
            <th>Status</th>
            <th>Total</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <% if (orders && orders.length > 0) { %>
            <% orders.forEach(order => { %>
              <tr>
                <td>
                  <% if (order.items && order.items.length > 0) { %>
                    <img src="<%= order.items[0].image %>" width="55" height="65" class="rounded" alt="<%= order.items[0].name %>">
                  <% } else { %>
                    <img src="/images/placeholder-book.jpg" width="55" height="65" class="rounded" alt="No Image">
                  <% } %>
                </td>
                <td><%= order.orderId %></td>
                <td><%= new Date(order.createdAt).toLocaleDateString('en-IN') %></td>
                <td><%= order.user.name %></td>
                <td>
                  <% const statusMap = {
                    'placed': { class: 'bg-info text-dark', text: 'Placed' },
                    'packed': { class: 'bg-warning text-dark', text: 'Packed' },
                    'shipped': { class: 'bg-primary text-white', text: 'Shipped' },
                    'out_for_delivery': { class: 'bg-warning text-dark', text: 'Out for Delivery' },
                    'delivered': { class: 'bg-success text-white', text: 'Delivered' },
                    'return_requested': { class: 'bg-secondary text-white', text: 'Return Requested' },
                    'returned': { class: 'bg-danger text-white', text: 'Returned' },
                    'cancel_requested': { class: 'bg-secondary text-white', text: 'Cancel Requested' },
                    'cancelled': { class: 'bg-danger text-white', text: 'Cancelled' }
                  }; %>
                  <span class="badge <%= statusMap[order.status]?.class || 'bg-secondary' %> px-3 py-2">
                    <%= statusMap[order.status]?.text || order.status %>
                  </span>
                </td>
                <td>₹<%= order.totalAmount %></td>
                <td>
                  <a href="/admin/userOrders/<%= order._id %>" class="btn btn-outline-primary btn-sm">View</a>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr><td colspan="7" class="text-center py-5 text-muted">No orders found</td></tr>
          <% } %>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Order Pagination" class="mt-4">
      <ul class="pagination justify-content-center">
        
          <% for (let i = 1; i <= totalPages; i++) { %>
            <li class="page-item <%= currentPage == i ? 'active' : '' %>">
              <a class="page-link" href="?page=<%= i %>&sortBy=<%= sortBy %>&search=<%= search %>&filter=<%= filter %>"><%= i %></a>
            </li>
          <% } %>

      </ul>
    </nav>

  </div>
</div>

<%- include('../../views/partials/admin/footer') %>

<script>
  // ✅ Preserve search & sort params when applying filters
  function filterStatus(status) {
    const url = new URL(window.location.href);
    url.searchParams.set('filter', status);
    window.location.href = url.toString();
  }

  // ✅ Preserve search, filter when changing sort
  document.getElementById("sortBy").addEventListener("change", function () {
    const url = new URL(window.location.href);
    url.searchParams.set("sortBy", this.value);
    window.location.href = url.toString();
  });

  // ✅ Clear filters properly and stay on same page
  function clearFilters() {
    const url = new URL(window.location.href);
    url.searchParams.delete('filter');
    window.location.href = url.toString();
  }

//   function exportOrders() {
//     alert('Export functionality - Download CSV');
//   }
</script>
