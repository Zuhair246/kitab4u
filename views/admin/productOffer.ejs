<%- include("../../views/partials/admin/header") %>

<div class="col-md-10 p-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
    <h2 class="fw-bold">Product Offers</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOfferModal">
      <i class="fas fa-plus me-1"></i> Add Offer
    </button>
  </div>

  <!-- Offers Table -->
  <div class="card shadow-sm border-0">
    <div class="card-header bg-light">
      <h5 class="mb-0 fw-semibold">Active & Inactive Offers</h5>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Product</th>
              <th>Discount (%)</th>
              <th>Start</th>
              <th>End</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>

          <tbody>
            <% if (offers && offers.length > 0) { %>
              <% offers.forEach(offer => { %>
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      <img src="<%= offer.productId.images[0] || '/images/placeholder-book.jpg' %>" 
                          class="rounded me-2" style="width: 40px; height: 60px; object-fit: cover;">
                      <span><%= offer.productId.name %></span>
                    </div>
                  </td>
                  <td><span class="badge bg-success"><%= offer.discountPercentage %>%</span></td>
                  <td><%= new Date(offer.startDate).toLocaleDateString('en-IN') %></td>
                  <td><%= new Date(offer.endDate).toLocaleDateString('en-IN') %></td>
                  <td class="text-end">
                  <button 
                    class="btn btn-sm btn-outline-primary me-1" 
                    data-bs-toggle="modal" 
                    data-bs-target="#editOfferModal"
                    data-offer-id="<%= offer._id %>"
                    data-product-id="<%= offer.productId._id %>"
                    data-discount="<%= offer.discountPercentage %>"
                    data-start="<%= offer.startDate.toISOString().split('T')[0] %>"
                    data-end="<%= offer.endDate.toISOString().split('T')[0] %>"
                    onclick="loadEditOffer(this)">
                    <i class="fas fa-edit"></i>
                  </button>

                  <% if (offer.isActive) { %>
                    <button class="btn btn-sm btn-outline-danger"
                            onclick="deleteOffer('<%= offer._id %>')">
                      <i class="fas fa-trash"></i>
                    </button>
                  <% }else{ %>
                    <button class="btn btn-sm btn-outline-success"
                            onclick="activateOffer('<%= offer._id %>')">
                      <i class="fas fa-sync-alt"></i>

                    </button>
                  <%}%>
                  </td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr>
                <td colspan="5" class="text-center py-5 text-muted">
                  <i class="fas fa-tags fa-3x mb-3"></i>
                  <h5>No product offers yet</h5>
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <div class="d-flex justify-content-center mt-3">
    <ul class="pagination">
      <% for (let i = 1; i <= totalPages; i++) { %>
        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
          <a class="page-link" href="?page=<%= i %>"><%= i %></a>
        </li>
      <% } %>
    </ul>
  </div>
</div>


<!-- ADD OFFER MODAL -->
<div class="modal fade" id="addOfferModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Product Offer</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form id="addOfferForm" action="/admin/productOffers/add">
        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">Select Product</label>
            <select class="form-select" name="productId" >
              <option value="">Select product...</option>
              <% products.forEach(product => { %>
                <option value="<%= product._id %>"><%= product.name %> - ₹<%= product.variants[0].originalPrice %></option>
              <% }) %>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Discount (%)</label>
            <input type="number" class="form-control" name="discountPercentage" min="1" max="100" step="0.1" >
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-control" name="startDate" >
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">End Date</label>
              <input type="date" class="form-control" name="endDate" >
            </div>
          </div>

        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary">Save</button>
        </div>

      </form>
    </div>
  </div>
</div>


<!-- EDIT OFFER MODAL -->
<div class="modal fade" id="editOfferModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Product Offer</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form id="editOfferForm" action="/admin/productOffers/edit">
        <input type="hidden" id="editOfferId" name="offerId">

        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">Select Product</label>
            <select class="form-select" name="productId" >
              <option value="<%= %>">Select product...</option>
              <% products.forEach(product => { %>
                <option value="<%= product._id %>"><%= product.name %> - ₹<%= product.variants[0].originalPrice %></option>
              <% }) %>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Discount: (%)</label>
            <input type="number" class="form-control" id="editDiscountPercentage" name="discountPercentage" min="1" max="100" step="0.1" >
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Start Date: </label>
              <input type="date" class="form-control" id="editStartDate" name="startDate" >
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">End Date: </label>
              <input type="date" class="form-control" id="editEndDate" name="endDate" >
            </div>
          </div>

        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary">Update</button>
        </div>

      </form>
    </div>
  </div>
</div>
<%- include("../../views/partials/admin/footer") %>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.0/sweetalert.min.js"></script>

<script>
  function loadEditOffer(button) {
    const offerId = button.dataset.offerId;
    const productId = button.dataset.productId;
    const discount = button.dataset.discount;
    const startDate = button.dataset.start;
    const endDate = button.dataset.end;

    // Set the hidden input for offer ID
    document.getElementById('editOfferId').value = offerId;

    // Set the discount, start, and end dates
    document.getElementById('editDiscountPercentage').value = discount;
    document.getElementById('editStartDate').value = startDate;
    document.getElementById('editEndDate').value = endDate;

    // Pre-select the product in dropdown
    const select = document.querySelector('#editOfferModal select[name="productId"]');
    Array.from(select.options).forEach(opt => {
      opt.selected = opt.value === productId;
    });
  }

  function deleteOffer(offerId) {
    swal({
      title: "Are you sure?",
      text: "This offer will be deactivated!",
      icon: "warning",
      buttons: ["Cancel", "Yes, deactivate"],
      dangerMode: true,
    }).then((willDelete) => {
      if (willDelete) {
        fetch(`/admin/productOffers/${offerId}/deactivate`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            swal("Success!", "Offer has been deactivated.", "success")
              .then(() => window.location.reload());
          } else {
            swal("Error!", data.message || "Failed to deactivate offer.", "error");
          }
        })
        .catch(err => {
          console.error(err);
          swal("Error!", "Server error occurred.", "error");
        });
      }
    });
  }

  function activateOffer(offerId) {
    swal({
      title: "Are you sure?",
      text: "This offer will be activated!",
      icon: "warning",
      buttons: ["Confirm", "Yes, activate"],
    }).then((willActivate) => {
      if (willActivate) {
        fetch(`/admin/productOffers/${offerId}/activate`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            swal("Success!", "Offer has been activated.", "success")
              .then(() => window.location.reload());
          } else {
            swal("Error!", data.message || "Failed to activate offer.", "error");
          }
        })
        .catch(err => {
          console.error(err);
          swal("Error!", "Server error occurred.", "error");
        });
      }
    });
  }

  //add offer submit
document.getElementById("addOfferForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const form = this;

  const payload = {
    productId: form.productId.value,
    discountPercentage: form.discountPercentage.value,
    startDate: form.startDate.value,
    endDate: form.endDate.value
  };

  fetch(form.action, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  })
  .then(res => res.json().then(data => ({ ok: res.ok, data })))
  .then(({ ok, data }) => {
    if (!ok) throw data;

    swal("Success!", data.message, "success")
      .then(() => window.location.href = data.redirect);
  })
  .catch(err => {
    swal("Error!", err?.message || "Failed to add product offer", "error");
  });
});


//edit offer submit
document.getElementById("editOfferForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const form = this;

  const payload = {
    offerId: form.offerId.value,
    productId: form.productId.value,
    discountPercentage: form.discountPercentage.value,
    startDate: form.startDate.value,
    endDate: form.endDate.value
  };

  fetch(form.action, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  })
  .then(res => res.json().then(data => ({ ok: res.ok, data })))
  .then(({ ok, data }) => {
    if (!ok) throw data;

    swal("Success!", data.message, "success")
      .then(() => {
        window.location.reload();
      });
  })
  .catch(err => {
    swal(
      "Error!",
      err?.message || "Failed to update product offer",
      "error"
    );
  });
});

</script>