<%-include("../../views/partials/user/header") %>

<!-- Main Body for Wishlist Page -->
<main class="container my-4">
  <!-- Page Heading -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h1 class="h2 mb-0 fw-bold">My Wishlist</h1>
    <p class="text-muted mb-0"><% if (wishlistItems && wishlistItems.length > 0) { %> <%= wishlistItems.length %> Items <% } else { %> 0 Items <% } %></p>
  </div>

  <% if (wishlistItems && wishlistItems.length > 0) { %>
    <!-- Toolbar: Search, Filter, Sort -->
    <div class="card mb-4 shadow-sm border-0">
      <div class="card-body">
        <div class="row align-items-center g-3">
          <!-- Search -->
          <div class="col-md-6">
            <div class="input-group">
              <span class="input-group-text bg-white border-end-0">
                <i class="bi bi-search"></i>
              </span>
              <input type="text" class="form-control border-start-0" placeholder="Search in wishlist..." id="wishlistSearch">
            </div>
          </div>
          <!-- Filter and Sort Buttons -->
          <div class="col-md-6 text-md-end">
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-funnel me-1"></i> Filter
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#">In Stock</a></li>
                <li><a class="dropdown-item" href="#">Price Low to High</a></li>
                <li><a class="dropdown-item" href="#">Price High to Low</a></li>
              </ul>
            </div>
            <button type="button" class="btn btn-outline-secondary ms-2">
              <i class="bi bi-arrow-down-up me-1"></i> Sort by Price
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Grid -->
    <div class="row g-4">
      <% wishlistItems.forEach(item => { %>
        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6 col-12">
          <div class="card h-100 shadow-sm border-0 overflow-hidden">
            <!-- Image with Remove Button -->
            <div class="position-relative">
              <img src="<%= item.image || '/images/placeholder-book.jpg' %>" class="card-img-top" alt="<%= item.name %>" style="height: 250px; object-fit: cover;">
              <button type="button" class="position-absolute top-10 end-10 btn btn-danger btn-sm rounded-circle p-0" style="width: 32px; height: 32px;" onclick="removeFromWishlist('<%= item._id %>')">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
            <!-- Card Body -->
            <div class="card-body d-flex flex-column">
              <!-- Title and Author -->
              <h6 class="card-subtitle text-muted mb-1"><%= item.author %></h6>
              <h5 class="card-title mb-2">
                <a href="/productDetails?id=<%= item._id %>" class="text-decoration-none text-dark"><%= item.name %></a>
              </h5>
              <!-- Price -->
              <div class="mb-2">
                <% if (item.originalPrice > item.discountPrice) { %>
                  <span class="text-danger fw-bold me-2">₹<%= item.discountPrice %></span>
                  <span class="text-muted text-decoration-line-through">₹<%= item.originalPrice %></span>
                <% } else { %>
                  <span class="fw-bold">₹<%= item.originalPrice %></span>
                <% } %>
              </div>
              <!-- Stock Status -->
              <p class="mb-2 text-sm <%= item.stock > 0 ? 'text-success' : 'text-danger' %>">
                <%= item.stock > 0 ? 'In Stock' : 'Out of Stock' %>
              </p>
              <!-- Add to Cart Button -->
              <form action="/cart" method="post" class="mt-auto">
                <input type="hidden" name="productId" value="<%= item._id %>">
                <button type="submit" class="btn btn-primary w-100 <%= item.stock <= 0 ? 'disabled opacity-50' : '' %>">
                  <i class="bi bi-cart-plus me-1"></i> Add to Cart
                </button>
              </form>
            </div>
          </div>
        </div>
      <% }) %>
    </div>

    <!-- Pagination -->
    <nav aria-label="Wishlist Pagination" class="mt-5">
      <ul class="pagination justify-content-center">
        <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
          <a class="page-link" href="?page=<%= currentPage - 1 %>">Previous</a>
        </li>
        <% for (let i = 1; i <= totalPages; i++) { %>
          <li class="page-item <%= currentPage === i ? 'active' : '' %>">
            <a class="page-link" href="?page=<%= i %>"><%= i %></a>
          </li>
        <% } %>
        <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
          <a class="page-link" href="?page=<%= currentPage + 1 %>">Next</a>
        </li>
      </ul>
    </nav>
  <% } else { %>
    <!-- Empty State -->
    <div class="text-center py-5">
      <i class="bi bi-heart text-muted" style="font-size: 4rem;"></i>
      <h4 class="mt-3 text-muted">Your Wishlist is Empty</h4>
      <p class="text-muted">Start adding items to your wishlist to save them for later.</p>
      <a href="/shop" class="btn btn-primary">Browse Products</a>
    </div>
  <% } %>
</main>
<%-include("../../views/partials/user/footer") %>
<script>
  function removeFromWishlist(itemId) {
    if (confirm('Remove from wishlist?')) {
      fetch(`/wishlist/remove/${itemId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('Error removing item');
          }
        });
    }
  }
</script>