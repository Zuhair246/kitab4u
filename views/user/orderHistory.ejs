<%- include('../../views/partials/user/header') %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<div class="container my-5">
  <h2 class="text-center mb-4 text-primary"><b>My Orders</b></h2>

  <!--Search section-->
  <form action="/myOrders" class="d-flex justify-content-center mb-4">
    <input type="text"
                name="search"
                placeholder="Serach Book Name, Order ID, status......."
                class="form-control w-50 me-2"
                value="<%= typeof search !== 'undefined' ? search : '' %>">
                <button type="submit" class="btn btn-dark">Search</button>
                <% if (search) { %>
                  <a href="/myOrders" class="btn btn-secondary">Clear</a>
                <% } %>
  </form>
  <% if ( orders.length === 0 ) { %>
    <div class="text-center text-muted fs-4 mt-5">
        <i class="bi bi-box-seam-fill"></i> No orders found !
    </div>
  <% } %>

  <% orders.forEach(order => { %>
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <% let item = order.items[0] %>
          <div class="row align-items-center mb-3">
            <div class="col-auto">
              <img src="<%= item.image %>" alt="<%= item.name %>" style="width:80px;height:100px;object-fit:cover;" class="rounded">
            </div>
            <div class="col">
              <strong><%= item.name %></strong><br>
              <!-- <span class="badge bg-dark mb-2"><%= item.coverType %></span> -->
              <% if(order.items.length > 1) { %>
                <p class="text-muted mt-1">+ <%= order.items.length -1 %> more item(s)</p>
              <% } %>   
            </div>

            <div class="col-auto text-end fs-5 fw-semibold">
              â‚¹ <%= order.finalPayableAmount %>/-
            </div>

          </div>
        <!-- Progress bar (order status) -->
<hr>
<!-- Dynamic Progress Bar -->
<% if (order.status === 'Cancelled') { %>
  <div class="text-center my-4">
    <h5 class="text-danger fw-bold">Order Cancelled</h5>
  </div>
  <% } else if (order.status === 'Cancel Requested') { %>
     <div class="text-center my-4">
    <h5 class="text-danger fw-bold">Order requested for Cancelling</h5>
  </div>
    <% } else if (order.status === 'Return Requested') { %>
     <div class="text-center my-4">
    <h5 class="text-danger fw-bold">Order requested for Returning</h5>
  </div>
<% } else { %>
  <% 
    let stages = ['Order Placed','Packed','Shipped','Out for Delivery','Delivered'];
    if (['Returned'].includes(order.status)) {
      stages.push('Returned');
    }
  %>

  <div class="d-flex align-items-center mb-2">
    <% stages.forEach((stage, i) => { %>
      <div class="text-center position-relative flex-shrink-0 px-3">
        <i class="bi bi-stop-circle-fill <%= i <= order.statusIndex ? 'text-success' : 'text-secondary' %> fs-4"></i>
        <div class="small" style="color: <%= i <= order.statusIndex ? '#388e3c' : '#bdbdbd' %>"><%= stage %></div>
      </div>

      <% if (i < stages.length - 1) { %>
        <div class="flex-fill position-relative mx-2">
          <div class="position-absolute top-50 start-0 end-0 d-flex justify-content-center" style="transform: translateY(-50%);">
            <div class="w-100 <%= i < order.statusIndex ? 'bg-success' : 'bg-secondary' %> rounded" style="height: 2px;"></div>
          </div>
        </div>
      <% } %>
    <% }) %>
  </div>
<% } %>
<hr>

        <!-- Order Details Button -->
        <div class="d-flex justify-content-between align-items-center">
          <a href="/myOrders/<%= order._id %>" class="btn btn-primary btn-sm">Order Details</a>
          <div class="fw-semibold">
            Delivery Expected By <%= order.expectedDeliveryDateFormatted %>
          </div>
        </div>
      </div>
    </div>
  <% }) %>

  <!-- Pagination -->
        <% if (totalPages >= 1) { %>
        <div class="d-flex justify-content-between align-items-center mt-4">
            <div class="text-muted">
                Showing <%= totalItems %> results
            </div>
            <nav aria-label="Product pagination">
                
                <ul class="pagination mb-0">
                    <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                        <a class="page-link" href="?page=<%= currentPage - 1 %><%= search ? '&search=' + search : '' %>">Prev</a>
                    </li>
                    <% for (let i = 1; i <= totalPages; i++) { %>
                        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                            <a class="page-link" href="?page=<%= i %><%= search ? '&search=' + search : '' %>"><%= i %></a>
                        </li>
                    <% } %>
                    <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                        <a class="page-link" href="?page=<%= currentPage + 1 %><%= search ? '&search=' + search : '' %>">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
        <% } %>
</div>
<%- include('../../views/partials/user/footer') %>
