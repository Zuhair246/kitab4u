<%- include("../../views/partials/user/header") %>

<div class="container my-5">
  <div class="row">
   <!-- Sidebar (Desktop) -->
    <div class="col-md-4 d-none d-md-block">
      <%- include("../../views/partials/user/sidebar") %>
    </div>

    <!-- Sidebar Toggle Button (Mobile) -->
    <div class="d-block d-md-none mb-3">
      <button class="btn btn-outline-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas">
        <i class="bi bi-list"></i> Menu
      </button>
    </div>

    <!-- Offcanvas Sidebar (Mobile) -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas" aria-labelledby="sidebarOffcanvasLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="sidebarOffcanvasLabel">Your Account</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <%- include("../../views/partials/user/sidebar") %>
      </div>
    </div>
    
    <!-- Main Body -->
    <div class="col-md-8">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/profile" class="text-decoration-none">Your Account</a></li>
          <li class="breadcrumb-item active" aria-current="page">Your Addresses</li>
        </ol>
      </nav>

      <h2 class="mb-4">Your Addresses</h2>

      <!-- Flash Messages -->
      <% if (error && error.length > 0) { %>
        <div class="alert alert-danger" role="alert">
          <% error.forEach(function(msg) { %>
            <p class="mb-0"><%= msg %></p>
          <% }); %>
        </div>
      <% } %>

      <% if (success && success.length > 0) { %>
        <div class="alert alert-success" role="alert">
          <% success.forEach(function(msg) { %>
            <p class="mb-0"><%= msg %></p>
          <% }); %>
        </div>
      <% } %>

      <div class="row g-4">
        <!-- Add Address Card -->
        <div class="col-md-6">
          <div class="card h-100 border-2 border-dashed border-secondary">
            <div class="card-body d-flex flex-column justify-content-center align-items-center text-center py-5">
              <div class="mb-3">
                <i class="fas fa-plus display-1 text-muted"></i>
              </div>
              <h5 class="text-muted mb-3">Add address</h5>
              <a href="/profile/address/add" class="btn btn-outline-primary">Add New Address</a>
            </div>
          </div>
        </div>

        <!-- Existing Addresses -->
        <% if (userAddress && userAddress.length > 0) { %>
          <% userAddress.forEach(function(address, index) { %>
            <div class="col-md-6">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <!-- Default Badge -->
                  <% if (address.isDefault) { %>
                    <div class="mb-2">
                      <span class="badge bg-warning text-dark">Default: <strong>amazon</strong></span>
                    </div>
                  <% } %>

                  <!-- Address Details -->
                  <div class="address-details">
                    <h6 class="fw-bold mb-2"><%= address.name %></h6>
                    
                    <div class="text-muted mb-2">
                      <% if (address.landMark) { %>
                        <%= address.landMark %>,<br>
                      <% } %>
                      <%= address.city %><br>
                      <%= address.state %> <%= address.pinCode %><br>
                      India
                    </div>

                    <div class="mb-2">
                      <strong>Phone number:</strong> <%= address.phone %>
                      <% if (address.altPhone) { %>
                        <br><strong>Alt Phone:</strong> <%= address.altPhone %>
                      <% } %>
                    </div>

                    <% if (address.addressType) { %>
                      <div class="mb-3">
                        <small class="text-muted">Type: <%= address.addressType %></small>
                      </div>
                    <% } %>

                    <div class="mb-3">
                      <a href="#" class="text-primary text-decoration-none small">Add delivery instructions</a>
                    </div>
                  </div>

                  <!-- Action Buttons -->
                  <div class="d-flex gap-3">
                    <a href="/profile/addresses/edit/<%= address._id %>" class="text-primary text-decoration-none">
                      Edit
                    </a>
                    <span class="text-muted">|</span>
                    <a href="#" class="text-primary text-decoration-none" 
                       onclick="confirmDelete('<%= address._id %>')">
                      Remove
                    </a>
                  </div>
                </div>
              </div>
            </div>
          <% }); %>
        <% } %>
      </div>

      <!-- No Addresses Message -->
      <% if (!userAddress || userAddress.length === 0) { %>
        <div class="col-12 mt-4">
          <div class="text-center text-muted">
            <p>You haven't added any addresses yet.</p>
          </div>
        </div>
      <% } %>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this address? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteForm" method="POST" style="display: inline;">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function confirmDelete(addressId) {
  const deleteForm = document.getElementById('deleteForm');
  deleteForm.action = `/profile/addresses/delete/${addressId}`;
  
  const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
  deleteModal.show();
}
</script>

<%- include("../../views/partials/user/footer") %>
