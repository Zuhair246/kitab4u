<%- include('../../views/partials/user/header') %>
<link rel="stylesheet" href="../../styles/user/wallet.css">
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

<div class="container my-5">
  <div class="row">
    <!-- Sidebar (Desktop) -->
    <div class="col-md-4 d-none d-md-block">
      <%- include('../../views/partials/user/sidebar') %>
    </div>

    <!-- Sidebar Toggle Button (Mobile) -->
    <div class="d-block d-md-none mb-3">
      <button class="btn btn-outline-primary w-100" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas">
        <i class="bi bi-list"></i> Menu
      </button>
    </div>

    <!-- Offcanvas Sidebar (Mobile) -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas" aria-labelledby="sidebarOffcanvasLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="sidebarOffcanvasLabel">Your Account</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <%- include('../../views/partials/user/sidebar') %>
      </div>
    </div>

    <!-- Main Wallet Section -->
    <div class="col-md-8">
      <div class="card shadow-sm border-0 rounded p-4">
        <div class="card-body">
          <!-- Title -->
          <h3 class="fw-bold mb-4 text-center">My Wallet</h3>

          <!-- Wallet Balance & Add Money -->
          <div class="text-center mb-4">
            <div class="wallet-balance fs-4 fw-bold text-success mb-3">
              Current Balance: ₹<%= wallet.balance %>/-
            </div>
            <button class="btn btn-success px-4 py-2 rounded-pill" data-bs-toggle="modal" data-bs-target="#addMoneyModal">
              <i class="bi bi-plus-circle me-2"></i>Add Money
            </button>
          </div>

          <!-- Transaction Table -->
          <h5 class="fw-semibold mb-3">Recent Transactions</h5>
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead class="table-light">
                <tr>
                  <th>Type</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                <% if (paginatedTransactions.length > 0) { %>
                  <% paginatedTransactions.forEach(transaction => { %>
                    <tr>
                      <td><strong><%= transaction.transactionType %></strong></td>
                      <% if (transaction.transactionType === 'Credit') { %>
                        <td class="text-success fw-semibold">+₹<%= transaction.amount %></td>
                      <% } else { %>
                        <td class="text-danger fw-semibold">-₹<%= transaction.amount %></td>
                      <% } %>
                      <td><%= new Date(transaction.date).toLocaleDateString('en-IN') %></td>
                      <td><%= transaction.description %></td>
                    </tr>
                  <% }); %>
                <% } else { %>
                  <tr>
                    <td colspan="3" class="text-center py-4 text-muted">No transactions found.</td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <% if (totalPages > 1) { %>
            <nav aria-label="Page navigation example">
              <ul class="pagination justify-content-center mt-3">
                <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                  <a class="page-link" href="?page=<%= currentPage - 1 %>">&laquo;</a>
                </li>

                <% for (let i = 1; i <= totalPages; i++) { %>
                  <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                    <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                  </li>
                <% } %>

                <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                  <a class="page-link" href="?page=<%= currentPage + 1 %>">&raquo;</a>
                </li>
              </ul>
            </nav>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Add Money -->
<div class="modal fade" id="addMoneyModal" tabindex="-1" aria-labelledby="addMoneyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="addMoneyForm" method="POST" action="/wallet/addMoney">
        <div class="modal-header">
          <h5 class="modal-title" id="addMoneyModalLabel">Add Money to Wallet</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label for="amount" class="form-label">Enter Amount (₹)</label>
          <input type="text" name="amount" id="amount" class="form-control" min="1" placeholder="Enter amount" maxlength="4">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-wallet2 me-2"></i>Proceed to Pay
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<%- include('../../views/partials/user/footer') %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Razorpay Script Placeholder -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  document.getElementById("addMoneyForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const amount = document.getElementById("amount").value;
    
    const response = await fetch("/wallet/addMoney", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ amount })
    });
    
    const data = await response.json();

    if(!data.success){
      return Swal.fire({
        icon: 'error',
        title: 'Error!',
        text: data.message || "Something went wrong"
      })
    }
    
    const options = {
      key: data.key,
      amount: data.amount,
      currency: "INR",
      order_id: data.orderId,
      name: "Kitab4U Wallet",
      description: "Add Money to Wallet",
      handler: async function (response) {   
        const verifyRes = await fetch("/wallet/verifyPayment", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_signature: response.razorpay_signature,
                    amount: data.amount
                })
            });

            const verifyData = await verifyRes.json();
            if (verifyData.success) {
              return Swal.fire({
                icon: 'success',
                title: "Success",
                text: verifyData.message || "Money added to your walllet",
                timer: 1500,
                showConfirmButton: false,
              }).then(()=> window.location.reload());             
            } else {
                Swal.fire({
                  icon: 'error',
                  title: "Payment Failed!",
                  text: verifyData.message || "Payment verification failed"
                })
            }
      },
    };
    const rzp = new Razorpay(options);
    //Payment failure
    rzp.on("payment.failed", function (response) {
      Swal.fire({
        icon: 'error',
        title: "Payment Failed!",
        text: response.error.description || "Your payment couldn't be completed."
      })
    })
    rzp.open();
  });
</script>
