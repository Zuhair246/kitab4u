<%-include("../../views/partials/admin/header")%>

<!-- Main Content Area for Category Management -->
<div class="col-md-10">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
        <h2>Category Management</h2>
        <div class="d-flex gap-3">
            <div class="position-relative">
                <i class="fas fa-search position-absolute" style="left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d;"></i>
                <input type="text" class="form-control" placeholder="Search categories..." 
                       style="padding-left: 40px; width: 300px;" id="categorySearch" name="search" 
                       value="<%= typeof search !== 'undefined' ? search : '' %>" maxlength="15">
            </div>
                <button type="submit" class="btn btn-outline-primary ms-2" id="searchBtn">
                    Search
                </button>
            <% if (typeof search !== 'undefined' &&  search.trim() !== '') { %>
                <button class="btn btn-outline-secondary" onclick="clearSearch()">
                    <i class="fas fa-times"></i> Clear
                </button>
            <% } %>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                <i class="fas fa-plus"></i> Add Category
            </button>
        </div>
    </div>

    <!-- Category Table -->
    <div class="p-4">
        <div class="bg-white rounded-3 shadow-sm overflow-hidden">
            <table class="table table-hover mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="border-0 py-3 px-4 fw-semibold text-muted">Name</th>
                        <th class="border-0 py-3 px-4 fw-semibold text-muted">Description</th>
                        <th class="border-0 py-3 px-4 fw-semibold text-muted">Status</th>
                        <th class="border-0 py-3 px-4 fw-semibold text-muted">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (cat && cat.length > 0) { %>
                        <% cat.forEach((category) => { %>
                        <tr class="category-row">
                            <td class="py-3 px-4 border-0">
                                <div class="d-flex align-items-center">
                                    <div class="rounded-circle d-flex align-items-center justify-content-center text-white fw-bold me-3" 
                                         style="width: 40px; height: 40px; background-color: #6c757d;">
                                        <i class="fas fa-th"></i>
                                    </div>
                                    <span class="fw-medium"><%= category.name %></span>
                                </div>
                            </td>
                            <td class="py-3 px-4 border-0 text-muted">
                                <span class="text-truncate d-inline-block" style="max-width: 300px;" title="<%= category.description %>">
                                    <%= category.description %>
                                </span>
                            </td>
                            <td class="py-3 px-4 border-0">
                                <% if (category.isListed) { %>
                                    <span class="badge rounded-pill px-3 py-2" style="background-color: #d1f2eb; color: #00875a; font-size: 12px;">
                                        Active
                                    </span>
                                <% } else { %>
                                    <span class="badge rounded-pill px-3 py-2" style="background-color: #ffebee; color: #d32f2f; font-size: 12px;">
                                        Inactive
                                    </span>
                                <% } %>
                            </td>

                            <td class="py-3 px-4 border-0">
                                <button class="btn btn-sm me-2 d-inline-flex align-items-center justify-content-center" 
                                        style="width: 35px; height: 35px; background-color: #e3f2fd; color: #1976d2; border: none; border-radius: 8px;"
                                        onclick="editCategory('<%= category._id %>', '<%= category.name %>', '<%= category.description %>', '<%= category.isListed ? 'active' : 'inactive' %>')">
                                        <i class="fas fa-edit"></i>
                                </button>

                                <% if(category.isListed) {%>

                                <button class="btn btn-sm d-inline-flex align-items-center justify-content-center" 
                                        style="width: 35px; height: 35px; background-color: #ffebee; color: #d32f2f; border: none; border-radius: 8px;"
                                        onclick="deleteCategory('<%= category._id %>', '<%= category.name %>')"
                                        title="Delete Category">
                                    <i class="fas fa-trash"></i>
                                </button>

                                <%} else { %>

                                    <button class="btn btn-sm d-inline-flex align-items-center justify-content-center" 
                                        style="width: 35px; height: 35px; background-color: #ffebee; color: hwb(126 1% 66%); border: none; border-radius: 8px;"
                                        onclick="activateCategory('<%= category._id %>', '<%= category.name %>')"
                                        title="Activate Category">
                                    <i class="fa-solid fa-arrows-rotate"></i>
                                </button>

                                    <%}%>
                            </td>
                        </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="4" class="text-center py-5 text-muted">
                                <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                <h5>No categories found</h5>
                                <p>Start by adding your first category</p>
                            </td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
       <nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">
    <!-- Previous button -->
    <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
      <a class="page-link" href="/admin/category?page=<%= currentPage - 1 %>">Previous</a>
    </li>

    <!-- Page numbers -->
    <% for (let i = 1; i <= totalPages; i++) { %>
      <li class="page-item <%= currentPage === i ? 'active' : '' %>">
        <a class="page-link" href="/admin/category?page=<%= i %>"><%= i %></a>
      </li>
    <% } %>

    <!-- Next button -->
    <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
      <a class="page-link" href="/admin/category?page=<%= currentPage + 1 %>">Next</a>
    </li>
  </ul>
</nav>


<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="addCategoryModalLabel">Add New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="/admin/addCategory" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Category Name: </label>
                        <input type="text" class="form-control" id="categoryName" name="name" maxlength="15">
                    </div>
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label">Description:</label>
                        <textarea class="form-control" id="categoryDescription" name="description" rows="3" maxlength="1000"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="categoryStatus" class="form-label">Status:</label>
                        <select class="form-select" id="categoryStatus" name="status">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                    <p class="text-warning text-center">Verify everything before adding category and Category name can't be changed later</p>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="editCategoryModalLabel">Edit Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editCategoryForm" action="/admin/editCategory" method="POST">
        <input type="hidden" name="id" id="editCategoryId">
        <div class="modal-body">
          <!-- ðŸ”’ Locked Category Name -->
          <div class="mb-3 position-relative">
            <label for="editCategoryName" class="form-label">Category Name *</label>
            <input type="text" 
                   class="form-control pe-5" 
                   id="editCategoryName" 
                   name="name" 
                   readonly>
            <i class="fas fa-lock position-absolute" 
               style="right: 12px; top: 70%; transform: translateY(-50%); color: #6c757d;"></i>
          </div>

          <div class="mb-3">
            <label for="editCategoryDescription" class="form-label">Description:</label>
            <textarea class="form-control" id="editCategoryDescription" name="description" rows="3" maxlength="1000"></textarea>
          </div>
          <div class="mb-3">
            <label for="editCategoryStatus" class="form-label">Status</label>
            <select class="form-select" id="editCategoryStatus" name="status">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Category</button>
        </div>
      </form>
    </div>
  </div>
</div>


<%-include("../../views/partials/admin/footer")%>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// -------------------------
// ðŸ” Search functionality
// -------------------------

document.getElementById('searchBtn').addEventListener('click', performSearch);


function performSearch() {
    const searchTerm = document.getElementById('categorySearch').value;
    const currentUrl = new URL(window.location);

    if (searchTerm.trim()) {
        currentUrl.searchParams.set('search', searchTerm);
    } else {
        currentUrl.searchParams.delete('search');
    }
    currentUrl.searchParams.set('page', '1'); // Reset to first page
    window.location.href = currentUrl.toString();
}

function clearSearch() {
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.delete('search');
    currentUrl.searchParams.set('page', '1');
    window.location.href = currentUrl.toString();
}

// -------------------------
// âœï¸ Edit Category
// -------------------------
function editCategory(id, name, description, status) {
    document.getElementById('editCategoryId').value = id;
    document.getElementById('editCategoryName').value = name;
    document.getElementById('editCategoryDescription').value = description;
    document.getElementById('editCategoryStatus').value = status;

    const editModal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
    editModal.show();
}



// -------------------------
// ðŸ—‘ï¸ Delete Category (with SweetAlert2)
// -------------------------
function deleteCategory(id, name) {
    Swal.fire({
        title: `Unlist category: "${name}"?`,
        text: "This action cannot be undone.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: " Yes ",
        cancelButtonText: "Cancel"
    }).then((result) => {
        if (result.isConfirmed) {
            // Send delete request via form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin/deleteCategory`;

            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'id';
            idInput.value = id;

            form.appendChild(idInput);
            document.body.appendChild(form);
            form.submit();
        }
    });
}

// -------------------------
// ðŸ—‘ï¸ Activate Category (with SweetAlert2)
// -------------------------

function activateCategory(id, name) {
    Swal.fire({
        title: `Activate category: "${name}"?`,
        text: "This will make the category visible again.",
        icon: "question",
        showCancelButton: true,
        confirmButtonColor: "#28a745",
        cancelButtonColor: "#6c757d",
        confirmButtonText: "Yes, activate it!",
        cancelButtonText: "Cancel"
    }).then((result) => {
        if (result.isConfirmed) {
            // Send activate request via form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin/activateCategory`;

            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'id';
            idInput.value = id;

            form.appendChild(idInput);
            document.body.appendChild(form);
            form.submit();
        }
    });
}

// -------------------------
// âœ… Show Swal for success/error (from query params)
// -------------------------
document.addEventListener("DOMContentLoaded", function() {
    const urlParams = new URLSearchParams(window.location.search);
    const success = urlParams.get("success");
    const error = urlParams.get("error");

    if (success) {
        Swal.fire({
            icon: "success",
            title: "Success",
            text: success,
            confirmButtonColor: "#3085d6"
        }).then(() => {
            window.history.replaceState({}, document.title, window.location.pathname);
        });
    }

    if (error) {
        Swal.fire({
            icon: "error",
            title: "Error",
            text: error,
            confirmButtonColor: "#d33"
        }).then(() => {
            window.history.replaceState({}, document.title, window.location.pathname);
        });
    }
});

</script>