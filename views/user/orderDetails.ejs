<%- include('../../views/partials/user/header') %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<div class="container my-5">
  <h2 class="text-center mb-4 text-primary"><b><i>Order Details</i></b></h2>
  <div class="card shadow-sm">
    <div class="card-body">
      <strong>Order ID:</strong> <%= order.orderId %><br>
      <strong>Order Date:</strong> <%= order.orderDateFormatted %><br>
      <strong>Expected Delivery:</strong> <%= order.expectedDeliveryDateFormatted %>
      <hr>
<!-- Dynamic Progress Bar -->
<% if (order.status === 'Cancelled' || order.status === 'Cancel Requested') { %>
  <div class="text-center my-4">
    <h5 class="text-danger fw-bold">Order Cancelled</h5>
  </div>
<% } else { %>
  <% 
    // Include 'Returned' if the order is returned
    let stages = ['Order Placed','Packed','Shipped','Out for Delivery','Delivered'];
    if (['Return Requested', 'Returned'].includes(order.status)) {
      stages.push('Returned');
    }
  %>

  <div class="d-flex align-items-center mb-2">
    <% stages.forEach((stage, i) => { %>
      <div class="text-center position-relative flex-shrink-0 px-3">
        <i class="bi bi-stop-circle-fill <%= i <= order.statusIndex ? 'text-success' : 'text-secondary' %> fs-4"></i>
        <div class="small" style="color: <%= i <= order.statusIndex ? '#388e3c' : '#bdbdbd' %>"><%= stage %></div>
      </div>

      <% if (i < stages.length - 1) { %>
        <div class="flex-fill position-relative mx-2">
          <div class="position-absolute top-50 start-0 end-0 d-flex justify-content-center" style="transform: translateY(-50%);">
            <div class="w-100 <%= i < order.statusIndex ? 'bg-success' : 'bg-secondary' %> rounded" style="height: 2px;"></div>
          </div>
        </div>
      <% } %>
    <% }) %>
  </div>
<% } %>
<hr>

      <h5>Items</h5>
      <% order.items.forEach(item => { %>
        <div class="row align-items-center mb-2">
          <div class="col-auto">
            <img src="<%= item.image %>" style="width:60px;height:80px;object-fit:cover;" class="rounded">
          </div>
          <div class="col">
            <div><strong><%= item.name %></strong></div>
            <span class="badge bg-dark"><%= item.coverType %></span>
            <div class="small">Qty: <%= item.quantity %></div>
          </div>
          <div class="col-auto text-end fs-5 fw-bold">₹ <%= item.totalPrice %>/-</div>
        </div>
      <% }) %>
      <hr>
      <h5>Delivery Address</h5>
      <div class="border rounded p-3 mb-4">
        <strong><%= order.address.name %></strong> (<%= order.address.addressType %>)<br>
        <%= order.address.phone %><br>
        <%= order.address.streetAddress %>, <%= order.address.city %>, <%= order.address.state %> - <%= order.address.pinCode %>
      </div>
      <div class="row mb-2">
        <div class="col">Subtotal:</div>
        <div class="col text-end">₹ <%= order.subtotal %>/-</div>
      </div>
      <div class="row mb-2">
        <div class="col">Delivery Charge:</div>
        <div class="col text-end">₹ <%= order.shippingCharge %>/-</div>
      </div>
      <div class="row mb-2">
        <div class="col">Discount:</div>
        <div class="col text-end text-success">-₹ <%= order.discount %>/-</div>
      </div>
      <div class="row border-top pt-2">
        <div class="col fw-bold">Total:</div>
        <div class="col text-end fw-bold">₹ <%= order.finalAmount %>/-</div>
      </div>
    </div>
      <div class="mt-3 text-center">
            <% if(order.canCancel) { %>
              <form action="/myOrders/<%= order._id %>/cancel" method="post"><button class="btn btn-danger btn" id="cancelBtn">Cancel Order</button></form>
            <% } %>
            <% if(order.canReturn) { %>
              <form action="/myOrders/<%= order._id %>/return" method="post"><button class="btn btn-dark btn" id="returnBtn">Return</button></form>
            <% } %>
          </div>
  </div>
</div>
<%- include('../../views/partials/user/footer') %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const cancelBtn = document.getElementById('cancelBtn');
    const returnBtn = document.getElementById('returnBtn');

    // Handle Cancel
    if (cancelBtn) {
      cancelBtn.addEventListener('click', async (e) => {
        e.preventDefault(); // prevent form submission

        const confirm = await Swal.fire({
          title: 'Cancel this order?',
          text: 'This action cannot be undone.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Yes, cancel it!',
          cancelButtonText: 'No, keep it',
        });

        if (confirm.isConfirmed) {
          Swal.showLoading(); // show spinner
          try {
            const res = await fetch(`/myOrders/<%= order._id %>/cancel`, { method: 'POST' });
            const data = await res.json();
            Swal.fire({
              icon: data.success ? 'success' : 'error',
              title: data.success ? 'Cancelled!' : 'Oops...',
              text: data.message,
              timer: 2000,
              showConfirmButton: false
            });
            if (data.success) setTimeout(() => location.reload(), 2000);
          } catch (err) {
            Swal.fire('Error', 'Something went wrong while cancelling!', 'error');
          }
        }
      });
    }

    // Handle Return
    if (returnBtn) {
      returnBtn.addEventListener('click', async (e) => {
        e.preventDefault();

        const confirm = await Swal.fire({
          title: 'Return this order?',
          text: 'You can only return within 14 days of delivery.',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Yes, return it!',
          cancelButtonText: 'No, keep it',
        });

        if (confirm.isConfirmed) {
          Swal.showLoading();
          try {
            const res = await fetch(`/myOrders/<%= order._id %>/return`, { method: 'POST' });
            const data = await res.json();
            Swal.fire({
              icon: data.success ? 'success' : 'error',
              title: data.success ? 'Return Requested!' : 'Oops...',
              text: data.message,
              timer: 2000,
              showConfirmButton: false
            });
            if (data.success) setTimeout(() => location.reload(), 2000);
          } catch (err) {
            Swal.fire('Error', 'Something went wrong while returning!', 'error');
          }
        }
      });
    }
  });
</script>
