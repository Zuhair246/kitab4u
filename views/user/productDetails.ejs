<link rel="stylesheet" href="../../styles/user/productDetails.css">
<!-- <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"> -->
<%- include("../../views/partials/user/header") %>

<div class="container my-5">

  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">Home</a></li>
      <li class="breadcrumb-item"><a href="/shop">Shop</a></li>
      <li class="breadcrumb-item active" aria-current="page"><%= product.name %></li>
    </ol>
  </nav>

  <div class="row g-5">
    <!-- Left: Images -->
    <div class="col-md-5">
      <div class="border p-3 mb-3 position-relative">
        <img id="mainImage"
             src="<%= (product.images && product.images.length > 0) ? product.images[0] : '/placeholder.svg?height=600&width=400' %>"
             alt="<%= product.name %>"
             class="img-fluid w-100"
             style="cursor: zoom-in; object-fit: cover;">
      </div>

      <div class="d-flex gap-2">
        <% product.images.forEach((img) => { %>
          <img src="<%= img %>"
               alt="thumbnail"
               class="img-thumbnail"
               style="width: 70px; height: 100px; object-fit: cover; cursor: pointer;"
               onclick="document.getElementById('mainImage').src=this.src">
        <% }) %>
      </div>
    </div>

   <!-- Right: Details -->
<div class="col-md-7">
  <div class="row">

    <!-- LEFT SIDE CONTENT -->
    <div class="col-md-8">

      <h2><%= product.name %></h2>
      <h5 class="text-muted mb-3"><%= product.author %></h5>

      <!-- Price & Discount -->
      <div id="priceSection" class="mb-3">
        <% const variant = product.variants && product.variants[0]; %>
        <% if(variant){ %>
          <% if(variant.discountPercentage > 0 && variant.finalPrice < variant.discountPrice){ %>
            <span class="fs-4 fw-bold text-danger">â‚¹<%= variant.finalPrice %>/-</span>
            <span class="text-muted text-decoration-line-through ms-2">â‚¹<%= variant.discountPrice %>/-</span>
            <span class="badge bg-success ms-2"><%= variant.discountPercentage %>% OFF</span>
          <% } else if(variant.discountPrice && variant.discountPrice < variant.originalPrice){ %>
            <span class="fs-4 fw-bold text-danger">â‚¹<%= variant.discountPrice %>/-</span>
            <span class="text-muted text-decoration-line-through ms-2">â‚¹<%= variant.originalPrice %>/-</span>
            <span class="badge bg-success ms-2">
              Save â‚¹<%= variant.originalPrice - variant.discountPrice %>/-
            </span>
          <% } else { %>
            <span class="fs-4 fw-bold">â‚¹<%= variant.originalPrice %>/-</span>
          <% } %>
        <% } %>
      </div>

      <!-- Stock -->
      <% if(product.variants.some(v => v.stock > 0)) { %>
        <span class="badge bg-success mb-3">In Stock</span>
      <% } else { %>
        <span class="badge bg-danger mb-3">Out of Stock</span>
      <% } %>

      <!-- Book Info -->
      <ul class="list-unstyled mb-3">
        <li><strong>Publisher:</strong> <%= product.publisher %></li>
        <li><strong>Cover Type:</strong>
          <% product.variants.forEach((variant) => { %>
            <button class="btn btn-sm btn-outline-primary me-2 variant-btn"
              data-original="<%= variant.originalPrice %>"
              data-discount="<%= variant.discountPrice %>"
              data-offer="<%= variant.discountPercentage %>"
              data-final="<%= variant.finalPrice %>"
              data-stock="<%= variant.stock %>"
              data-variantid="<%= variant._id %>">
              <%= variant.coverType %>
            </button>
          <% }) %>
        </li>
        <li><strong>Pages:</strong> <%= product.pages %></li>
      </ul>

      <!-- Delivery -->
      <p class="mb-3">
        <i class="bi bi-box-seam"></i> Free Shipping & Returns on orders over â‚¹500
      </p>

      <!-- Actions -->
      <div class="d-flex align-items-center gap-3 mb-4">
        <button
          type="button"
          class="btn btn-primary px-4 add-to-cart-btn"
          data-product-id="<%= product._id %>"
          data-variant-id="<%= product.variants[0]._id %>"
          <%= quantity <= 0 ? 'disabled' : '' %>>
          <i class="bi bi-cart-plus me-2"></i>Add to Cart
        </button>

        <form action="/wishlist" method="post">
          <input type="hidden" name="productId" value="<%= product._id %>">
          <input type="hidden" name="variantId" value="<%= variant._id %>">
        <button class="btn" type="submit"
                title="<%= wishlistItems.includes(product._id.toString()) ? 'Remove from Wishlist' : 'Add to Wishlist' %>">
          <i class="bi <%= wishlistItems.includes(product._id.toString()) ? 'bi-heart-fill' : 'bi-heart' %> fs-4 text-danger"
            style="font-size: 1rem; width: 1rem; height: 1rem; display: inline-flex; align-items: center; justify-content: center;"></i>
        </button>
        </form>
      </div>
    </div>

<!-- RIGHT SIDE: CUSTOMER REVIEWS (BORDERED) -->
<div class="col-md-4">
  <div class="border rounded-3 p-5 shadow bg-white">

    <h6 class="mb-3 text-secondary text-nowrap fw-semibold">Customer Reviews</h6>

    <div id="previewReviews"></div>

    <button
      id="showMoreBtn"
      class="btn btn-sm btn-outline-primary w-100 mt-2 d-none"
      data-bs-toggle="modal"
      data-bs-target="#reviewsModal">
      Show more reviews
    </button>

  </div>
</div>

  </div>
</div>
  </div>

  <!-- Description & Ratings -->
  <div class="row mt-5">
    <div class="col-md-8 col-lg-12">
      <h4>Description</h4>
      <p><%= product.description %></p>
    </div>
  </div>

  <!-- Similar Products -->
  <div class="mt-5">
    <h4>Similar Books</h4>
    <div class="row g-4">
      <% similarProducts.forEach(book => { %>
        <div class="col-md-3 col-sm-6">
          <div class="card h-100 border-0 shadow-sm">
            <a href="/productDetails?id=<%= book._id %>" style="aspect-ratio: 2/3;" class="d-block">
              <img src="<%= (book.images && book.images[0]) ? book.images[0] : '/placeholder.svg?height=600&width=400' %>"
                   class="card-img-top object-fit-cover w-100 h-100"
                   style="object-fit: cover;">
            </a>
            <div class="card-body">
              <h6 class="card-title"><%= book.name %></h6>
              <p class="text-muted"><%= book.author %></p>
              <span class="fw-bold">â‚¹<%= (book.variants && book.variants[0] && book.variants[0].discountPrice) || (book.variants && book.variants[0].originalPrice) %></span>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  </div>


  <!-- REVIEWS MODAL -->
  <div class="modal fade" id="reviewsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">All Reviews</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div id="modalReviews"></div>

        <button
          id="loadMoreModal"
          class="btn btn-outline-primary w-100 mt-3">
          Load more
        </button>
      </div>

    </div>
  </div>
</div>

</div>



<%- include("../../views/partials/user/footer") %>

<!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script> -->
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
 // ðŸ” Image Zoom Script
  const mainImage = document.getElementById('mainImage');
  if (mainImage) {
    mainImage.addEventListener('mousemove', function(e) {
      const { left, top, width, height } = this.getBoundingClientRect();
      const x = ((e.pageX - left) / width) * 100;
      const y = ((e.pageY - top) / height) * 100;
      this.style.transformOrigin = `${x}% ${y}%`;
      this.style.transform = "scale(1.5)";
    });

    mainImage.addEventListener('mouseleave', function() {
      this.style.transformOrigin = "center";
      this.style.transform = "scale(1)";
    });
  }

 function updateVariant(button) {
  const original = Number(button.dataset.original);
  const discount = Number(button.dataset.discount);
  const final = Number(button.dataset.final);
  const offer = Number(button.dataset.offer);
  const stock = Number(button.dataset.stock);
  const variantId = button.dataset.variantid;

  /* ================= PRICE SECTION ================= */
  const priceSection = document.getElementById('priceSection');
  priceSection.innerHTML = '';

  if (offer > 0 && final < discount) {
    priceSection.innerHTML = `
      <span class="fs-4 fw-bold text-danger">â‚¹${final}/-</span>
      <span class="text-muted text-decoration-line-through ms-2">â‚¹${discount}/-</span>
      <span class="badge bg-success ms-2">${offer}% OFF</span>
    `;
  } else if (discount && discount < original) {
    priceSection.innerHTML = `
      <span class="fs-4 fw-bold text-danger">â‚¹${discount}/-</span>
      <span class="text-muted text-decoration-line-through ms-2">â‚¹${original}/-</span>
      <span class="badge bg-success ms-2">Save â‚¹${original - discount}/-</span>
    `;
  } else {
    priceSection.innerHTML = `
      <span class="fs-4 fw-bold">â‚¹${original}/-</span>
    `;
  }

  /* ================= STOCK BADGE ================= */
  const stockBadge = document.querySelector('.badge.mb-3');
  const addToCartBtn = document.querySelector('.add-to-cart-btn');

  if (stock > 0) {
    stockBadge.className = "badge bg-success mb-3";
    stockBadge.textContent = "In Stock";
    addToCartBtn.disabled = false;
  } else {
    stockBadge.className = "badge bg-danger mb-3";
    stockBadge.textContent = "Out of Stock";
    addToCartBtn.disabled = true;
  }

  /* ================= VARIANT ID UPDATE ================= */

  // for hidden input (wishlist / fallback)
  const hiddenVariantInput = document.getElementById('variantId');
  if (hiddenVariantInput) {
    hiddenVariantInput.value = variantId;
  }

  // â­ IMPORTANT: for AJAX add-to-cart
  addToCartBtn.dataset.variantId = variantId;

  /* ================= ACTIVE BUTTON UI ================= */
  document.querySelectorAll('.variant-btn').forEach(btn =>
    btn.classList.remove('active')
  );
  button.classList.add('active');
}

  document.querySelectorAll('.variant-btn').forEach((button) => {
    button.addEventListener('click', function() {
      updateVariant(this);
    });
  });

  const firstVariant = document.querySelector('.variant-btn');
  if (firstVariant) {
    updateVariant(firstVariant);
  }

  document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".add-to-cart-btn");
  if (!btn) return;

  try {
    const res = await fetch("/cart", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        productId: btn.dataset.productId,
        variantId: btn.dataset.variantId
      })
    });

    const data = await res.json();

    if (res.ok && data.success) {
      return Swal.fire({
        icon: "success",
        title: "Added to cart",
        text: data.message,
        timer: 1500,
        showConfirmButton: false
      });
    }

    Swal.fire({
      icon: "error",
      title: "Oops!",
      text: data.message
    });

  } catch {
    Swal.fire({
      icon: "error",
      title: "Server error",
      text: "Please try again"
    });
  }
});
//-------Reviews-----------
  const productId = "<%= product._id %>";
  let page = 1;
  let modalPage = 1;

  // Load first 3 reviews (right side)
  async function loadPreviewReviews() {
    const res = await fetch(`/reviews/${productId}?page=1`);
    const data = await res.json();

    if (!data.success || data.reviews.length === 0) {
      document.getElementById("previewReviews").innerHTML =
        `<p class="text-muted small mb-0">No reviews yet</p>`;
      return;
    }

    data.reviews.forEach(r => {
      document.getElementById("previewReviews").innerHTML += renderReview(r);
    });

    if (data.hasMore) {
      document.getElementById("showMoreBtn").classList.remove("d-none");
    }
  }

  //  Load modal reviews
  async function loadModalReviews() {
    const res = await fetch(`/reviews/${productId}?page=${modalPage}`);
    const data = await res.json();

    data.reviews.forEach(r => {
      document.getElementById("modalReviews").innerHTML += renderReview(r, true);
    });

    if (!data.hasMore) {
      document.getElementById("loadMoreModal").style.display = "none";
    }

    modalPage++;
  }

  //  Review UI renderer
  function renderReview(review, showDate = false) {
    let stars = "";
    for (let i = 1; i <= 5; i++) {
      stars += i <= review.rating
        ? `<i class="bi bi-star-fill text-warning"></i>`
        : `<i class="bi bi-star text-warning"></i>`;
    }

    return `
      <div class="border rounded p-2 mb-2 small bg-light">
        <div class="mb-1">${stars}</div>
        <p class="mb-1 text-muted">${review.comment}</p>
        <small class="text-secondary">
          â€” ${review.userId.name}
          ${showDate ? " â€¢ " + new Date(review.createdAt).toLocaleDateString() : ""}
        </small>
      </div>
    `;
  }

  // Initial load
  loadPreviewReviews();

  // Modal load
  document.getElementById("reviewsModal")
    .addEventListener("shown.bs.modal", () => {
      if (modalPage === 1) loadModalReviews();
    });

  document.getElementById("loadMoreModal")
    .addEventListener("click", loadModalReviews);

</script>
