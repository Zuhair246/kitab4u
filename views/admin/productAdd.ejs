<%-include("../../views/partials/admin/header")%>
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
</head>

<!-- Main Content Area for Add Product -->
<div class="col-md-10">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
        <h2><%= typeof product !== 'undefined' ? 'Edit Product' : 'Add Product' %></h2>
        <button class="btn btn-outline-secondary" onclick="window.location.href='/admin/listProducts'">
            <i class="fas fa-arrow-left me-2"></i>Back to Products
        </button>
    </div>

    <!-- Product Form -->
    <div class="p-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="bg-white rounded-3 shadow-sm p-4">
                    <form id="productForm" action="<%= typeof product !== 'undefined' ? `/admin/editProduct/${product._id}` : '/admin/addProducts' %>" 
                          method="POST" enctype="multipart/form-data">
                        
                        <!-- Book Name -->
                        <div class="mb-4">
                            <label for="bookName" class="form-label fw-semibold">Book Name *</label>
                            <input type="text" class="form-control form-control-lg" id="bookName" name="name" 
                                   placeholder="eg: Atomic Habits" 
                                   value="<%= typeof product !== 'undefined' ? product.name : '' %>" maxlength="50">
                        </div>

                        <!-- Author -->
                        <div class="mb-4">
                            <label for="author" class="form-label fw-semibold">Author *</label>
                            <input type="text" class="form-control form-control-lg" id="author" name="author" 
                                   placeholder="eg: James Clear" 
                                   value="<%= typeof product !== 'undefined' ? product.author : '' %>" maxlength="50">
                        </div>

                        <!-- Publisher -->
                        <div class="mb-4">
                            <label for="publisher" class="form-label fw-semibold">Publisher *</label>
                            <input type="text" class="form-control form-control-lg" id="publisher" name="publisher" 
                                   placeholder="Book Publisher" 
                                   value="<%= typeof product !== 'undefined' ? product.publisher : '' %>" maxlength="50">
                        </div>

                        <!-- Book Description -->
                        <div class="mb-4">
                            <label for="bookDescription" class="form-label fw-semibold">Book Description *</label>
                            <textarea class="form-control" id="bookDescription" name="description" rows="4" 
                                      placeholder="Write your description here..." maxlength="1000"><%= typeof product !== 'undefined' ? product.description : '' %></textarea>
                        </div>

                        <!-- Product Images -->
                        <div class="mb-4">
                            <label for="images" class="form-label fw-semibold">Product Images (Minimum 3 - upload one at a time, crop, and save each) *</label>
                            <input type="file" class="form-control" id="images" accept="image/*" name="images">
                            <div id="cropContainer" class="mt-3"></div>
                            <div id="previewContainer" class="row g-3 mt-3"></div>
                        </div>
                        <button type="button" class="btn btn-primary mt-2" onclick="saveCroppedImage()">Save Cropped Image</button>

                        <% if (typeof product !== 'undefined' && product.images && product.images.length > 0) { %>
                            <div class="mb-4">
                                <label class="form-label fw-semibold">Existing Images</label>
                                <div class="row g-3">
                                    <% product.images.forEach((img, i) => { %>
                                        <div class="col-md-4">
                                            <img src="<%= img %>" alt="Existing Image" class="img-fluid rounded" style="max-height: 200px;">
                                            <input type="hidden" name="existingImages[]" value="<%= img %>">
                                        </div>
                                    <% }); %>
                                </div>
                            </div>
                        <% } %>

                        <!-- Category and Pages Selection in the same row -->
                        <div class="row g-3 mb-4">
                            <!-- Category -->
                            <div class="col-md-6">
                                <label for="categoryId" class="form-label fw-semibold">Category *</label>
                                <select class="form-select" id="categoryId" name="categoryId">
                                <% for (let i = 0; i < cat.length; i++) { %>
                                    <option value="<%= cat[i]._id %>"
                                    <%= typeof product !== 'undefined' && product.categoryId && product.categoryId.toString() === cat[i]._id.toString() ? 'selected' : '' %>>
                                    <%= cat[i].name %>
                                    </option>
                                <% } %>
                                </select>
                            </div>

                            <!-- Pages (right side of Category) -->
                            <div class="col-md-6">
                                <label for="pages" class="form-label fw-semibold">Pages *</label>
                                <input 
                                type="number" 
                                class="form-control" 
                                id="pages" 
                                name="pages" 
                                placeholder="Total Pages"
                                min="1"
                                value="<%= typeof product !== 'undefined' ? product.pages : '' %>" maxlength="4" pattern="[0-9]{4}">
                            </div>
                        </div>

                        <!-- Cover Types Below -->
                        <div class="row g-3 mb-4">
                        <div class="col-md-12 mb-4">
                            <label class="form-label fw-bold">Cover Types *</label>
                            <div id="coverTypeContainer"></div>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addCoverType()">+ Add Cover Type</button>
                        </div>
                        </div>



                        <!-- Listed Status -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isListed" name="isListed" value="true"
                                       <%= typeof product === 'undefined' || !product.isBlocked ? 'checked' : '' %>>
                                <label class="form-check-label fw-semibold" for="isListed">
                                    List this product (make it visible to customers)
                                </label>
                            </div>
                        </div>
                        <!-- Form Actions -->
                        <div class="d-flex gap-3 justify-content-end">
                            <button type="button" class="btn btn-outline-secondary px-4" onclick="window.location.href='/admin/listProducts'">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-dark px-4" id="submitBtn">
                                <i class="fas fa-save me-2"></i>
                                <%= typeof product !== 'undefined' ? 'Update Product' : 'Save Product' %>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<%-include("../../views/partials/admin/footer")%>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
let coverTypeIndex = 0;
let croppedImages = [];
let cropper;

/* ---------------- COVER TYPE ---------------- */
function addCoverType(existing = null) {
  const container = document.getElementById("coverTypeContainer");
  const index = coverTypeIndex++;

  const div = document.createElement("div");
  div.className = "border rounded-3 p-3 mb-3 bg-light";

  div.innerHTML = `
    <div class="d-flex justify-content-between mb-2">
      <span>Cover type</span>
      <span>Original</span>
      <span>Discount</span>
      <span>Stock</span>
      <button type="button" class="btn btn-sm btn-danger"
        onclick="this.closest('.border').remove()">Remove</button>
    </div>

    <div class="row g-3">
      <div class="col-md-3">
        <input class="form-control" name="variants[${index}][coverType]"
          value="${existing?.coverType || ''}">
      </div>
      <div class="col-md-3">
        <input type="number" class="form-control"
          name="variants[${index}][originalPrice]"
          value="${existing?.originalPrice || ''}">
      </div>
      <div class="col-md-3">
        <input type="number" class="form-control"
          name="variants[${index}][discountPrice]"
          value="${existing?.discountPrice || ''}">
      </div>
      <div class="col-md-2">
        <input type="number" class="form-control"
          name="variants[${index}][stock]"
          value="${existing?.stock || ''}">
      </div>
    </div>
  `;

  container.appendChild(div);
}

/* ---------- PREFILL ---------- */
<% if (typeof product !== 'undefined' && product.variants) { %>
  <% product.variants.forEach(v => { %>
    addCoverType(<%- JSON.stringify(v) %>);
  <% }) %>
<% } %>

/* ---------------- IMAGE CROP ---------------- */
document.getElementById("images").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = ev => {
    document.getElementById("cropContainer").innerHTML =
      `<img id="cropImage" src="${ev.target.result}" style="max-width:100%;">`;

    cropper = new Cropper(document.getElementById("cropImage"), {
      aspectRatio: 2 / 3,
      viewMode: 1
    });
  };
  reader.readAsDataURL(file);
});

function saveCroppedImage() {
  if (!cropper) return;

  cropper.getCroppedCanvas({ width: 400, height: 600 })
    .toBlob(blob => {
      croppedImages.push(blob);

      const index = croppedImages.length - 1;
      const preview = document.getElementById("previewContainer");

      const div = document.createElement("div");
      div.className = "col-md-4 position-relative";
      div.dataset.index = index;

      div.innerHTML = `
        <img src="${URL.createObjectURL(blob)}" class="img-fluid rounded">
        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1"
          onclick="removeCroppedImage(this)">Ã—</button>
      `;

      preview.appendChild(div);

      cropper.destroy();
      cropper = null;
      document.getElementById("cropContainer").innerHTML = "";
      document.getElementById("images").value = "";
    });
}

function removeCroppedImage(btn) {
  const div = btn.closest("[data-index]");
  const index = Number(div.dataset.index);

  croppedImages.splice(index, 1);
  div.remove();

  // Re-sync indexes
  document.querySelectorAll("[data-index]").forEach((el, i) => {
    el.dataset.index = i;
  });
}

/* ---------------- SUBMIT ---------------- */
document.getElementById("productForm").addEventListener("submit", e => {
  e.preventDefault();

  const formData = new FormData(e.target);
  formData.delete("images");

  croppedImages.forEach((blob, i) => {
    formData.append("images", blob, `image${i}.jpg`);
  });

  fetch(e.target.action, { method: "POST", body: formData })
    .then(res => res.json().then(data => ({ ok: res.ok, data })))
    .then(({ ok, data }) => {
      if (!ok) throw data;

      Swal.fire({
        icon: "success",
        title: "Success",
        text: data.message,
        timer: 1500,
        showConfirmButton: false
      }).then(() => {
        if (data.redirect) location.href = data.redirect;
      });
    })
    .catch(err => {
      Swal.fire({
        icon: "error",
        title: "Error",
        text: err?.message || "Something went wrong"
      });
    });
});
</script>
