<%- include("../../views/partials/user/header") %>

<div class="container my-5">
  <div class="row">
   <!-- Sidebar (Desktop) -->
    <div class="col-md-4 d-none d-md-block">
      <%- include("../../views/partials/user/sidebar") %>
    </div>

    <!-- Sidebar Toggle Button (Mobile) -->
    <div class="d-block d-md-none mb-3">
      <button class="btn btn-outline-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas" aria-controls="sidebarOffcanvas">
        <i class="bi bi-list"></i> Menu
      </button>
    </div>

    <!-- Offcanvas Sidebar (Mobile) -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas" aria-labelledby="sidebarOffcanvasLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="sidebarOffcanvasLabel">Your Account</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <%- include("../../views/partials/user/sidebar") %>
      </div>
    </div>
    
    <!-- Main Body -->
    <div class="col-md-8">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/profile" class="text-decoration-none">Your Account</a></li>
          <li class="breadcrumb-item active" aria-current="page">Your Addresses</li>
        </ol>
      </nav>

      <h2 class="mb-4">Your Addresses</h2>

      <!-- Flash Messages -->
      <% if (error && error.length > 0) { %>
        <div class="alert alert-danger" role="alert">
          <% error.forEach(function(msg) { %>
            <p class="mb-0"><%= msg %></p>
          <% }); %>
        </div>
      <% } %>

      <% if (success && success.length > 0) { %>
        <div class="alert alert-success" role="alert">
          <% success.forEach(function(msg) { %>
            <p class="mb-0"><%= msg %></p>
          <% }); %>
        </div>
      <% } %>

      <div class="row g-4">
        <!-- Add Address Card -->
        <div class="col-md-6">
          <div class="card h-100 border-2 border-dashed border-secondary">
            <div class="card-body d-flex flex-column justify-content-center align-items-center text-center py-5">
              <div class="mb-3">
                <i class="fas fa-plus display-1 text-muted"></i>
              </div>
              <h5 class="text-muted mb-3">Add address</h5>
              <a href="/profile/address/add" class="btn btn-outline-primary">Add New Address</a>
            </div>
          </div>
        </div>

        <!-- Existing Addresses -->
        <% if (userAddress && userAddress.length > 0) { %>
          <% userAddress.forEach(function(address, index) { %>
            <div class="col-md-6">
              <div class="card h-100 shadow-sm">
                <div class="card-body">

                                  <!-- Pagination -->
                <% if (totalPages > 1) { %>
                  <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center mt-4">

                      <!-- Previous Button -->
                      <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                        <a class="page-link" href="/profile/address?page=<%= currentPage - 1 %>">Previous</a>
                      </li>

                      <!-- Page Numbers -->
                      <% for (let i = 1; i <= totalPages; i++) { %>
                        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                          <a class="page-link" href="/profile/address?page=<%= i %>"><%= i %></a>
                        </li>
                      <% } %>

                      <!-- Next Button -->
                      <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                        <a class="page-link" href="/profile/address?page=<%= currentPage + 1 %>">Next</a>
                      </li>

                    </ul>
                  </nav>
                <% } %>

                  <!-- Default Badge -->
                  <% if (address.isDefault) { %>
                    <div class="mb-2">
                      <span class="badge bg-success text-light">Default: <strong>Address</strong></span>
                    </div>
                  <% } %>

                  <!-- Address Details -->
                  <div class="address-details">
                    <h6 class="fw-bold mb-2"><%= address.name %></h6>
                    
                    <div class="text-muted mb-2">
                      <% if (address.landMark) { %>
                        <%= address.landMark %>,<br>
                      <% } %>
                      <%= address.streetAddress %><br>
                      <%= address.city %><br>
                      <%= address.state %> <%= address.pinCode %><br>
                      India
                    </div>

                    <div class="mb-2">
                      <strong>Phone number:</strong> <%= address.phone %>
                      <% if (address.altPhone) { %>
                        <br>Alt. Phone: <%= address.altPhone %>
                      <% } %>
                    </div>

                    <% if (address.addressType) { %>
                      <div class="mb-3">
                        <small class="text-muted">Type: <%= address.addressType %></small>
                      </div>
                    <% } %>

                  </div>

                  <!-- Action Buttons -->
                  <div class="d-flex gap-3">
                  <!-- Edit Button triggers modal -->
                  <a href="javascript:void(0)" 
                    class="text-primary text-decoration-none" 
                    data-bs-toggle="modal" 
                    data-bs-target="#editAddressModal-<%= address._id %>">
                    Edit
                  </a>
                    <span class="text-muted">|</span>
                    <a href="javascript:void(0)" class="text-danger text-decoration-none" 
                      onclick="deleteAddress('<%= address._id %>', '<%= address.name %>')">
                      Remove
                    </a>

                  </div>
                </div>
              </div>

                <!-- Edit Address Modal -->
  <div class="modal fade" id="editAddressModal-<%= address._id %>" tabindex="-1" aria-labelledby="editAddressLabel-<%= address._id %>" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form action="/profile/address/edit/<%= address._id %>" method="POST" class="row g-3">
          <div class="modal-header">
            <h5 class="modal-title" id="editAddressLabel-<%= address._id %>">Edit Address</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <!-- Name -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Name</label>
              <input type="text" name="name" class="form-control" value="<%= address.name %>" >
            </div>

            <!-- City -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">City</label>
              <input type="text" name="city" class="form-control" value="<%= address.city %>" >
            </div>

            <!-- Street Address -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Street address</label>
              <input type="text" name="streetAddress" class="form-control" value="<%= address.streetAddress %>">
            </div>

            <!-- State -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">State</label>
              <input type="text" name="state" class="form-control" value="<%= address.state %>">
            </div>

            <!-- Pin Code -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Pin Code</label>
              <input type="text" name="pinCode" class="form-control" value="<%= address.pinCode %>" maxlength="6" pattern="[0-9]{6}" >
            </div>

            <!-- Phone -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Phone</label>
              <input type="text" name="phone" class="form-control" value="<%= address.phone %>" maxlength="10" pattern="[0-9]{10}" >
            </div>

            <!-- Alternative Phone -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Alternative Phone</label>
              <input type="text" name="altPhone" class="form-control" value="<%= address.altPhone %>" maxlength="10" pattern="[0-9]{10}">
            </div>

            <!-- Address Type -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Address Type</label>
              <select name="addressType" class="form-select">
                <option value="Home" <%= address.addressType === 'Home' ? 'selected' : '' %>>Home</option>
                <option value="Work" <%= address.addressType === 'Work' ? 'selected' : '' %>>Work</option>
                <option value="Other" <%= address.addressType === 'Other' ? 'selected' : '' %>>Other</option>
              </select>
            </div>

            <!-- Default Address -->
            <div class="col-md-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="isDefault" <%= address.isDefault ? 'checked' : '' %>>
                <label class="form-check-label">Set as default address</label>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

            </div>
          <% }); %>
        <% } %>
      </div>

      <!-- No Addresses Message -->
      <% if (!userAddress || userAddress.length === 0) { %>
        <div class="col-12 mt-4">
          <div class="text-center text-muted">
            <p>You haven't added any addresses yet.</p>
          </div>
        </div>
      <% } %>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this address? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteForm" method="POST" style="display: inline;">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function deleteAddress(id, name) {
    Swal.fire({
        title: `Delete address for "${name}"?`,
        text: "This action cannot be undone.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "Yes, delete it",
        cancelButtonText: "Cancel"
    }).then((result) => {
        if (result.isConfirmed) {
            // Create a hidden form and submit
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/profile/address/delete`;

            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'id';
            idInput.value = id;

            form.appendChild(idInput);
            document.body.appendChild(form);
            form.submit();
        }
    });
}

// âœ… Show success/error messages as alerts
document.addEventListener("DOMContentLoaded", function() {
    const urlParams = new URLSearchParams(window.location.search);
    const success = urlParams.get("success");
    const error = urlParams.get("error");

    if (success) {
        Swal.fire({
            icon: "success",
            title: "Success",
            text: success,
            confirmButtonColor: "#3085d6"
        }).then(() => {
            window.history.replaceState({}, document.title, window.location.pathname);
        });
    }

    if (error) {
        Swal.fire({
            icon: "error",
            title: "Error",
            text: error,
            confirmButtonColor: "#d33"
        }).then(() => {
            window.history.replaceState({}, document.title, window.location.pathname);
        });
    }
});
</script>

<%- include("../../views/partials/user/footer") %>
