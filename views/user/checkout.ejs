<%- include("../../views/partials/user/header") %>
<link rel="stylesheet" href="../../styles/user/checkout.css">
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

<div class="container py-5">
  <form id="checkoutForm" action="/orders" method="post" novalidate>
    <div class="row justify-content-center">
      <!-- Address Selection (Right) -->
      <div class="col-lg-7 mb-4 order-lg-1">
        <div class="bg-white p-4 rounded shadow-sm">
          <h4 class="mb-4"> Select Delivery Address:</h4>

          <div id="addressList" class="mb-3">
            <% if(addresses && addresses.length > 0) { %>
              <% addresses.forEach((address, index) => { %>
                <div class="address-card border rounded p-3 mb-3 position-relative" style="border-width:2px; border-color:#edc2ba; border-style:solid;" data-address-id="<%= address._id %>">
                  <div>
                    <input type="radio" name="selectedAddressId" 
                           value="<%= address._id %>" 
                           <%= index === 0 ? "checked" : "" %>
                           onchange="updateSelectedAddress('<%= address._id %>')" />
                    <strong><%= address.name %></strong><br>
                    <%= address.phone %><br>
                    <%= address.streetAddress %><br>
                    <%= address.city %>, <%= address.state %> - <%= address.pinCode %>
                  </div>
                  <span class="badge bg-secondary position-absolute top-0 end-0 mt-2 me-2">
                    <%= address.addressType %>
                  </span>
                  <button type="button" 
                          class="btn btn-sm btn-dark position-absolute top-0 end-0 mt-2 me-2 edit-btn" 
                          style="transform:translateY(1.8rem);" 
                          data-bs-toggle="modal"
                          data-bs-target="#editAddressModal-<%=address._id %>">Edit</button>
                </div>
              <% }); %>
            <% } else { %>
              <p>No saved addresses. Please add one.</p>
            <% } %>
          </div>

          <!-- View More + Add New -->
          <div class="d-flex justify-content-between mt-3">
            <button type="button" class="btn btn-outline-primary w-40" data-bs-toggle="modal" data-bs-target="#viewMoreAddressesModal">
              View more Addresses
            </button>
            <button type="button" class="btn btn-outline-primary w-40 me-1" data-bs-toggle="modal" data-bs-target="#addAddressModal">
              + Add New Address
            </button>
          </div>

          <!-- Payment Method Selection -->
          <h5 class="mt-4 mb-3">Select Payment Method:</h5>
          <div class="mb-3">
            <div class="border rounded p-3 mb-2 payment-option" data-target="cod">
              <div class="form-check w-100">
                <input 
                  class="form-check-input" 
                  type="radio" 
                  name="paymentMethod" 
                  id="cod" 
                  value="COD"
                  <%= finalAmount > 1000 ? "disabled" : "" %>
                >

                <label class="form-check-label fw-bold w-100 p-0" for="cod">
                  <i class="bi bi-cash-coin me-2 fs-3 text-primary"></i>
                  Cash on Delivery

                  <% if(finalAmount > 1000){ %>
                    <br>
                    <p class="badge bg-warning mt-1">
                      Order above ₹1000/- COD not accepted!
                    </p>
                  <% } %>
                </label>
              </div>
            </div>

            <div class="border rounded p-3 mb-2 payment-option" data-target="online">
              <div class="form-check w-100">
                <input class="form-check-input" type="radio" name="paymentMethod" id="online" value="Online">
                <label class="form-check-label fw-bold w-100 p-0" for="online">
                  <i class="bi bi-credit-card-fill me-2 fs-3 text-primary"></i>Online Payment
                </label>
              </div>
            </div>
            <div class="border rounded p-3 payment-option" data-target="wallet">
              <div class="form-check w-100">
                <input class="form-check-input" type="radio" name="paymentMethod" id="wallet" value="wallet">
                <label class="form-check-label fw-bold w-100 p-0" for="wallet">
                  <i class="bi bi-wallet2 me-2 fs-3 text-primary"></i>Wallet Payment
                </label>
                <%if(userWallet.balance == undefined){ %>
                  <p class="text-danger">Your Wallet is empty!</p>
                <%} else{ %>
                <p class="text-success fw-semibold">Your wallet balance: <%=userWallet.balance.toFixed(2) %></p>
                <%}%>
              </div>
            </div>            
          </div>

          <!-- Hidden field -->
          <input type="hidden" name="selectedAddressIdHidden" id="selectedAddressIdHidden" value="<%= addresses && addresses.length > 0 ? addresses[0]._id : '' %>">
        </div>
      </div>

      <!-- Order Summary (Left column) -->
      <div class="col-lg-5 order-lg-2">
        <div class="bg-white p-4 rounded shadow-sm">
          <h4 class="mb-4">Order Summary</h4>
          <ul class="list-group mb-3">
            <% for (let i = 0; i < items.length; i++) { %>
              <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
                <div class="d-flex align-items-center">
                  <img src="<%= items[i].image ? items[i].image : '/placeholder.svg?height=80&width=60' %>" alt="<%= items[i].name %>" class="rounded me-2" style="width:60px;height:80px;object-fit:cover">
                  <div>
                    <strong><%= items[i].name %></strong>
                    <div class="text-muted small">Qty: <%= items[i].quantity %></div>
                  </div>
                </div>
                <span>₹ <%= items[i].totalPrice %></span>
              </li>
            <% } %>
            <li class="list-group-item d-flex justify-content-between border-0 px-0">
              <span>Delivery Charge:</span>
              <span class="text-success fw-bold">₹ <%= shippingCharge %></span>
            </li>
          </ul>
          <%if(session.appliedCoupon){ %>

            <button type="button" class="btn btn-danger fw-semibold" onclick="removeCoupon()">Remove Coupon</button>

            <%}else{ %>
          <div class="mb-2">
            <button class="btn btn-primary w-100 fw-bold" type="button" data-bs-toggle="modal" data-bs-target="#couponModal">View Coupons</button>
          </div>

          <!-- Simple Coupon Listing Modal -->
          <div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="couponModalLabel">Available Coupons</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <% if (coupons && coupons.length > 0) { %>
                    <div class="row g-3">
                      <% coupons.forEach(coupon => { %>
                        <div class="col-12 col-md-6 col-lg-4">
                          <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body p-3">
                              <h6 class="card-title fw-bold mb-1"><%= coupon.name %></h6>
                              <div class="mb-2">
                                <span class="badge bg-primary fs-6 fw-semibold">Code: <%= coupon.code %></span>
                              </div>
                              <div class="mb-3">
                                <span class="text-success fw-bold">Discount: <%= coupon.discountValue %>% off</span>
                              </div>
                              <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="copyCouponCode('<%= coupon.code %>', event)" style="cursor: pointer;">
                                <i class="bi bi-clipboard-plus me-1"></i> Copy Code
                              </button>
                            </div>
                          </div>
                        </div>
                      <% }) %>
                    </div>
                  <% } else { %>
                    <div class="text-center py-4">
                      <i class="bi bi-ticket-detailed text-muted" style="font-size: 3rem;"></i>
                      <h5 class="mt-2 text-muted">No Coupons Available</h5>
                      <p class="text-muted">Check back later for exciting offers!</p>
                    </div>
                  <% } %>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <div class="card p-3 shadow-sm">
              <h5 class="fw-bold mb-3">Apply Coupon</h5>

              <div class="input-group">
                <input type="text" id="couponCodeInput" class="form-control" placeholder="Enter coupon code">
                <button type="button" class="btn btn-primary" onclick="applyCoupon()">Apply</button>
              </div>

              <small id="couponMessage" class="text-success fw-semibold"></small>
            </div>
            <input type="hidden" name="finalAmount" id="finalAmountValue" value="<%= session.appliedCoupon ? session.appliedCoupon.discountFinalAmount : finalAmount %>">
          </div>
          <%}%>

          <% if (session.appliedCoupon) { %>
            <p class="mt-2">Total: ₹ <%= finalAmount %>/-</p>
            <p>Coupon Applied: <%= session.appliedCoupon.couponCode %></p>
            <p>Discount: -₹ <%= session.appliedCoupon.discountAmount %>/-</p>
            <h4>Final Total: ₹ <%= session.appliedCoupon.discountFinalAmount %>/-</h4>
          <% } else { %>
            <h4>Total: ₹ <%= finalAmount %></h4>
          <% } %>
          <!-- Submit button -->
          <button class="btn btn-success w-100 fw-bold fs-4" type="submit">Place Order</button>
        </div>
      </div>
    </div>
  </form>

  <!-- View More Addresses Modal -->
  <div class="modal fade" id="viewMoreAddressesModal" tabindex="-1" aria-labelledby="viewMoreAddressesLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewMoreAddressesLabel">All Addresses</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <% if(allAddresses && allAddresses.length > 0) { %>
            <% allAddresses.forEach(address => { %>
              <div class="border p-3 mb-2 rounded">
                <strong><%= address.name %></strong><br>
                <%= address.phone %><br>
                <%= address.streetAddress %><br>
                <%= address.city %>, <%= address.state %> - <%= address.pinCode %><br>
                <span class="badge bg-secondary"><%= address.addressType %></span>
                <button type="button" class="btn btn-primary btn-sm float-end ms-2"
                        onclick="selectAddressFromModal('<%= address._id %>', '<%= escape(address.name) %>',
                         '<%= address.phone %>', 
                         '<%= escape(address.streetAddress) %>', 
                         '<%= escape(address.city) %>', '<%= escape(address.state) %>', 
                         '<%= address.pinCode %>', '<%= address.addressType %>')">
                  Select this address
                </button>
              </div>
            <% }); %>
          <% } else { %>
            <p>No addresses found.</p>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Address Modals (one per address) -->
  <%-include("../../views/partials/user/editAddressModal") %>

  <!-- Add Address Modal -->
  <%-include("../../views/partials/user/addAddressModal") %>
</div>

<%- include("../../views/partials/user/footer") %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
/* -------------------------
  Utilities & PIN validation
----------------------------*/
async function fetchPincodeInfo(pin) {
  // returns null on failure, or the first PostOffice object on success
  try {
    const resp = await fetch(`https://api.postalpincode.in/pincode/${pin}`);
    const arr = await resp.json();
    const root = arr && arr[0];
    if (!root || root.Status !== 'Success' || !root.PostOffice || root.PostOffice.length === 0) return null;
    return root.PostOffice[0];
  } catch (err) {
    console.error('postal API error', err);
    return null;
  }
}

// validate and autofill for a specific form (scoped)
async function validateAndAutofill(pinInput) {
  const pin = String(pinInput.value || '').trim();
  if (!/^[1-9][0-9]{5}$/.test(pin)) {
    pinInput.classList.remove('is-valid');
    pinInput.classList.add('is-invalid');
    return false;
  }
  pinInput.classList.remove('is-invalid');
  pinInput.classList.add('is-valid');
  pinInput.style.cursor = 'wait';
  const postOffice = await fetchPincodeInfo(pin);
  pinInput.style.cursor = 'default';
  const form = pinInput.closest('form');
  const cityInput = form?.querySelector('input[name="city"]');
  const stateInput = form?.querySelector('input[name="state"]');

  if (!postOffice) {
    // clear or keep? we clear to avoid wrong values
    if (cityInput) cityInput.value = '';
    if (stateInput) stateInput.value = '';
    Swal.fire({ icon: 'error', title: 'Invalid Pincode', text: 'Pincode not found in India Post records.' });
    pinInput.classList.remove('is-valid');
    pinInput.classList.add('is-invalid');
    return false;
  }

  if (cityInput) cityInput.value = (postOffice.District || '').trim();
  if (stateInput) stateInput.value = (postOffice.State || '').trim();
  pinInput.classList.remove('is-invalid');
  pinInput.classList.add('is-valid');
  return true;
}

// live pincode validation: works for add & edit forms (delegated)
document.addEventListener('input', function(e) {
  const el = e.target;
  if (!el) return;
  // keep digits only
  if (el.name === 'pinCode') {
    el.value = el.value.replace(/[^0-9]/g, '').slice(0, 6);
    if (el.value.length === 6) {
      // call but don't block typing (fire + forget)
      validateAndAutofill(el);
    }
  }
});

// Add Address (delegated submit)
document.addEventListener('submit', async function(e) {
  const form = e.target;
  // Add address
  if (form && form.id === 'addAddressForm') {
    e.preventDefault();
    const pinInput = form.querySelector('input[name="pinCode"]');
    const isPinValid = await validateAndAutofill(pinInput);
    if (!isPinValid) return;

    // gather data
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
      const res = await fetch(form.action || '/profile/address/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await res.json();

      if (!result.success) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: result.message
          });
          return;
        }

      // Build new address card HTML and insert
      const newCard = document.createElement('div');
      newCard.className = 'address-card border rounded p-3 mb-3 position-relative';
      newCard.style.borderWidth = '2px'; newCard.style.borderColor = '#edc2ba'; newCard.style.borderStyle = 'solid';
      newCard.setAttribute('data-address-id', result.addressId);
      newCard.innerHTML = `
        <div>
          <input type="radio" name="selectedAddressId" value="${result.addressId}" checked onchange="updateSelectedAddress('${result.addressId}')"/>
          <strong>${escapeHtml(data.name)}</strong><br>
          ${escapeHtml(data.phone)}<br>
          ${escapeHtml(data.streetAddress)}<br>
          ${escapeHtml(data.city)}, ${escapeHtml(data.state)} - ${escapeHtml(data.pinCode)}
        </div>
        <span class="badge bg-secondary position-absolute top-0 end-0 mt-2 me-2">${escapeHtml(data.addressType)}</span>
        <button type="button" class="btn btn-sm btn-dark position-absolute top-0 end-0 mt-2 me-2 edit-btn" style="transform:translateY(1.8rem);" data-bs-toggle="modal" data-bs-target="#editAddressModal-${result.addressId}">Edit</button>
      `;

      // Prepend
      const addressList = document.getElementById('addressList');
      if (addressList) addressList.prepend(newCard);

      // update hidden selection
      document.getElementById('selectedAddressIdHidden').value = result.addressId;

      // close modal
      const modalEl = document.getElementById('addAddressModal');
      const modal = bootstrap.Modal.getInstance(modalEl);
      if (modal) modal.hide();

      Swal.fire({ icon: 'success', title: 'Address added', timer: 1500, showConfirmButton: false });

      form.reset();
      form.querySelectorAll('.is-valid').forEach(i => i.classList.remove('is-valid'));

    } catch (err) {
      console.error('Add address error', err);
      Swal.fire({ icon: 'error', title: 'Error', text: 'Server error' });
    }
  }

  // Edit address forms: id format editAddressForm-<id>
  if (form && form.id && form.id.startsWith('editAddressForm-')) {
    e.preventDefault();
    const addressId = form.getAttribute('data-address-id') || form.id.replace('editAddressForm-', '');
    const pinInput = form.querySelector('input[name="pinCode"]');
    const isPinValid = await validateAndAutofill(pinInput);
    if (!isPinValid) return;

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
      const res = await fetch(`/profile/address/edit/${addressId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await res.json();
      if (!result || !result.success) {
        Swal.fire({ icon: 'error', title: 'Failed', text: (result && result.message) || 'Could not update address' });
        return;
      }

      // Update existing card DOM if present
      const card = document.querySelector(`.address-card[data-address-id="${addressId}"]`);
      if (card) {
        // preserve checked state
        const wasChecked = card.querySelector('input[name="selectedAddressId"]')?.checked;
        card.innerHTML = `
          <div>
            <input type="radio" name="selectedAddressId" value="${addressId}" ${wasChecked ? 'checked' : ''} onchange="updateSelectedAddress('${addressId}')"/>
            <strong>${escapeHtml(data.name)}</strong><br>
            ${escapeHtml(data.phone)}<br>
            ${escapeHtml(data.streetAddress)}<br>
            ${escapeHtml(data.city)}, ${escapeHtml(data.state)} - ${escapeHtml(data.pinCode)}
          </div>
          <span class="badge bg-secondary position-absolute top-0 end-0 mt-2 me-2">${escapeHtml(data.addressType)}</span>
          <button type="button" class="btn btn-sm btn-dark position-absolute top-0 end-0 mt-2 me-2 edit-btn" style="transform:translateY(1.8rem);" data-bs-toggle="modal" data-bs-target="#editAddressModal-${addressId}">Edit</button>
        `;
        if (wasChecked) updateSelectedAddress(addressId);
      }

      // close modal
      const modalEl = document.getElementById(`editAddressModal-${addressId}`);
      const modal = bootstrap.Modal.getInstance(modalEl);
      if (modal) modal.hide();

      Swal.fire({ icon: 'success', title: 'Address updated', timer: 1400, showConfirmButton: false });

    } catch (err) {
      console.error('Edit address error', err);
      Swal.fire({ icon: 'error', title: 'Error', text: 'Server error' });
    }
  }
});

/* selection helpers */
function updateSelectedAddress(addressId) {
  const hidden = document.getElementById('selectedAddressIdHidden');
  if (hidden) hidden.value = addressId;
}

/* Select from view more modal */
function selectAddressFromModal(id, name, phone, street, city, state, pin, type) {
  // set hidden id
  document.getElementById('selectedAddressIdHidden').value = id;

  // find previously selected card's radio and update it
  const previousCheckedRadio = document.querySelector('input[name="selectedAddressId"]:checked');
  if (previousCheckedRadio) previousCheckedRadio.checked = false;

  // If card exists in main list, we select it; else prepend a new card
  let card = document.querySelector(`.address-card[data-address-id="${id}"]`);
  if (!card) {
    const addressList = document.getElementById('addressList');
    const newCard = document.createElement('div');
    newCard.className = 'address-card border rounded p-3 mb-3 position-relative';
    newCard.style.borderWidth = '2px'; newCard.style.borderColor = '#edc2ba'; newCard.style.borderStyle = 'solid';
    newCard.setAttribute('data-address-id', id);
    newCard.innerHTML = `
      <div>
        <input type="radio" name="selectedAddressId" value="${id}" checked onchange="updateSelectedAddress('${id}')"/>
        <strong>${escapeHtml(name)}</strong><br>
        ${escapeHtml(phone)}<br>
        ${escapeHtml(street)}<br>
        ${escapeHtml(city)}, ${escapeHtml(state)} - ${escapeHtml(pin)}
      </div>
      <span class="badge bg-secondary position-absolute top-0 end-0 mt-2 me-2">${escapeHtml(type)}</span>
      <button type="button" class="btn btn-sm btn-dark position-absolute top-0 end-0 mt-2 me-2 edit-btn" style="transform:translateY(1.8rem);">Edit</button>
    `;
    if (addressList) addressList.prepend(newCard);
  } else {
    // mark radio checked
    const radio = card.querySelector('input[name="selectedAddressId"]');
    if (radio) radio.checked = true;
  }

  // close modal
  const modalElement = document.getElementById('viewMoreAddressesModal');
  const modal = bootstrap.Modal.getInstance(modalElement);
  if (modal) modal.hide();
}

/* small helper to escape HTML when injecting user content */
function escapeHtml(unsafe) {
  if (unsafe === undefined || unsafe === null) return '';
  return String(unsafe)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

/* payment option UI (unchanged behavior) */
document.addEventListener('click', function(e) {
  const opt = e.target.closest('.payment-option');
  if (!opt) return;
  const target = opt.dataset.target;
  const input = document.getElementById(target);
  if (input) {
    input.checked = true;
    input.dispatchEvent(new Event('change'));
  }
});

document.addEventListener('change', function(e) {
  if (e.target && e.target.name === 'paymentMethod') {
    document.querySelectorAll('.payment-option').forEach(el => el.classList.remove('selected'));
    const sel = document.querySelector(`[data-target="${e.target.value}"]`);
    if (sel) sel.classList.add('selected');
  }
});

/* Notify query params */
(function showQueryMessages() {
  const urlParams = new URLSearchParams(window.location.search);
  const err = urlParams.get('error');
  const suc = urlParams.get('success');
  if (err) Swal.fire({ icon: 'error', title: 'Oops...', text: decodeURIComponent(err), confirmButtonColor: '#d33' });
  if (suc) Swal.fire({ icon: 'success', title: 'Success!', text: decodeURIComponent(suc), confirmButtonColor: '#3085d6' });
})();

function copyCouponCode(code, event) {
    navigator.clipboard.writeText(code).then(() => {
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="bi bi-check-circle-fill me-1 text-success"></i> Copied!';
      btn.classList.add('btn-success');
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('btn-success');
      }, 2000);
    }).catch(err => {
      console.error('Failed to copy: ', err);
      Swal.fire("Failed ", data.message, "error");
    });
  }

  function applyCoupon() {
  const code = document.getElementById("couponCodeInput").value.trim();
  const finalAmount = document.getElementById("finalAmountValue").value;

  if (!code) return Swal.fire("Error", "Please enter a coupon code", "error");

  fetch("/applyCoupon", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ code, finalAmount })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      Swal.fire("Success ", data.message, "success")
      .then(()=>{
        location.reload()
      })
      document.getElementById("couponMessage").innerText = `Applied: ${data.couponCode}`;
      document.getElementById("finalAmount").textContent = data.discountFinalAmount;
      document.getElementById("discountValue").textContent = data.discount;
    } else {
      Swal.fire("Failed ", data.message, "error");
    }
  });
}

async function removeCoupon() {
  const res =  await fetch('/removeCoupon', {method: 'POST'});
  const data = await res.json();
  if(data.success) {
    Swal.fire({
      icon: 'success',
      title: 'Coupon removed',
      text: 'Discount removed!'
    }).then(()=> {
      location.reload();
    })
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const retryMode = urlParams.get("retry");
  const retryOrderDbId = urlParams.get("orderId");
  const retryRzpOrderId = urlParams.get("rzpOrder");

if (retryMode && retryRzpOrderId) {
  openRetryPaymentPopup();
}

  const checkoutForm = document.getElementById("checkoutForm");

  if (checkoutForm) {
    checkoutForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      const method = document.querySelector('input[name="paymentMethod"]:checked');
      const selectedAddressId = document.getElementById("selectedAddressIdHidden").value;

      if (!method) return Swal.fire("Error", "Please select a payment method", "error");

      // COD → normal form submit
      if (method.value === "COD") return this.submit();

      // Wallet Payment
      if(method.value === "wallet") {
        try {
          const res = await fetch("/orders", {
            method: "POST",
            headers: {"Content-Type" : "application/json"},
            body: JSON.stringify({
              selectedAddressId,
              paymentMethod: "Wallet"
            })
          });

          const result = await res.json();

          if(result.success) {
            Swal.fire("Success!", "Wallet Payment Successful", "success");
            setTimeout(()=> {
              window.location.href = `/orderSuccess?orderId=${result.orderId}`
            },1500);
          }else{
            Swal.fire("Error", result.message || "Wallet Payment failed", "error");            
          }
        } catch (error) {
          Swal.fire("Error", "Something went wrong!", "error");
        }
        return;
      }

     // Razorpay setup 
      try {
        // -------------------------------------------
        // 1️⃣ Step 1: Create order in backend
        // -------------------------------------------
        const res = await fetch("/orders", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ selectedAddressId, paymentMethod: "Online" }),
        });

        const order = await res.json();
        if (!order.success) {
            Swal.fire("Error", order.message, "error").then(() => {
            if (order.redirect) window.location.href = order.redirect;
          });
          return;
        }

        // -------------------------------------------
        // 2️⃣ Step 2: Razorpay Payment Window
        // -------------------------------------------
        const options = {
          key: order.key,
          amount: order.amount,
          currency: order.currency,
          name: "Kitab4U",
          description: "Book Purchase",
          order_id: order.orderId,

          handler: async function (response) {
            // -------------------------
            // Success — verify
            // -------------------------
            const verifyRes = await fetch("/verifyPayment", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                razorpay_order_id: response.razorpay_order_id,
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_signature: response.razorpay_signature,
                orderDbId: order.orderDbId,
              }),
            });

            const result = await verifyRes.json();

            if (result.success) {
              Swal.fire("Success!", "Payment Successful", "success");
              setTimeout(() => {
                window.location.href = `/orderSuccess?orderId=${result.orderId}`;
              }, 1500);
            } else {
              // Verification failed → retry option
              window.location.href= `/loadRetryPayment?orderId=${order.orderDbId}`;
            }
          },

          // -------------------------------------------
          // FAILURE HANDLING (user closes / bank error)
          // -------------------------------------------
          modal: {
            ondismiss: function () {
              window.location.href= `/loadRetryPayment?orderId=${order.orderDbId}`
            }
          },

          theme: { color: "#edc2ba" }
        };

        const rzp = new Razorpay(options);

        // Razorpay internal failure event
        rzp.on("payment.failed", function (response) {
          window.location.href= `/loadRetryPayment?orderId=${order.orderDbId}`
        });

        rzp.open();

      } catch (err) {
        console.error("Payment initiation error:", err);
        Swal.fire("Error", err.message || "Unable to initiate payment", "error");
      }
    });
  }
});

async function openRetryPaymentPopup() {
  const orderDbId = retryOrderDbId;

  const options = {
    key: order.key,
    amount: order.amount,
    currency: order.currency,
    name: "Kitab4U",
    description: "Retry Payment",
    order_id: retryRzpOrderId,

    handler: async function (response) {
      const verifyRes = await fetch("/verifyPayment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          razorpay_order_id: response.razorpay_order_id,
          razorpay_payment_id: response.razorpay_payment_id,
          razorpay_signature: response.razorpay_signature,
          orderDbId
        }),
      });

      const result = await verifyRes.json();

      if (result.success) {
        window.location.href= `/orderSuccess?orderId=${result.orderId}`;
      } else {
        window.location.href= `/loadRetryPayment?orderId=${orderDbId}`;
      }
    },

    modal: {
      ondismiss: function () {
        window.location.href = `/loadRetryPayment?orderId=${orderDbId}`;
      }
    }
  };

  const rzp = new Razorpay(options);
  rzp.open();
}


</script>

