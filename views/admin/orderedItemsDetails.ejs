<%- include('../../views/partials/admin/header') %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <div class="col-md-10 p-4" style="background-color: #f8f9fa; min-height: 100vh;">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
    <h3 class="fw-semibold mb-0">Order Details - <%= order.orderId %></h3>
    <a href="/admin/userOrders" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-arrow-left-square fs-6"></i> Back to Orders
    </a>
  </div>

  <div class="row g-4">
    <!-- LEFT COLUMN -->
    <div class="col-lg-8">
      <!-- Order Items -->
      <div class="card shadow-sm border-0 rounded-3">
        <div class="card-header bg-light">
          <h5 class="fw-semibold mb-0">Order Items</h5>
        </div>
        <div class="card-body">
          <% if (order.orderedItems && order.orderedItems.length > 0) { %>
            <% order.orderedItems.forEach(item => { %>
              <div class="row align-items-center py-3 border-bottom">
                <div class="col-md-2 text-center">
                  <img src="<%= item.image || '/images/placeholder-book.jpg' %>" 
                       class="img-fluid rounded shadow-sm"
                       style="width: 80px; height: 120px; object-fit: cover;" 
                       alt="<%= item.name %>">
                </div>
                <div class="col-md-3">
                  <h6 class="fw-semibold mb-1"><%= item.name %></h6>
                </div>
                <div class="col-md-2 text-center fw-semibold">
                  Qty: <%= item.quantity %>
                </div>
                <div class="col-md-2 text-center fw-semibold">
                  â‚¹<%= item.price %>
                </div>

                  <!-- Item-Level Status Update --> 
  <div class="col-md-3 text-center">  
  <form class="d-inline-block">
    <%if(item.itemStatus=='Cancelled'){ %>
      <span class="badge bg-danger mb-3 fs-6"><%= item.itemStatus %></span>
    <%}else if(item.itemStatus=='Returned'){ %>
      <span class="badge bg-secondary mb-3 fs-6"><%= item.itemStatus %></span>
      <%}else{ %>
    <span class="badge bg-primary mb-3 fs-6"><%= item.itemStatus %></span>
    <%}%>    
    <div class="d-flex justify-content-center gap-1">
      <% if(item.itemStatus === 'Return Requested') { %>
      <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#returnModal-<%= item._id %>">Return</button>
      <% } else if(item.itemStatus === 'Cancel Requested') { %>
      <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#cancelModal-<%= item._id %>">Cancel</button>
      <%}%>
    </div>
    
  </form>
</div>
              </div>

             <!-- Cancel Item Modal -->
<div class="modal fade" id="cancelModal-<%= item._id %>" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cancel Requested - <%= item.name %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label for="cancelReason-<%= item._id %>" class="form-label">Reason for cancellation</label>
        <textarea name="reason" id="cancelReason-<%= item._id %>" class="form-control" rows="3" readonly><%= item.cancelReason %></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger item-action-btn" 
                data-order-id="<%= order._id %>" 
                data-item-id="<%= item._id %>" 
                data-action="approve" 
                data-type="cancel"
                data-bs-dismiss="modal">Approve Cancel</button>
        <button type="button" class="btn btn-secondary item-action-btn" 
                data-order-id="<%= order._id %>" 
                data-item-id="<%= item._id %>" 
                data-action="reject" 
                data-type="cancel"
                data-bs-dismiss="modal">Reject Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Return Item Modal -->
<div class="modal fade" id="returnModal-<%= item._id %>" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Return Requested - <%= item.name %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label for="returnReason-<%= item._id %>" class="form-label">Reason for return</label>
        <textarea name="reason" id="returnReason-<%= item._id %>" class="form-control" rows="3" readonly><%= item.returnReason %></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-secondary item-action-btn" 
                data-order-id="<%= order._id %>" 
                data-item-id="<%= item._id %>" 
                data-action="approve" 
                data-type="return"
                data-bs-dismiss="modal">Approve Return</button>
        <button type="button" class="btn btn-danger item-action-btn" 
                data-order-id="<%= order._id %>" 
                data-item-id="<%= item._id %>" 
                data-action="reject" 
                data-type="return"
                data-bs-dismiss="modal">Reject Return</button>
      </div>
    </div>
  </div>
</div>


            <% }) %>
          <% } else { %>
            <p class="text-center text-muted py-4">No items in this order.</p>
          <% } %>
        </div>
      </div>

      <!-- Order-Level Status Update -->
      <div class="card mt-4 shadow-sm border-0 rounded-3">
  <div class="card-header bg-light">
    <h5 class="fw-semibold mb-0">Order-Level Status Update</h5>
  </div>
  <% if(['Cancelled','Returned'].includes(order.status)) { %>
    <span class="badge bg-info mb-3 text-dark"><%= order.status %></span>
    <%}else { %>
  <div class="card-body text-center order-status-form">
    <form class="d-inline-block">
      <select name="status" id="orderStatusSelect-<%= order._id %>" class="form-select form-select-sm mb-2 status-select"
              onchange="this.style.backgroundColor=this.options[this.selectedIndex].dataset.color;" data-id="<%= order._id %>">
        <option value="Pending" data-color="#d1ecf1" <%= order.status === 'Pending' ? 'selected' : '' %>>Pending</option>
        <option value="Placed" data-color="#d1ecf4" <%= order.status === 'Placed' ? 'selected' : '' %>>Placed</option>
        <option value="Packed" data-color="#fff3cd" <%= order.status === 'Packed' ? 'selected' : '' %>>Packed</option>
        <option value="Shipped" data-color="#cce5ff" <%= order.status === 'Shipped' ? 'selected' : '' %>>Shipped</option>
        <option value="Out for Delivery" data-color="#ffeeba" <%= order.status === 'Out for Delivery' ? 'selected' : '' %>>Out for Delivery</option>
        <option value="Delivered" data-color="#d4edda" <%= order.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
      </select>

      <div class="mt-3 d-flex justify-content-center gap-2">
        <% if(order.status === 'Return Requested') { %>
        <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#orderReturnModal">Return</button>
        <%} else if(order.status === 'Cancel Requested') { %>
        <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#orderCancelModal">Cancel</button>
        <%}%>
      </div>

      <button type="button" class="btn btn-primary btn-sm mt-2 update-status-btn" data-id="<%= order._id %>">Update Status</button>
    </form>
  </div>
  <%}%>
</div>
    </div>

    <!-- Order Cancel Modal -->
<div class="modal fade" id="orderCancelModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cancel Requested - Order <%= order.orderId %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label for="orderCancelReason" class="form-label">Reason for cancellation</label>
        <textarea name="reason" id="orderCancelReason" class="form-control" rows="3" readonly><%= order.cancelReason %></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger order-action-btn" 
                data-order-id="<%= order._id %>" 
                data-action="approve" 
                data-type="cancel"
                data-bs-dismiss="modal">Approve Cancel</button>
        <button type="button" class="btn btn-secondary order-action-btn" 
                data-order-id="<%= order._id %>" 
                data-action="reject" 
                data-type="cancel"
                data-bs-dismiss="modal">Reject Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Order Return Modal -->
<div class="modal fade" id="orderReturnModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Return Requested - Order <%= order.orderId %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label for="orderReturnReason" class="form-label">Reason for return</label>
        <textarea name="reason" id="orderReturnReason" class="form-control" rows="3" readonly><%= order.returnReason %></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-secondary order-action-btn" 
                data-order-id="<%= order._id %>" 
                data-action="approve" 
                data-type="return"
                data-bs-dismiss="modal">Approve Return</button>
        <button type="button" class="btn btn-danger order-action-btn" 
                data-order-id="<%= order._id %>" 
                data-action="reject" 
                data-type="return"
                data-bs-dismiss="modal">Reject Return</button>
      </div>
    </div>
  </div>
</div>


    <!-- RIGHT COLUMN -->
    <div class="col-lg-4">
      <div class="card shadow-sm border-0 rounded-3 mb-4">
        <div class="card-header bg-light">
          <h5 class="fw-semibold mb-0">Shipping Details</h5>
        </div>
        <div class="card-body">
          <p class="fw-semibold mb-1"><%= order.shippingAddress.name %></p>
          <p class="mb-1"><%= order.shippingAddress.streetAddress %></p>
          <p class="mb-1"><%= order.shippingAddress.city %>, <%= order.shippingAddress.state %> - <%= order.shippingAddress.pinCode %></p>
          <p class="small text-muted mb-0">ðŸ“ž <%= order.shippingAddress.phone %></p>
        </div>
      </div>

      <div class="card shadow-sm border-0 rounded-3">
        <div class="card-header bg-light">
          <h5 class="fw-semibold mb-0">Price Details</h5>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <span>Items Total (<%= order.orderedItems.length %> items) :</span>
            <span>â‚¹ <%= order.totalPrice %>/-</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Delivery Charges:</span>
            <span class="text-primary">â‚¹ <%= order.shippingCharge %>/-</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Coupon Discount: </span>
            <span class="text-danger">- â‚¹ <%= order.discount %>/-</span>
          </div>
          <!-- <div class="d-flex justify-content-between mb-2">
            <span>Delivery Tip</span>
            <span>â‚¹<%= order.deliveryTip %></span>
          </div> -->
          <hr>
          <div class="d-flex justify-content-between fw-bold">
            <span>Total</span>
            <span>â‚¹ <%= order.finalPayableAmount %>/-</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('../../views/partials/admin/footer') %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // Set initial color for each dropdown on page load
  document.addEventListener('DOMContentLoaded', () => {
    const select = document.getElementById('statusSelect-<%= order.orderedItems._id %>');
    if(select) select.style.backgroundColor = select.options[select.selectedIndex].dataset.color;
  });

  // Set initial color for dropdown on page load
  document.addEventListener('DOMContentLoaded', () => {
    const orderSelect = document.getElementById('orderStatusSelect');
    if(orderSelect) orderSelect.style.backgroundColor = orderSelect.options[orderSelect.selectedIndex].dataset.color;
  });

  //Swal messages with AJAX for Order Level Update
document.addEventListener('DOMContentLoaded', () => {
  const updateButtons = document.querySelectorAll('.update-status-btn');

  updateButtons.forEach(button => {
    button.addEventListener('click', async (e) => {
      const orderId = e.target.dataset.id;
      const statusSelect = document.querySelector(`.status-select[data-id="${orderId}"]`);
      const newStatus = statusSelect.value;

      const confirm = await Swal.fire({
        title: 'Update Order Status ?',
        text: `Are you sure you want to change the status to "${newStatus}"?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, update it!',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#000',
        cancelButtonColor: '#6c757d'
      });

      if (confirm.isConfirmed) {
        try {
          const response = await fetch(`/admin/userOrders/${orderId}/updateStatus`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
          });

          const result = await response.json();

          if (result.success) {
            Swal.fire({
              icon: 'success',
              title: 'Status Updated',
              text: result.message,
              timer: 1500,
              showConfirmButton: false
            });

            // Optional: reload to reflect badge color change
            setTimeout(() => window.location.reload(), 1600);
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Update Failed',
              text: result.message
            });
          }
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'Server Error',
            text: 'Something went wrong. Please try again later.'
          });
        }
      }
    });
  });
});


// Swal messages with AJAX for ITEM LEVEL
document.addEventListener('DOMContentLoaded', () => {
  const itemActionButtons = document.querySelectorAll('.item-action-btn');

  itemActionButtons.forEach(button => {
    button.addEventListener('click', async (e) => {
      const orderId = e.target.dataset.orderId;
      const itemId = e.target.dataset.itemId;
      const action = e.target.dataset.action;
      const type = e.target.dataset.type; // 'cancel' or 'return'

      const actionText = action === 'approve' ? 'approve' : 'reject';
      const typeText = type === 'cancel' ? 'cancellation' : 'return';

      const confirm = await Swal.fire({
        title: `${action === 'approve' ? 'Approve' : 'Reject'} ${typeText}?`,
        text: `Are you sure you want to ${actionText} this ${typeText} request?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: `Yes, ${actionText} it!`,
        cancelButtonText: 'Cancel',
        confirmButtonColor: action === 'approve' ? '#000' : '#dc3545',
        cancelButtonColor: '#6c757d'
      });

      if (confirm.isConfirmed) {
        try {
          const url = `/admin/userOrders/${orderId}/item/${itemId}/${type}`;
          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: action })
          });

          const result = await response.json();

          if (result.success) {
            await Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: result.message,
              timer: 1500,
              showConfirmButton: false
            });
            window.location.reload();
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Failed',
              text: result.message
            });
          }
        } catch (error) {
          console.error('Item action error:', error);
          Swal.fire({
            icon: 'error',
            title: 'Server Error',
            text: 'Something went wrong. Please try again later.'
          });
        }
      }
    });
  });
});

// Swal messages with AJAX for ORDER LEVEL Cancel/Return
document.addEventListener('DOMContentLoaded', () => {
  const orderActionButtons = document.querySelectorAll('.order-action-btn');

  orderActionButtons.forEach(button => {
    button.addEventListener('click', async (e) => {
      const orderId = e.target.dataset.orderId;
      const action = e.target.dataset.action;
      const type = e.target.dataset.type; // 'cancel' or 'return'

      const actionText = action === 'approve' ? 'approve' : 'reject';
      const typeText = type === 'cancel' ? 'cancellation' : 'return';

      const confirm = await Swal.fire({
        title: `${action === 'approve' ? 'Approve' : 'Reject'} order ${typeText}?`,
        text: `Are you sure you want to ${actionText} this order ${typeText} request?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: `Yes, ${actionText} it!`,
        cancelButtonText: 'Cancel',
        confirmButtonColor: action === 'approve' ? '#000' : '#dc3545',
        cancelButtonColor: '#6c757d'
      });

      if (confirm.isConfirmed) {
        try {
          const url = `/admin/userOrders/${orderId}/${type}`;
          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: action })
          });

          const result = await response.json();

          if (result.success) {
            await Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: result.message,
              timer: 1500,
              showConfirmButton: false
            });
            window.location.reload();
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Failed',
              text: result.message
            });
          }
        } catch (error) {
          console.error('Order action error:', error);
          Swal.fire({
            icon: 'error',
            title: 'Server Error',
            text: 'Something went wrong. Please try again later.'
          });
        }
      }
    });
  });
});

</script>