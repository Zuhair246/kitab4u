<%- include('../../views/partials/user/header') %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<div class="container my-5">
  <h2 class="text-center mb-4">MY ORDERS</h2>
  <% orders.forEach(order => { %>
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <% let item = order.items[0] %>
          <div class="row align-items-center mb-3">
            <div class="col-auto">
              <img src="<%= item.image %>" alt="<%= item.name %>" style="width:80px;height:100px;object-fit:cover;" class="rounded">
            </div>
            <div class="col">
              <strong><%= item.name %></strong><br>
              <span class="text-muted"><%= item.author %></span><br>
              <span class="badge bg-dark mb-2"><%= item.coverType %></span>
              <% if(order.items.length > 1) { %>
                <p class="text-muted mt-1">+ <%= order.items.length -1 %> more item(s)</p>
              <% } %>   
            </div>
            <div class="col-auto text-end fs-5 fw-semibold">
              â‚¹ <%= order.finalAmount %>/-
            </div>
          </div>
        <!-- Progress bar (order status) -->
<div class="d-flex align-items-center mb-2">
  <% let stages = ['Order Placed','Packed','Shipped','Out for Delivery','Delivered']; %>
  <% stages.forEach((stage, i) => { %>
    <div class="text-center position-relative flex-shrink-0 px-2">
      <i class="bi bi-stop-circle-fill <%= i <= order.statusIndex ? 'text-success' : 'text-secondary' %> fs-5"></i><br>
      <span class="small" style="color:<%= i <= order.statusIndex ? '#388e3c' : '#bdbdbd' %>"><%= stage %></span>
    </div>
    <% if (i < stages.length - 1) { %>
      <div class="flex-fill position-relative mx-1">
        <div class="position-absolute top-50 start-0 end-0 d-flex justify-content-center" style="transform: translateY(-50%);">
          <div class="w-100 <%= i < order.statusIndex ? 'bg-success' : 'bg-secondary' %> rounded" style="height: 2px;"></div>
        </div>
      </div>
    <% } %>
  <% }) %>
</div>
        <!-- Actions & Details -->
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <% if(order.canCancel) { %>
              <button class="btn btn-danger btn-sm">Cancel Order</button>
            <% } %>
            <% if(order.canReturn) { %>
              <button class="btn btn-dark btn-sm">Return</button>
            <% } %>
          </div>
          <a href="/myOrders/<%= order._id %>" class="btn btn-primary btn-sm">Order Details</a>
          <div class="fw-semibold">
            Delivery Expected By <%= order.expectedDeliveryDateFormatted %>
          </div>
        </div>
      </div>
    </div>
  <% }) %>
</div>
<%- include('../../views/partials/user/footer') %>
